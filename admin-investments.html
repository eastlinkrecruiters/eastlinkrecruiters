<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Investment Command | EastLink Admin</title>
    
    <!-- PWA & Meta -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/svg+xml" href="./assets/images/favicon.svg">
    <meta name="theme-color" content="#0F172A">
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            /* Shared Theme Variables */
            --bg-body: #0F172A;       
            --bg-glass: rgba(30, 41, 59, 0.70); 
            --bg-glass-heavy: rgba(15, 23, 42, 0.95);
            --bg-input: rgba(255, 255, 255, 0.05);
            --border-color: rgba(255, 255, 255, 0.12);
            --text-main: #F8FAFC;     
            --text-muted: #94A3B8; 
            
            --gold-base: #D97706;
            --gold-gradient: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            
            --success: #10B981;
            --danger: #EF4444;
            --blue: #3B82F6;
            
            --tier-starter: #34d399; /* Emerald */
            --tier-pro: #60a5fa;     /* Blue */
            --tier-elite: #f59e0b;   /* Amber */

            --sidebar-width: 260px; 
            --header-height: 80px;
            --radius: 20px;
            
            --font-head: 'Cinzel', serif;
            --font-body: 'Inter', sans-serif;
            --font-display: 'Space Grotesk', sans-serif;
            --font-mono: 'Space Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: var(--font-body); 
            background-color: var(--bg-body); 
            background-image: url('./assets/images/background.png');
            background-attachment: fixed;
            background-size: cover;
            background-position: center;
            color: var(--text-main); 
            min-height: 100vh; 
            overflow-x: hidden;
            display: flex; flex-direction: column;
        }

        body::before {
            content: ''; position: fixed; inset: 0;
            background: rgba(15, 23, 42, 0.90); 
            z-index: -5; pointer-events: none;
        }

        /* --- HEADER & SIDEBAR --- */
        header {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height);
            background: var(--bg-glass-heavy); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; padding: 0 24px; z-index: 1000;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo { font-family: var(--font-head); font-weight: 700; color: var(--text-main); font-size: 1.4rem; text-decoration: none; display: flex; align-items: center; letter-spacing: 1px; }
        .logo span { background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .admin-badge { 
            font-family: var(--font-body); font-size: 0.65rem; background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color); padding: 2px 8px; border-radius: 4px; 
            margin-left: 8px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;
        }
        .hamburger { font-size: 1.4rem; cursor: pointer; color: var(--text-muted); display: none; }

        .header-actions { display: flex; align-items: center; gap: 15px; }
        .icon-btn { width: 44px; height: 44px; display: grid; place-items: center; border-radius: 12px; color: var(--text-muted); cursor: pointer; transition: 0.3s; background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); }
        .icon-btn:hover { background: rgba(255,255,255,0.08); color: var(--text-main); }
        .profile-widget { width: 44px; height: 44px; cursor: pointer; margin-left: 5px; }
        .user-avatar { width: 100%; height: 100%; border-radius: 12px; background: var(--gold-gradient); display: grid; place-items: center; font-weight: 700; color: #000; font-size: 1.1rem; border: 1px solid rgba(255,255,255,0.2); }

        /* Sidebar */
        .sidebar { position: fixed; top: var(--header-height); left: 0; width: var(--sidebar-width); height: calc(100vh - var(--header-height)); background: var(--bg-glass-heavy); border-right: 1px solid var(--border-color); padding: 30px 0; overflow-y: auto; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 999; display: flex; flex-direction: column; backdrop-filter: blur(20px); }
        .nav-group { padding: 0 24px; margin-bottom: 25px; }
        .nav-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; margin-bottom: 12px; letter-spacing: 1.2px; padding-left: 10px; }
        .nav-item { display: flex; align-items: center; padding: 12px 16px; color: var(--text-muted); text-decoration: none; font-size: 0.95rem; border-radius: 12px; margin-bottom: 5px; cursor: pointer; transition: 0.2s; font-weight: 500; }
        .nav-item:hover { color: var(--text-main); background: rgba(255,255,255,0.05); transform: translateX(5px); }
        .nav-item.active { background: var(--gold-gradient); color: #000; font-weight: 700; box-shadow: 0 4px 15px rgba(217, 119, 6, 0.3); }
        .nav-item i { width: 25px; text-align: center; margin-right: 12px; font-size: 1rem; }
        .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index:998; display:none; }

        /* --- CONTENT AREA --- */
        main { margin-left: var(--sidebar-width); margin-top: var(--header-height); padding: 40px; width: calc(100% - var(--sidebar-width)); min-height: 100vh; display: flex; flex-direction: column; gap: 30px; }

        .page-header { display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 15px; }
        .page-title h1 { font-family: var(--font-head); font-size: 2rem; margin-bottom: 5px; color: var(--text-main); }
        .page-title p { color: var(--text-muted); font-size: 0.9rem; }

        .btn-master-report {
            padding: 10px 20px; border-radius: 12px; font-size: 0.85rem; font-weight: 700; 
            cursor: pointer; background: transparent; color: var(--gold-base); border: 1px solid var(--gold-base);
            transition: all 0.3s ease; display: flex; align-items: center; gap: 10px; text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-master-report:hover { background: rgba(217, 119, 6, 0.1); box-shadow: 0 0 15px rgba(217, 119, 6, 0.2); }

        /* Stats Strip */
        .stats-strip { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        .mini-stat {
            background: rgba(255,255,255,0.02); border: 1px solid var(--border-color); padding: 25px; border-radius: 20px;
            display: flex; flex-direction: column; justify-content: space-between; transition: 0.3s;
        }
        .mini-stat:hover { background: rgba(255,255,255,0.05); transform: translateY(-3px); border-color: rgba(255,255,255,0.2); }
        .stat-icon { width: 45px; height: 45px; border-radius: 12px; display: grid; place-items: center; font-size: 1.2rem; margin-bottom: 15px; }
        .stat-head { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .stat-num { font-size: 1.6rem; font-weight: 700; color: var(--text-main); margin-top: 5px; font-family: var(--font-display); }

        /* Filter Bar */
        .filter-bar { display: grid; grid-template-columns: 2fr repeat(2, 1fr); gap: 15px; background: var(--bg-glass); padding: 20px; border-radius: 20px; border: 1px solid var(--border-color); align-items: center; backdrop-filter: blur(10px); }
        .search-box { position: relative; width: 100%; }
        .search-box input, select { width: 100%; padding: 12px 15px 12px 40px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-main); font-family: var(--font-body); font-size: 0.9rem; transition: 0.2s; }
        .search-box input:focus, select:focus { border-color: var(--gold-base); background: rgba(0,0,0,0.3); }
        .search-box input { padding-left: 45px; }
        .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.9rem; }
        select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394A3B8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 15px center; background-size: 16px; padding-left: 15px; }

        /* Table */
        .table-container { background: var(--bg-glass); border-radius: 20px; border: 1px solid var(--border-color); overflow-x: auto; backdrop-filter: blur(15px); }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { text-align: left; padding: 20px 25px; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; font-weight: 700; border-bottom: 1px solid var(--border-color); background: rgba(0,0,0,0.2); letter-spacing: 1px; }
        td { padding: 20px 25px; border-bottom: 1px solid rgba(255,255,255,0.03); color: var(--text-main); font-size: 0.9rem; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(255,255,255,0.02); }

        .user-cell { display: flex; flex-direction: column; }
        .user-email { font-size: 0.8rem; color: var(--text-muted); margin-top: 3px; }
        .amt-cell { font-family: var(--font-mono); font-weight: 600; color: #fff; }
        .profit-cell { font-family: var(--font-mono); color: var(--success); font-weight: 700; }

        /* Status Badges */
        .status-badge { padding: 6px 12px; border-radius: 8px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; border: 1px solid transparent; display: inline-flex; align-items: center; gap: 6px; }
        .status-active { background: rgba(16, 185, 129, 0.1); color: var(--success); border-color: rgba(16, 185, 129, 0.2); }
        .status-active::before { content:''; width:6px; height:6px; background:var(--success); border-radius:50%; box-shadow:0 0 5px var(--success); }
        
        .status-matured { background: rgba(245, 158, 11, 0.1); color: var(--tier-elite); border-color: rgba(245, 158, 11, 0.2); }
        .status-matured::before { content:''; width:6px; height:6px; background:var(--tier-elite); border-radius:50%; box-shadow:0 0 5px var(--tier-elite); }

        .status-paid { background: rgba(59, 130, 246, 0.15); color: var(--blue); border-color: rgba(59, 130, 246, 0.3); }
        .status-cancelled { background: rgba(239, 68, 68, 0.1); color: var(--danger); border-color: rgba(239, 68, 68, 0.2); }

        .action-btn { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); width: 36px; height: 36px; border-radius: 10px; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .action-btn:hover { border-color: var(--gold-base); color: var(--gold-base); background: rgba(217, 119, 6, 0.1); }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(12px);
            z-index: 2000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal-content {
            background: #1E293B; width: 95%; max-width: 550px; border-radius: 24px; border: 1px solid var(--border-color); 
            overflow: hidden; box-shadow: 0 50px 100px -20px rgba(0, 0, 0, 0.8); transform: scale(0.95); transition: transform 0.3s;
            display: flex; flex-direction: column;
        }
        .modal-overlay.open .modal-content { transform: scale(1); }
        
        .modal-header { padding: 25px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 30px; }

        .detail-row { display: flex; justify-content: space-between; margin-bottom: 16px; border-bottom: 1px solid rgba(255,255,255,0.03); padding-bottom: 10px; }
        .detail-lbl { color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
        .detail-val { font-family: var(--font-mono); color: #fff; font-size: 0.95rem; text-align: right; font-weight: 500; }

        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 30px; }
        .modal-btn { padding: 14px; border-radius: 12px; font-weight: 700; cursor: pointer; border: none; font-size: 0.9rem; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .btn-pay { background: var(--success); color: #000; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
        .btn-pay:hover { background: #059669; color:#fff; }
        
        .btn-cancel { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }
        .btn-cancel:hover { background: rgba(239, 68, 68, 0.2); }
        
        .btn-disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        .loading-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 992px) {
            .sidebar { transform: translateX(-100%); } .sidebar.active { transform: translateX(0); }
            main { margin-left: 0; padding: 25px 15px; width: 100%; margin-top: var(--header-height); }
            .filter-bar { grid-template-columns: 1fr; gap: 10px; }
            .hamburger { display: block; }
            .table-container { overflow-x: auto; }
            .stats-strip { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header>
        <div class="header-left">
            <i class="fas fa-bars hamburger" onclick="toggleSidebar()"></i>
            <a href="admin-dashboard.html" class="logo">
                EAST<span>LINK</span> <span class="admin-badge">ADMIN</span>
            </a>
        </div>
        <div class="header-actions">
            <div class="icon-btn" onclick="location.href='admin-support.html'"><i class="fa-solid fa-envelope"></i></div>
            <div class="icon-btn" onclick="location.href='admin-notifications.html'"><i class="fa-solid fa-bell"></i></div>
            <div class="profile-widget" onclick="location.href='admin-settings.html'">
                <div class="user-avatar"><i class="fa-solid fa-user-shield"></i></div>
            </div>
        </div>
    </header>

    <!-- SIDEBAR -->
    <nav class="sidebar" id="sidebar">
        <div class="nav-group">
            <div class="nav-label">Analytics</div>
            <a href="admin-dashboard.html" class="nav-item"><i class="fa-solid fa-chart-pie"></i> Dashboard</a>
        </div>
        
        <div class="nav-group">
            <div class="nav-label">User Management</div>
            <a href="admin-users.html" class="nav-item"><i class="fa-solid fa-users"></i> Manage Users</a>
            <a href="admin-plans.html" class="nav-item"><i class="fa-solid fa-tags"></i> Manage Plans</a>
            <a href="admin-referrals.html" class="nav-item"><i class="fa-solid fa-share-nodes"></i> Referrals</a>
        </div>

        <div class="nav-group">
            <div class="nav-label">Jobs & Service</div>
            <a href="admin-jobs-mod.html" class="nav-item"><i class="fa-solid fa-briefcase"></i> Job Approvals</a>
            <a href="admin-candidates-apps.html" class="nav-item"><i class="fa-solid fa-file-signature"></i> Applications</a>
            <a href="admin-guaranteed-jobs.html" class="nav-item"><i class="fa-solid fa-certificate"></i> Guaranteed Jobs</a>
        </div>

        <div class="nav-group">
            <div class="nav-label">Finance</div>
            <!-- Active Page -->
            <a href="admin-investments.html" class="nav-item active"><i class="fas fa-chart-line"></i> Investments</a>
            <a href="admin-deposits.html" class="nav-item"><i class="fa-solid fa-arrow-down"></i> Deposits</a>
            <a href="admin-withdrawals.html" class="nav-item"><i class="fa-solid fa-arrow-up"></i> Withdrawals</a>
        </div>

        <div class="nav-group">
            <div class="nav-label">System</div>
            <a href="#" onclick="logout()" class="nav-item" style="color:var(--danger); margin-top:20px;"><i class="fa-solid fa-right-from-bracket"></i> Sign Out</a>
        </div>
    </nav>
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <!-- MAIN CONTENT -->
    <main>
        <div class="page-header animate__animated animate__fadeIn">
            <div class="page-title">
                <h1>Investment Command</h1>
                <p>Monitor global portfolios, process ROI payouts, and manage capital.</p>
            </div>
            <button class="btn-master-report" onclick="exportReport()">
                <i class="fas fa-file-pdf"></i> Master Report
            </button>
        </div>

        <!-- Stats -->
        <div class="stats-strip animate__animated animate__fadeInUp">
            <div class="mini-stat">
                <div class="stat-icon" style="background:rgba(59, 130, 246, 0.1); color:var(--blue);"><i class="fas fa-coins"></i></div>
                <div>
                    <div class="stat-head">Total Capital Invested</div>
                    <div class="stat-num" id="stat-total-cap">KES 0</div>
                </div>
            </div>
            <div class="mini-stat">
                <div class="stat-icon" style="background:rgba(217, 119, 6, 0.1); color:var(--tier-elite);"><i class="fas fa-chart-pie"></i></div>
                <div>
                    <div class="stat-head">Active Portfolios</div>
                    <div class="stat-num" id="stat-active-count">0</div>
                </div>
            </div>
            <div class="mini-stat">
                <div class="stat-icon" style="background:rgba(16, 185, 129, 0.1); color:var(--success);"><i class="fas fa-hand-holding-dollar"></i></div>
                <div>
                    <div class="stat-head">Pending Returns (ROI)</div>
                    <div class="stat-num" id="stat-proj-payout">KES 0</div>
                </div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar animate__animated animate__fadeInUp">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search investor email, name or Plan ID..." onkeyup="debounceFilter()">
            </div>
            <select id="filterStatus" onchange="filterData()">
                <option value="all">Status: All</option>
                <option value="active">Active</option>
                <option value="matured">Matured (Unpaid)</option>
                <option value="paid_out">Paid Out / Redeemed</option>
                <option value="cancelled">Cancelled</option>
            </select>
            <div style="color:var(--text-muted); font-size:0.8rem; text-align:right;">
                <span id="recordCount" style="color:#fff; font-weight:700;">0</span> Records
            </div>
        </div>

        <!-- Table -->
        <div class="table-container animate__animated animate__fadeIn">
            <table>
                <thead>
                    <tr>
                        <th>Investor</th>
                        <th>Plan & ID</th>
                        <th>Dates</th>
                        <th>Capital</th>
                        <th>ROI Payout</th>
                        <th>Status</th>
                        <th>Manage</th>
                    </tr>
                </thead>
                <tbody id="invTableBody">
                    <tr>
                        <td colspan="7" style="text-align:center; padding:40px; color:var(--text-muted);">
                            <span class="loading-spinner" style="width:20px; height:20px; margin-right:10px;"></span> Connecting to Investment Data...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- ACTION MODAL -->
    <div class="modal-overlay" id="actionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="font-family:var(--font-head); font-size:1.2rem; color:var(--text-main);">Manage Portfolio</h3>
                <i class="fas fa-times" onclick="closeModal()" style="cursor:pointer; color:var(--text-muted); font-size:1.2rem;"></i>
            </div>
            
            <div class="modal-body">
                <div id="modalDetails">
                    <!-- Details injected here -->
                </div>

                <div class="action-grid">
                    <button id="btnPayout" class="modal-btn btn-pay">
                        <i class="fas fa-check-circle"></i> Force Payout
                    </button>
                    <button id="btnCancel" class="modal-btn btn-cancel">
                        <i class="fas fa-ban"></i> Refund Principal
                    </button>
                </div>
                
                <p style="font-size:0.75rem; color:var(--text-muted); margin-top:20px; text-align:center; border-top:1px solid var(--border-color); padding-top:15px; line-height:1.5;">
                    <i class="fas fa-info-circle"></i> <strong>Admin Override:</strong> Payout adds Capital + Profit to user wallet. Refund returns Capital only. Actions are irreversible.
                </p>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script type="module">
        import { auth, db } from './config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { collection, getDocs, doc, getDoc, updateDoc, runTransaction, serverTimestamp, query, orderBy, where, documentId } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        // --- UI UTILS ---
        window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').style.display = document.getElementById('sidebar').classList.contains('active') ? 'block' : 'none'; };
        window.logout = () => { if(confirm("Log out?")) signOut(auth).then(() => location.href='signin.html'); };
        window.closeModal = () => document.getElementById('actionModal').classList.remove('open');
        
        window.handleActionWithSpinner = (btn, action) => {
            if(btn.dataset.processing === "true") return;
            btn.dataset.processing = "true";
            const original = btn.innerHTML;
            btn.innerHTML = `<span class="loading-spinner"></span>`;
            setTimeout(async () => {
                await action();
                btn.innerHTML = original;
                btn.dataset.processing = "false";
            }, 300);
        };

        let allInvestments = [];
        let filteredData = [];
        let currentInvId = null;

        // --- AUTH & LOAD ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) return window.location.href = 'signin.html';
            
            // Check Admin Role
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if(!userDoc.exists() || !['admin','owner'].includes(userDoc.data().role)) {
                 document.body.innerHTML = "<h2 style='color:white;text-align:center;padding:50px;'>Access Denied.</h2>";
                 return;
            }
            loadData();
        });

        async function loadData() {
            try {
                // 1. Fetch Investments (Ordered by date)
                const invQ = query(collection(db, "investments"), orderBy("startDate", "desc"));
                const snap = await getDocs(invQ);
                
                if (snap.empty) {
                     document.getElementById('invTableBody').innerHTML = `<tr><td colspan="7" style="text-align:center; padding:40px; color:var(--text-muted);">No investment records found in database.</td></tr>`;
                     updateStats();
                     return;
                }

                // 2. Collect Unique User IDs to batch fetch profiles
                const userIds = new Set();
                snap.forEach(d => {
                    const data = d.data();
                    if(data.userId) userIds.add(data.userId);
                });
                
                // 3. Fetch User Emails (Batch Logic for Firestore limit of 10 'in' queries)
                const userMap = {};
                const uniqueIds = Array.from(userIds);
                const chunkSize = 10;
                
                for (let i = 0; i < uniqueIds.length; i += chunkSize) {
                    const chunk = uniqueIds.slice(i, i + chunkSize);
                    if(chunk.length === 0) continue;
                    const q = query(collection(db, "users"), where(documentId(), 'in', chunk));
                    const userSnaps = await getDocs(q);
                    userSnaps.forEach(u => {
                        const ud = u.data();
                        userMap[u.id] = { email: ud.email || 'No Email', name: ud.fullName || "Unknown User" };
                    });
                }

                // 4. Merge Data
                allInvestments = snap.docs.map(d => {
                    const data = d.data();
                    const userInfo = userMap[data.userId] || { email: 'Deleted User', name: 'N/A' };
                    
                    // Calculate expected return if not explicitly stored (Legacy support)
                    const principal = data.amount || 0;
                    const rate = data.rate || 0;
                    const profit = principal * rate;
                    const totalReturn = principal + profit;

                    return {
                        id: d.id,
                        ...data,
                        userInfo: userInfo,
                        calculatedProfit: profit,
                        calculatedTotal: totalReturn
                    };
                });

                updateStats();
                filteredData = [...allInvestments];
                renderTable();

            } catch (error) {
                console.error("Error loading data:", error);
                document.getElementById('invTableBody').innerHTML = `
                    <tr><td colspan="7" style="text-align:center; color:var(--danger); padding:30px;">
                        <strong>Error Loading Data:</strong><br>${error.message}
                    </td></tr>`;
            }
        }

        function updateStats() {
            // Stats Logic
            const totalCap = allInvestments.reduce((sum, i) => sum + (['active','redeemed','paid_out'].includes(i.status) ? parseFloat(i.amount) : 0), 0);
            const active = allInvestments.filter(i => i.status === 'active').length;
            
            // Only count ROI for Active investments
            const payout = allInvestments
                .filter(i => i.status === 'active')
                .reduce((sum, i) => sum + parseFloat(i.calculatedProfit), 0);

            document.getElementById('stat-total-cap').innerText = `KES ${totalCap.toLocaleString()}`;
            document.getElementById('stat-active-count').innerText = active;
            document.getElementById('stat-proj-payout').innerText = `KES ${payout.toLocaleString()}`;
        }

        // --- FILTERING ---
        let debounceTimer;
        window.debounceFilter = () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(window.filterData, 300); };

        window.filterData = () => {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;

            filteredData = allInvestments.filter(inv => {
                const matchesSearch = 
                    inv.userInfo.email.toLowerCase().includes(term) || 
                    inv.userInfo.name.toLowerCase().includes(term) ||
                    inv.id.toLowerCase().includes(term) ||
                    (inv.planName && inv.planName.toLowerCase().includes(term));
                
                let matchesStatus = true;
                const now = Date.now();
                const matDate = inv.maturityDate ? (inv.maturityDate.seconds * 1000) : 0;

                if(status === 'active') matchesStatus = inv.status === 'active' && now <= matDate;
                if(status === 'matured') matchesStatus = inv.status === 'active' && now > matDate;
                if(status === 'paid_out') matchesStatus = ['redeemed','paid_out'].includes(inv.status);
                if(status === 'cancelled') matchesStatus = inv.status === 'cancelled';
                
                return matchesSearch && matchesStatus;
            });

            renderTable();
        };

        function renderTable() {
            const tbody = document.getElementById('invTableBody');
            document.getElementById('recordCount').innerText = filteredData.length;
            tbody.innerHTML = '';

            if(filteredData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:40px; color:var(--text-muted);">No records found matching filters.</td></tr>`;
                return;
            }

            filteredData.forEach(inv => {
                const date = inv.startDate ? new Date(inv.startDate.seconds*1000).toLocaleDateString() : '-';
                const matDate = inv.maturityDate ? new Date(inv.maturityDate.seconds*1000).toLocaleDateString() : '-';
                
                let statusClass = 'status-active';
                let statusText = 'ACTIVE';

                if(['redeemed','paid_out'].includes(inv.status)) { 
                    statusClass = 'status-paid'; statusText = 'REDEEMED'; 
                }
                else if(inv.status === 'cancelled') { 
                    statusClass = 'status-cancelled'; statusText = 'CANCELLED'; 
                }
                else if(new Date() > new Date(inv.maturityDate.seconds*1000)) { 
                    statusClass = 'status-matured'; statusText = 'MATURED (DUE)'; 
                }

                // Row Color for Plan
                let planColor = '#fff';
                if(inv.planName.includes('Day')) planColor = 'var(--tier-starter)';
                if(inv.planName.includes('Swing')) planColor = 'var(--tier-pro)';
                if(inv.planName.includes('Macro')) planColor = 'var(--tier-elite)';

                const row = `
                    <tr class="animate__animated animate__fadeIn">
                        <td>
                            <div class="user-cell">
                                <span style="font-weight:600; color:var(--text-main);">${inv.userInfo.name}</span>
                                <span class="user-email">${inv.userInfo.email}</span>
                            </div>
                        </td>
                        <td>
                             <div style="font-weight:700; color:${planColor}; font-family:var(--font-display);">${inv.planName || 'Investment'}</div>
                             <div style="font-size:0.7rem; color:var(--text-muted);">ID: ${inv.id.substring(0,8)}...</div>
                        </td>
                        <td style="font-size:0.8rem; color:var(--text-muted);">
                            <div>Start: ${date}</div>
                            <div>End: ${matDate}</div>
                        </td>
                        <td class="amt-cell">KES ${parseInt(inv.amount).toLocaleString()}</td>
                        <td class="profit-cell">+KES ${parseInt(inv.calculatedProfit).toLocaleString()}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="action-btn" onclick="openActionModal('${inv.id}')"><i class="fas fa-ellipsis-v"></i></button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // --- ACTIONS ---
        window.openActionModal = (id) => {
            currentInvId = id;
            const inv = allInvestments.find(i => i.id === id);
            if(!inv) return;

            const isPaid = ['redeemed','paid_out','cancelled'].includes(inv.status);
            const btnPay = document.getElementById('btnPayout');
            const btnCan = document.getElementById('btnCancel');
            
            // Logic for Button States
            if(isPaid) {
                btnPay.disabled = true; btnPay.classList.add('btn-disabled'); btnPay.innerHTML = `<i class="fas fa-lock"></i> ${inv.status.toUpperCase()}`;
                btnCan.disabled = true; btnCan.classList.add('btn-disabled');
            } else {
                btnPay.disabled = false; btnPay.classList.remove('btn-disabled'); btnPay.innerHTML = `<i class="fas fa-check-circle"></i> Force Payout`;
                btnCan.disabled = false; btnCan.classList.remove('btn-disabled');
            }

            document.getElementById('modalDetails').innerHTML = `
                <div class="detail-row"><span class="detail-lbl">User</span><span class="detail-val">${inv.userInfo.email}</span></div>
                <div class="detail-row"><span class="detail-lbl">Plan</span><span class="detail-val" style="color:var(--gold-base)">${inv.planName}</span></div>
                <div class="detail-row"><span class="detail-lbl">Principal</span><span class="detail-val">KES ${parseInt(inv.amount).toLocaleString()}</span></div>
                <div class="detail-row"><span class="detail-lbl">ROI Rate</span><span class="detail-val">${(inv.rate * 100).toFixed(1)}%</span></div>
                <div class="detail-row"><span class="detail-lbl">Profit</span><span class="detail-val" style="color:var(--success)">+KES ${parseInt(inv.calculatedProfit).toLocaleString()}</span></div>
                <div class="detail-row" style="border-bottom:none; margin-bottom:0;"><span class="detail-lbl">Total Payout</span><span class="detail-val" style="color:#fff; font-weight:700;">KES ${parseInt(inv.calculatedTotal).toLocaleString()}</span></div>
            `;
            
            // Attach Events
            btnPay.onclick = () => processPayout(btnPay, inv);
            btnCan.onclick = () => processRefund(btnCan, inv);

            document.getElementById('actionModal').classList.add('open');
        };

        async function processPayout(btn, inv) {
            if(btn.disabled) return;
            if(!confirm("ADMIN OVERRIDE: This will manually pay out Capital + Profit to the user immediately. Continue?")) return;
            
            handleActionWithSpinner(btn, async () => {
                try {
                    const payoutAmt = parseFloat(inv.calculatedTotal);
                    await runTransaction(db, async (transaction) => {
                        const userRef = doc(db, "users", inv.userId);
                        const userDoc = await transaction.get(userRef);
                        if (!userDoc.exists()) throw "User does not exist!";
                        
                        // Update User Balance
                        const newBalance = (userDoc.data().walletBalance || 0) + payoutAmt;
                        transaction.update(userRef, { walletBalance: newBalance });

                        // Update Investment Status
                        const invRef = doc(db, "investments", inv.id);
                        transaction.update(invRef, { status: "paid_out", paidAt: serverTimestamp() });

                        // Create Tx
                        const txRef = doc(collection(db, "transactions"));
                        transaction.set(txRef, {
                            userId: inv.userId,
                            type: "investment_payout",
                            amount: payoutAmt,
                            relatedInvestmentId: inv.id,
                            status: "completed",
                            timestamp: serverTimestamp(),
                            txCode: "ADM-PAY-" + Date.now()
                        });
                    });
                    Toastify({text: "Manual Payout Successful!", style: {background: "var(--success)"}}).showToast();
                    closeModal();
                    loadData();
                } catch (e) {
                    console.error(e);
                    Toastify({text: "Error processing payout", style: {background: "var(--danger)"}}).showToast();
                }
            });
        }

        async function processRefund(btn, inv) {
            if(btn.disabled) return;
            if(!confirm("ADMIN ACTION: Cancel investment and refund Principal amount only? User will NOT receive profit.")) return;
            
            handleActionWithSpinner(btn, async () => {
                try {
                    const refundAmt = parseFloat(inv.amount);
                    await runTransaction(db, async (transaction) => {
                        const userRef = doc(db, "users", inv.userId);
                        const userDoc = await transaction.get(userRef);
                        
                        // Refund Principal
                        const newBalance = (userDoc.data().walletBalance || 0) + refundAmt;
                        transaction.update(userRef, { walletBalance: newBalance });

                        // Mark Cancelled
                        const invRef = doc(db, "investments", inv.id);
                        transaction.update(invRef, { status: "cancelled", cancelledAt: serverTimestamp() });

                        // Log Tx
                        const txRef = doc(collection(db, "transactions"));
                        transaction.set(txRef, {
                            userId: inv.userId,
                            type: "deposit",
                            reference: "ADM-REFUND-" + inv.id,
                            amount: refundAmt,
                            status: "completed",
                            timestamp: serverTimestamp()
                        });
                    });
                    Toastify({text: "Refunded & Cancelled", style: {background: "var(--blue)"}}).showToast();
                    closeModal();
                    loadData();
                } catch(e) {
                    console.error(e);
                    Toastify({text: "Error cancelling", style: {background: "var(--danger)"}}).showToast();
                }
            });
        }

        // --- EXPORT ---
        window.exportReport = () => {
            if(filteredData.length === 0) return alert("No data to export");
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFillColor(15, 23, 42); doc.rect(0, 0, 210, 30, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(16); doc.text("EastLink Investment Report", 15, 15);
            doc.setFontSize(9); doc.text(`Generated: ${new Date().toLocaleString()}`, 15, 22);

            const tableData = filteredData.map(i => [
                i.id.substring(0,8),
                i.userInfo.email,
                i.planName,
                new Date(i.startDate.seconds*1000).toLocaleDateString(),
                `KES ${parseInt(i.amount).toLocaleString()}`,
                `KES ${parseInt(i.calculatedTotal).toLocaleString()}`,
                i.status.toUpperCase()
            ]);

            doc.autoTable({
                startY: 35,
                head: [['ID', 'User Email', 'Plan', 'Date', 'Capital', 'Total Value', 'Status']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [15, 23, 42], textColor: [217, 119, 6] },
                styles: { fontSize: 8, cellPadding: 3 }
            });

            doc.save("EastLink_Investments_Report.pdf");
        };
    </script>
</body>
</html>
