<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Broadcast AI | EastLink Admin</title>
    
    <!-- PWA & Meta -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/svg+xml" href="./assets/images/favicon.svg">
    <meta name="theme-color" content="#0F172A">
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <style>
        :root {
            /* Executive Theme */
            --bg-body: #0F172A;       
            --bg-card: rgba(30, 41, 59, 0.65);
            --bg-glass: rgba(30, 41, 59, 0.75);
            --bg-glass-heavy: rgba(15, 23, 42, 0.95);
            --bg-input: rgba(255, 255, 255, 0.07);
            --bg-hover: rgba(255, 255, 255, 0.12);
            --border-color: rgba(255, 255, 255, 0.12);
            --text-main: #F8FAFC;     
            --text-muted: #94A3B8; 
            --gold-base: #D97706;
            --gold-gradient: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            --neon-purple: #8b5cf6;
            --success: #10B981;
            --danger: #EF4444;
            --blue: #3B82F6;
            
            /* COMPACT HEADER SETTINGS */
            --sidebar-width: 260px; 
            --header-height: 60px;
            
            --radius: 16px;
            --font-head: 'Cinzel', serif;
            --font-body: 'Inter', sans-serif;
            --font-display: 'Space Grotesk', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --ease-bounce: cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: var(--font-body); 
            background-color: var(--bg-body); 
            background-image: url('assets/images/background.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            color: var(--text-main); 
            min-height: 100vh; 
            overflow-x: hidden;
            transition: background 0.3s ease;
        }

        /* Utils & Glassmorphism */
        .glass-panel {
            background: var(--bg-glass);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            width: 100%;
            overflow: hidden;
        }
        
        /* --- HEADER --- */
        header {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height);
            background: var(--bg-glass-heavy); backdrop-filter: blur(30px);
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 20px; z-index: 1000;
        }
        
        .header-left { display: flex; align-items: center; gap: 12px; }
        
        .logo { 
            font-family: var(--font-head); 
            font-weight: 700; color: var(--text-main); font-size: 1.15rem;
            text-transform: uppercase; letter-spacing: 1px; text-decoration: none; 
            display: flex; align-items: center; 
        }
        .logo span { color: var(--gold-base); }
        .admin-badge { 
            font-family: var(--font-body); font-size: 0.55rem; background: var(--bg-input); 
            border: 1px solid var(--border-color); padding: 2px 6px; border-radius: 4px; 
            margin-left: 8px; color: var(--text-muted); letter-spacing: 0.5px;
        }
        
        .hamburger { font-size: 1.2rem; cursor: pointer; color: var(--text-muted); display: none; }

        /* Header Actions */
        .header-actions { display: flex; align-items: center; gap: 8px; }
        .icon-btn { 
            width: 32px; height: 32px;
            display: grid; place-items: center; border-radius: 8px; font-size: 0.9rem;
            color: var(--text-muted); cursor: pointer; transition: all 0.3s var(--ease-bounce); position: relative;
        }
        .icon-btn:hover { background: var(--bg-hover); color: var(--text-main); }
        
        .notification-badge { 
            position: absolute; top: 2px; right: 2px; 
            min-width: 14px; height: 14px; 
            background: var(--danger); border-radius: 10px; 
            font-size: 0.55rem; color: white; font-weight: 700;
            display: none; place-items: center; justify-content: center;
            padding: 0 3px; border: 2px solid var(--bg-card);
        }
        
        .profile-widget {
            width: 34px; height: 34px;
            position: relative; cursor: pointer;
            transition: transform 0.3s; margin-left: 4px; flex-shrink: 0;
            background: var(--bg-input); border-radius: 10px; display: grid; place-items: center;
            border: 1px solid var(--border-color); color: var(--gold-base); font-size: 0.9rem;
        }
        .profile-widget:hover { background: var(--bg-hover); }

        /* --- SIDEBAR --- */
        .sidebar {
            position: fixed; top: var(--header-height); left: 0; width: var(--sidebar-width); height: calc(100vh - var(--header-height));
            background: var(--bg-glass-heavy); border-right: 1px solid var(--border-color); padding: 15px 0; overflow-y: auto; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 999; display: flex; flex-direction: column;
            backdrop-filter: blur(20px);
        }
        .nav-group { padding: 0 20px; margin-bottom: 15px; }
        .nav-label { font-size: 0.7rem; text-transform: uppercase; color: var(--gold-base); font-weight: 700; margin-bottom: 8px; letter-spacing: 1px; }
        .nav-item { 
            display: flex; align-items: center; padding: 10px 12px; color: var(--text-muted); text-decoration: none; 
            font-size: 0.85rem; transition: all 0.3s ease; border-radius: 8px; margin-bottom: 2px;
        }
        .nav-item:hover { color: var(--text-main); background: var(--bg-hover); transform: translateX(5px); }
        .nav-item.active { background: rgba(217, 119, 6, 0.1); color: var(--gold-base); font-weight: 600; }
        .nav-item i { width: 22px; text-align: center; margin-right: 8px; }
        
        /* --- MAIN --- */
        main { margin-left: var(--sidebar-width); margin-top: var(--header-height); padding: 25px; width: calc(100% - var(--sidebar-width)); min-height: 100vh; }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 998; backdrop-filter: blur(4px); }

        /* --- PAGE SPECIFIC STYLES --- */
        .layout-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }

        /* Form Elements */
        .form-section { padding: 25px; }
        .form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .form-header h2 { font-family: var(--font-head); font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        
        .ai-prompt-box {
            background: rgba(139, 92, 246, 0.05); border: 1px dashed var(--neon-purple); border-radius: 12px;
            padding: 15px; margin-bottom: 20px; position: relative;
        }
        .ai-input-wrapper { display: flex; gap: 10px; margin-top: 10px; }
        
        .input-group { margin-bottom: 15px; position: relative; }
        .input-label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .input-field { 
            width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 8px;
            padding: 12px; color: var(--text-main); font-family: var(--font-body); font-size: 0.9rem; transition: 0.3s;
        }
        .input-field:focus { border-color: var(--gold-base); background: rgba(255,255,255,0.05); }
        select.input-field option { background: var(--bg-body); }
        
        textarea.input-field { resize: vertical; min-height: 120px; line-height: 1.6; }

        /* Preview Card */
        .preview-wrapper { margin-top: 25px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; border: 1px dashed var(--border-color); }
        .notif-preview {
            background: var(--bg-card); border-left: 4px solid var(--blue); padding: 15px; border-radius: 8px;
            display: flex; gap: 15px; align-items: flex-start; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        .notif-icon-prev { 
            width: 36px; height: 36px; border-radius: 50%; background: rgba(59, 130, 246, 0.1); color: var(--blue);
            display: grid; place-items: center; flex-shrink: 0; font-size: 1rem;
        }

        /* History */
        .history-item { 
            padding: 15px; border-bottom: 1px solid var(--border-color); transition: 0.2s; cursor: default;
        }
        .history-item:last-child { border-bottom: none; }
        .history-item:hover { background: rgba(255,255,255,0.02); }
        .h-title { font-weight: 600; font-size: 0.9rem; color: var(--text-main); margin-bottom: 4px; display: flex; justify-content: space-between; }
        .h-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; gap: 10px; align-items: center; }

        .btn-main {
            background: var(--gold-gradient); color: white; border: none; padding: 12px 24px; border-radius: 8px;
            font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; width: 100%; justify-content: center;
            transition: 0.3s; margin-top: 20px; box-shadow: 0 4px 15px rgba(217, 119, 6, 0.3);
        }
        .btn-main:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn-main:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        
        .btn-test {
             background: rgba(255, 255, 255, 0.05); color: var(--text-muted); border: 1px solid var(--border-color); 
             padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer;
             width: 100%; margin-top: 10px; transition: 0.3s;
        }
        .btn-test:hover { background: var(--bg-hover); color: var(--text-main); }

        .btn-ai {
            background: rgba(139, 92, 246, 0.15); color: var(--neon-purple); border: 1px solid var(--neon-purple);
            padding: 0 15px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.85rem;
            display: flex; align-items: center; gap: 6px; transition: 0.3s;
        }
        .btn-ai:hover { background: var(--neon-purple); color: white; }

        /* PWA Popup */
        .pwa-install-popup {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px); border: 1px solid var(--gold-base);
            border-radius: 20px; padding: 20px; z-index: 3000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: none;
            animation: slideUp 0.5s ease;
        }
        @keyframes slideUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        .pwa-content { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .pwa-icon { width: 50px; height: 50px; border-radius: 12px; background: var(--gold-gradient); display: grid; place-items: center; font-size: 1.5rem; color: #000; }
        .pwa-actions { display: flex; gap: 10px; }
        .btn-pwa-install { flex: 2; padding: 10px; background: var(--gold-gradient); border: none; border-radius: 10px; font-weight: 700; cursor: pointer; color: #000; }
        .btn-pwa-dismiss { flex: 1; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-muted); cursor: pointer; }

        @media (max-width: 992px) {
            .sidebar { transform: translateX(-100%); } .sidebar.active { transform: translateX(0); }
            main { margin-left: 0; padding: 20px 10px; width: 100%; max-width: 100vw; overflow-x: hidden; }
            .layout-grid { grid-template-columns: 1fr; }
            .hamburger { display: block; }
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header>
        <div class="header-left">
            <i class="fas fa-bars hamburger" onclick="toggleSidebar()"></i>
            <a href="admin-dashboard.html" class="logo">East<span>Link</span> <span class="admin-badge">ADMIN</span></a>
        </div>
        
        <div class="header-actions">
            <div class="icon-btn" onclick="location.href='admin-support.html'" title="Support Tickets">
                <i class="fa-solid fa-envelope"></i>
                <div class="notification-badge" id="msg-badge">0</div>
            </div>
            <div class="icon-btn" onclick="location.href='admin-notifications.html'" title="System Alerts">
                <i class="fa-solid fa-bell"></i>
                <div class="notification-badge" id="notif-badge">0</div>
            </div>
            <div class="profile-widget" onclick="location.href='admin-settings.html'" title="Admin Settings">
                <i class="fa-solid fa-user-shield"></i>
            </div>
            <div class="icon-btn" onclick="logout()" style="color:var(--danger);" title="Logout">
                <i class="fa-solid fa-power-off"></i>
            </div>
        </div>
    </header>

    <!-- SIDEBAR -->
    <nav class="sidebar" id="sidebar">
        <div class="nav-group">
            <div class="nav-label">Analytics</div>
            <a href="admin-dashboard.html" class="nav-item"><i class="fa-solid fa-chart-pie"></i> Dashboard</a>
        </div>
        
        <div class="nav-group">
            <div class="nav-label">User Management</div>
            <a href="admin-users.html" class="nav-item"><i class="fa-solid fa-users"></i> Manage Users</a>
            <a href="admin-plans.html" class="nav-item"><i class="fa-solid fa-tags"></i> Manage Plans</a>
            <a href="admin-referrals.html" class="nav-item"><i class="fa-solid fa-share-nodes"></i> Referrals</a>
        </div>

        <div class="nav-group">
            <div class="nav-label">Jobs & Service</div>
            <a href="admin-jobs-mod.html" class="nav-item"><i class="fa-solid fa-briefcase"></i> Job Approvals</a>
            <a href="admin-guaranteed-jobs.html" class="nav-item link-pro"><i class="fa-solid fa-certificate" style="color:var(--gold-base);"></i> Guaranteed Jobs</a>
            <a href="admin-post-guaranteed.html" class="nav-item"><i class="fa-solid fa-plus-circle"></i> Post Vacancy</a>
        </div>

        <div class="nav-group">
            <div class="nav-label">Finance</div>
            <a href="admin-deposits.html" class="nav-item"><i class="fa-solid fa-arrow-down" style="color:var(--success);"></i> Deposits</a>
            <a href="admin-withdrawals.html" class="nav-item"><i class="fa-solid fa-arrow-up" style="color:var(--danger);"></i> Withdrawals</a>
            <a href="admin-deposit-issues.html" class="nav-item"><i class="fas fa-exclamation-triangle"></i> Errors</a>
        </div>

        <div class="nav-group">
            <div class="nav-label">System</div>
            <a href="admin-blogs.html" class="nav-item"><i class="fa-solid fa-blog"></i> Blogs & News</a>
            <a href="admin-support.html" class="nav-item"><i class="fa-solid fa-headset"></i> Support</a>
            <a href="admin-broadcasts.html" class="nav-item active"><i class="fa-solid fa-bullhorn"></i> Broadcasts</a>
            <a href="admin-settings.html" class="nav-item"><i class="fa-solid fa-sliders"></i> Settings</a>
        </div>
    </nav>
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <!-- MAIN -->
    <main>
        <div class="animate__animated animate__fadeInDown" style="margin-bottom: 24px;">
            <h1 style="font-family:var(--font-head); font-size:1.6rem;">Broadcast Center</h1>
            <p style="color:var(--text-muted); font-size:0.9rem;">Send intelligent, personalized mass notifications powered by AI.</p>
        </div>

        <div class="layout-grid">
            <!-- LEFT: COMPOSER -->
            <div class="glass-panel form-section animate__animated animate__fadeInLeft">
                <div class="form-header">
                    <h2><i class="fas fa-satellite-dish" style="color:var(--gold-base);"></i> Composer</h2>
                    <div style="font-size:0.75rem; color:var(--text-muted);">
                        <i class="fas fa-users"></i> Reach: <span id="user-count-display" style="color:var(--text-main);">Calculating...</span>
                    </div>
                </div>

                <!-- AI Section -->
                <div class="ai-prompt-box">
                    <label class="input-label" style="color:var(--neon-purple);"><i class="fas fa-sparkles"></i> AI Context Engine</label>
                    <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:8px;">
                        Describe your update (e.g., "Apologize for 2-hour server downtime last night"). The AI will detect tone, urgency, and structure the message professionally.
                    </p>
                    <div class="ai-input-wrapper">
                        <input type="text" id="ai-topic" class="input-field" placeholder="Enter topic keywords here..." style="background:rgba(0,0,0,0.2);">
                        <button class="btn-ai" onclick="generateSmartContent()" id="btn-ai-gen">
                            <i class="fas fa-wand-magic-sparkles"></i> Generate
                        </button>
                    </div>
                </div>

                <form id="broadcastForm" onsubmit="return false;">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                        <div class="input-group">
                            <label class="input-label">Target Audience</label>
                            <select id="target" class="input-field" onchange="countAudience()">
                                <option value="all">All Users</option>
                                <option value="seeker">Job Seekers Only</option>
                                <option value="employer">Employers Only</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Priority Level</label>
                            <select id="priority" class="input-field" onchange="updatePreview()">
                                <option value="normal">Normal (Info)</option>
                                <option value="high">Urgent (Red)</option>
                                <option value="success">Success (Green)</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Subject Line</label>
                        <input type="text" id="title" class="input-field" placeholder="Notification Title" onkeyup="updatePreview()">
                    </div>

                    <div class="input-group">
                        <label class="input-label">
                            Message Body 
                            <span style="float:right; text-transform:none; color:var(--gold-base); font-size:0.7rem;">Use {{name}} for dynamic names</span>
                        </label>
                        <textarea id="message" class="input-field" placeholder="Type message... (e.g., Hello {{name}}, check out our new update...)" onkeyup="updatePreview()"></textarea>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Call to Action Link (Optional)</label>
                        <input type="text" id="link" class="input-field" placeholder="e.g. /profile or https://..." onkeyup="updatePreview()">
                    </div>

                    <!-- PREVIEW -->
                    <div class="preview-wrapper">
                        <div class="input-label" style="margin-bottom:10px;">User View Preview</div>
                        <div class="notif-preview" id="prev-card">
                            <div class="notif-icon-prev" id="prev-icon"><i class="fas fa-bell"></i></div>
                            <div>
                                <h4 id="prev-title" style="font-size:0.9rem; font-weight:700; color:var(--text-main); margin-bottom:4px;">Title</h4>
                                <p id="prev-msg" style="font-size:0.8rem; color:var(--text-muted); line-height:1.4;">Message will appear here...</p>
                            </div>
                        </div>
                    </div>

                    <button id="btnSend" class="btn-main" onclick="sendBroadcast()">
                        <i class="fas fa-paper-plane"></i> Send Broadcast
                    </button>
                    
                    <button id="btnTest" class="btn-test" onclick="sendTestBroadcast()">
                        <i class="fas fa-user-shield"></i> Send Test to Me
                    </button>
                </form>
            </div>

            <!-- RIGHT: HISTORY -->
            <div class="glass-panel animate__animated animate__fadeInRight">
                <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="font-size:1rem;">History Log</h3>
                    <i class="fas fa-sync-alt" style="cursor:pointer; color:var(--gold-base);" onclick="loadHistory()"></i>
                </div>
                <div id="historyLog" style="max-height: 600px; overflow-y:auto;">
                    <div style="padding:30px; text-align:center; color:var(--text-muted);">Loading logs...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- PWA INSTALL POPUP -->
    <div id="pwa-install-popup" class="pwa-install-popup">
        <div class="pwa-content">
            <div class="pwa-icon"><i class="fas fa-download"></i></div>
            <div>
                <div style="font-weight:700; color:#fff; font-size:1rem; margin-bottom:4px;">Install Admin App</div>
                <div style="font-size:0.8rem; color:#94A3B8;">Add to home screen for quick access.</div>
            </div>
        </div>
        <div class="pwa-actions">
            <button class="btn-pwa-install" onclick="installPWA()">Install</button>
            <button class="btn-pwa-dismiss" onclick="dismissPWA()">Later</button>
        </div>
    </div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script type="module">
        import { auth, db } from './config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { doc, getDoc, collection, query, where, getDocs, writeBatch, serverTimestamp, onSnapshot, orderBy, limit, addDoc, getCountFromServer } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        // --- UI UTILS ---
        window.toggleSidebar = () => { 
            document.getElementById('sidebar').classList.toggle('active'); 
            document.getElementById('overlay').style.display = document.getElementById('sidebar').classList.contains('active') ? 'block' : 'none';
        };
        
        window.logout = () => {
            if(confirm("Confirm Log Out?")) signOut(auth).then(() => window.location.href = 'signin.html');
        };

        // --- APP LOGIC ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) { window.location.href = 'signin.html'; return; }
            initBadges();
            loadHistory();
            countAudience();
        });

        async function countAudience() {
            const target = document.getElementById('target').value;
            const el = document.getElementById('user-count-display');
            el.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            try {
                let q = collection(db, "users");
                if(target !== 'all') q = query(collection(db, "users"), where("role", "==", target));
                
                // Optimized Count Query (Doesn't download docs)
                const snap = await getCountFromServer(q);
                el.innerText = snap.data().count.toLocaleString() + " Users";
            } catch(e) { 
                console.error(e);
                el.innerText = "Check Connection"; 
            }
        }

        // --- CONTEXTUAL AI ENGINE ---
        window.generateSmartContent = async () => {
            const topic = document.getElementById('ai-topic').value.toLowerCase();
            const btn = document.getElementById('btn-ai-gen');
            
            if(!topic || topic.length < 3) return Toastify({text: "Please enter a detailed topic.", style:{background:"var(--danger)"}}).showToast();

            const originalBtn = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Analyzing...';
            btn.disabled = true;

            setTimeout(() => {
                let generated = { title: "", body: "", priority: "normal" };

                // 1. ANALYSIS LAYER
                const keywords = {
                    urgent: ['downtime', 'error', 'outage', 'maintenance', 'offline', 'emergency', 'security', 'breach'],
                    success: ['success', 'welcome', 'congrats', 'promoted', 'discount', 'offer', 'bonus', 'feature', 'new'],
                    money: ['payment', 'deposit', 'withdrawal', 'fee', 'price', 'subscription', 'refund'],
                    policy: ['terms', 'privacy', 'policy', 'rules', 'guidelines', 'legal']
                };

                // 2. DECISION TREE
                if (keywords.urgent.some(k => topic.includes(k))) {
                    generated.priority = "high";
                    generated.title = "âš ï¸ Important Service Update";
                    generated.body = "Hello {{name}},\n\nWe are currently addressing a system issue regarding " + topic.replace('downtime', 'service availability') + ". Our team is working to resolve this immediately. Thank you for your patience.";
                } 
                else if (keywords.success.some(k => topic.includes(k))) {
                    generated.priority = "success";
                    generated.title = "ðŸŽ‰ Exciting News!";
                    generated.body = "Hi {{name}}! We have some great news about " + topic + ". Check out the dashboard to see how this benefits you today.";
                }
                else if (keywords.policy.some(k => topic.includes(k))) {
                    generated.priority = "normal";
                    generated.title = "ðŸ“œ Policy Update Notice";
                    generated.body = "Dear {{name}},\n\nWe have updated our platform policies regarding " + topic + ". Please review these changes to stay informed.";
                }
                else {
                    generated.priority = "normal";
                    generated.title = "Update: " + capitalizeFirst(topic);
                    generated.body = "Hello {{name}},\n\nWe have an update regarding " + topic + ". Please visit your dashboard for more details.";
                }

                document.getElementById('title').value = generated.title;
                document.getElementById('message').value = generated.body;
                document.getElementById('priority').value = generated.priority;
                
                updatePreview();
                btn.innerHTML = originalBtn;
                btn.disabled = false;
                Toastify({text: "AI Content Generated âœ¨", style:{background: "var(--neon-purple)"}}).showToast();

            }, 1200); 
        };

        function capitalizeFirst(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        window.updatePreview = () => {
            const title = document.getElementById('title').value || "Notification Title";
            let msg = document.getElementById('message').value || "Message content...";
            const prio = document.getElementById('priority').value;
            
            // Replace placeholder for preview
            msg = msg.replace('{{name}}', 'John Doe');

            document.getElementById('prev-title').innerText = title;
            document.getElementById('prev-msg').innerText = msg;
            
            const card = document.getElementById('prev-card');
            const icon = document.getElementById('prev-icon');
            
            const colors = { normal: 'var(--blue)', high: 'var(--danger)', success: 'var(--success)' };
            const icons = { normal: 'fa-bell', high: 'fa-exclamation-triangle', success: 'fa-gift' };
            const bgs = { normal: 'rgba(59, 130, 246, 0.1)', high: 'rgba(239, 68, 68, 0.1)', success: 'rgba(16, 185, 129, 0.1)' };

            card.style.borderLeftColor = colors[prio];
            icon.style.color = colors[prio];
            icon.style.background = bgs[prio];
            icon.innerHTML = `<i class="fas ${icons[prio]}"></i>`;
        };

        // --- TEST FLIGHT MODE ---
        window.sendTestBroadcast = async () => {
            const title = document.getElementById('title').value;
            const rawMessage = document.getElementById('message').value;
            const priority = document.getElementById('priority').value;
            const link = document.getElementById('link').value;

            if(!title || !rawMessage) return Toastify({ text: "Enter content first", style: { background: "var(--danger)" } }).showToast();

            const myUid = auth.currentUser.uid;
            // Get Admin Name for personalization test
            let adminName = "Admin";
            try {
                const me = await getDoc(doc(db, "users", myUid));
                if(me.exists()) adminName = me.data().fullName || "Admin";
            } catch(e){}

            const msg = rawMessage.replace(/{{name}}/g, adminName + " (Test)");

            try {
                await addDoc(collection(db, "notifications"), {
                    userId: myUid, title: "[TEST] " + title, message: msg, 
                    type: "system", priority, link: link || null, read: false, timestamp: serverTimestamp()
                });
                Toastify({ text: "Test Sent! Check your notifications.", style: { background: "var(--blue)" } }).showToast();
            } catch(e) {
                console.error(e);
                Toastify({ text: "Error: " + e.message, style: { background: "var(--danger)" } }).showToast();
            }
        };

        // --- BATCH SEND ---
        window.sendBroadcast = async () => {
            const btn = document.getElementById('btnSend');
            const target = document.getElementById('target').value;
            const title = document.getElementById('title').value;
            const rawMessage = document.getElementById('message').value;
            const link = document.getElementById('link').value;
            const priority = document.getElementById('priority').value;

            if(!title || !rawMessage) { Toastify({ text: "Missing Content", style: { background: "var(--danger)" } }).showToast(); return; }
            if(!confirm(`Send to ${target.toUpperCase()} users? This cannot be undone.`)) return;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Queuing...';

            try {
                let q = collection(db, "users");
                if(target !== 'all') q = query(collection(db, "users"), where("role", "==", target));
                
                const snapshot = await getDocs(q);
                if(snapshot.empty) throw new Error("No users found matching audience.");

                const users = snapshot.docs;
                const total = users.length;
                const CHUNK_SIZE = 400; // Safe below 500 limit
                
                let processed = 0;

                for(let i=0; i < total; i += CHUNK_SIZE) {
                    const chunk = users.slice(i, i + CHUNK_SIZE);
                    const batch = writeBatch(db);
                    
                    chunk.forEach(u => {
                        const userData = u.data();
                        const displayName = userData.fullName || userData.companyName || "Valued Member";
                        const personalizedMsg = rawMessage.replace(/{{name}}/g, displayName);

                        const ref = doc(collection(db, "notifications"));
                        batch.set(ref, {
                            userId: u.id, title: title, message: personalizedMsg, 
                            type: "system", priority: priority, link: link || null, 
                            read: false, timestamp: serverTimestamp()
                        });
                    });

                    await batch.commit();
                    processed += chunk.length;
                    btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Sent ${processed}/${total}...`;
                }

                await addDoc(collection(db, "broadcast_logs"), {
                    title, message: rawMessage, target, sentCount: total, priority,
                    admin: auth.currentUser.uid, timestamp: serverTimestamp()
                });

                Toastify({ text: `Sent to ${total} users!`, style: { background: "var(--success)" } }).showToast();
                document.getElementById('broadcastForm').reset();
                updatePreview();
                loadHistory();

            } catch(e) {
                console.error(e);
                Toastify({ text: "Error: " + e.message, style: { background: "var(--danger)" } }).showToast();
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Broadcast';
            }
        };

        window.loadHistory = () => {
            const q = query(collection(db, "broadcast_logs"), orderBy("timestamp", "desc"), limit(20));
            onSnapshot(q, (snap) => {
                const el = document.getElementById('historyLog');
                el.innerHTML = '';
                if(snap.empty) { el.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-muted);">No logs found.</div>'; return; }

                snap.forEach(d => {
                    const t = d.data();
                    const date = t.timestamp ? new Date(t.timestamp.seconds*1000).toLocaleString('en-GB', {day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'}) : 'Just now';
                    
                    let color = 'var(--blue)';
                    if(t.priority === 'high') color = 'var(--danger)';
                    if(t.priority === 'success') color = 'var(--success)';

                    el.innerHTML += `
                        <div class="history-item animate__animated animate__fadeIn">
                            <div class="h-title">
                                <span>${t.title}</span>
                                <span style="font-size:0.75rem; color:${color}; text-transform:uppercase;">${t.priority}</span>
                            </div>
                            <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:6px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${t.message}</p>
                            <div class="h-meta">
                                <span><i class="fas fa-bullseye"></i> ${t.target.toUpperCase()}</span>
                                <span><i class="fas fa-check-double"></i> ${t.sentCount}</span>
                                <span>${date}</span>
                            </div>
                        </div>
                    `;
                });
            });
        };

        function initBadges() {
            onSnapshot(query(collection(db, "transactions"), where("status", "==", "pending")), (snap) => {
                const count = snap.size;
                const badge = document.getElementById('notif-badge');
                if(count > 0) { badge.innerText = count; badge.style.display = 'flex'; }
                else badge.style.display = 'none';
            });
            
            onSnapshot(query(collection(db, "support_tickets"), where("status", "==", "open")), (snap) => {
                const count = snap.size;
                const badge = document.getElementById('msg-badge');
                if(count > 0) { badge.innerText = count; badge.style.display = 'flex'; }
                else badge.style.display = 'none';
            });
        }

        // --- PWA LOGIC ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('pwa-install-popup').style.display = 'block';
        });

        window.installPWA = async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                document.getElementById('pwa-install-popup').style.display = 'none';
            }
            deferredPrompt = null;
        };

        window.dismissPWA = () => {
            document.getElementById('pwa-install-popup').style.display = 'none';
        };

        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("./service-worker.js").catch(e => console.log("SW Fail:", e));
        }

        // Expose to window
        window.countAudience = countAudience;
        window.generateSmartContent = generateSmartContent;
        window.updatePreview = updatePreview;
        window.sendTestBroadcast = sendTestBroadcast;
        window.sendBroadcast = sendBroadcast;
        window.loadHistory = loadHistory;
    </script>
</body>
</html>
