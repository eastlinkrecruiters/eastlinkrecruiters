<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Messages | EastLink Recruiters</title>
    
    <!-- PWA & Meta -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0F172A">
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <style>
        :root {
            /* Theme Variables */
            --bg-body: #0F172A;       
            --bg-card: rgba(15, 23, 42, 0.6);
            --bg-glass: rgba(15, 23, 42, 0.5);
            --bg-glass-heavy: rgba(15, 23, 42, 0.85);
            --bg-input: rgba(255, 255, 255, 0.1);
            --bg-hover: rgba(255, 255, 255, 0.15);
            --border-color: rgba(255, 255, 255, 0.15);
            --text-main: #F8FAFC;     
            --text-muted: #CBD5E1;
            --gold-base: #D97706;
            --gold-gradient: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            --neon-purple: #8b5cf6;
            --success: #10B981;
            --danger: #EF4444;
            --sidebar-width: 260px; 
            --thread-list-width: 340px;
            --header-height: 70px;
            --font-head: 'Cinzel', serif;
            --font-body: 'Inter', sans-serif;
            --font-display: 'Space Grotesk', sans-serif;
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: var(--font-body); 
            background-color: var(--bg-body); 
            background-image: url('assets/images/background.png'); 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            color: var(--text-main); 
            height: 100vh; width: 100vw;
            overflow: hidden; 
            display: flex; flex-direction: column;
        }

        /* --- HEADER --- */
        header {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height);
            background: var(--bg-glass-heavy); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; padding: 0 24px; z-index: 1000;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo { font-family: var(--font-head); font-weight: 700; color: var(--text-main); font-size: 1.3rem; text-transform: uppercase; letter-spacing: 1px; text-decoration: none; display: flex; align-items: center; }
        .logo span { color: var(--gold-base); }
        .hamburger { font-size: 1.4rem; cursor: pointer; color: var(--text-muted); display: none; }

        .global-search-container { flex: 1; max-width: 450px; position: relative; margin: 0 20px; }
        .global-search-input {
            width: 100%; background: var(--bg-input); border: 1px solid var(--border-color);
            padding: 10px 45px 10px 15px; border-radius: 12px; color: var(--text-main);
            transition: all 0.3s ease; font-size: 0.9rem;
        }
        
        .header-actions { display: flex; align-items: center; gap: 10px; }
        .icon-btn { width: 40px; height: 40px; display: grid; place-items: center; border-radius: 10px; color: var(--text-muted); cursor: pointer; transition: 0.3s; position: relative; }
        .icon-btn:hover { background: var(--bg-hover); color: var(--text-main); }
        .notification-badge { position: absolute; top: 5px; right: 5px; min-width: 16px; height: 16px; background: var(--danger); border-radius: 10px; font-size: 0.6rem; color: white; font-weight: 700; display: none; place-items: center; justify-content: center; padding: 0 4px; border: 2px solid var(--bg-card); }
        
        .profile-widget { width: 42px; height: 42px; position: relative; cursor: pointer; margin-left: 5px; }
        .user-avatar { width: 100%; height: 100%; border-radius: 12px; background: var(--gold-gradient); display: grid; place-items: center; font-weight: 700; color: #fff; border: 2px solid var(--border-color); object-fit: cover; }
        .user-avatar.img-mode { background: transparent; }

        /* --- SIDEBAR --- */
        .sidebar {
            position: fixed; top: var(--header-height); left: 0; width: var(--sidebar-width); height: calc(100vh - var(--header-height));
            background: var(--bg-glass-heavy); border-right: 1px solid var(--border-color); padding: 20px 0; overflow-y: auto; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 999; display: flex; flex-direction: column;
            backdrop-filter: blur(20px);
        }
        .nav-group { padding: 0 24px; margin-bottom: 20px; }
        .nav-label { font-size: 0.7rem; text-transform: uppercase; color: var(--gold-base); font-weight: 700; margin-bottom: 8px; letter-spacing: 1px; }
        .nav-item { display: flex; align-items: center; padding: 12px 14px; color: var(--text-muted); text-decoration: none; font-size: 0.9rem; transition: 0.3s; border-radius: 10px; margin-bottom: 4px; position: relative; }
        .nav-item:hover { color: var(--text-main); background: var(--bg-hover); transform: translateX(5px); }
        .nav-item.active { background: rgba(217, 119, 6, 0.1); color: var(--gold-base); font-weight: 600; }
        .nav-item i { width: 25px; text-align: center; margin-right: 10px; }
        .lock-icon { margin-left: auto; font-size: 0.7rem; opacity: 0; transition: 0.3s; }
        
        /* Locking Logic Visuals */
        .nav-item.locked { opacity: 0.6; cursor: not-allowed; }
        .nav-item.locked:hover { transform: none; background: transparent; color: var(--text-muted); }
        .nav-item.locked .lock-icon { opacity: 1; color: var(--text-muted); }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 998; backdrop-filter: blur(4px); display: none; }

        /* --- MAIN LAYOUT --- */
        main { 
            margin-left: var(--sidebar-width); margin-top: var(--header-height); 
            height: calc(100vh - var(--header-height)); width: calc(100% - var(--sidebar-width)); 
            display: flex; overflow: hidden; position: relative;
        }

        /* --- THREAD LIST --- */
        .thread-sidebar {
            width: var(--thread-list-width); height: 100%;
            background: var(--bg-glass); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; z-index: 50; flex-shrink: 0;
            backdrop-filter: blur(15px);
        }
        .thread-header { padding: 20px 15px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        
        .search-wrapper { position: relative; margin-bottom: 15px; }
        .search-input {
            width: 100%; background: var(--bg-input); border: 1px solid var(--border-color);
            padding: 10px 35px 10px 15px; border-radius: 12px; color: var(--text-main); font-size: 0.9rem;
        }
        .search-icon { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.9rem; }

        .filter-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .filter-chip { 
            white-space: nowrap; padding: 6px 14px; border-radius: 20px; font-size: 0.75rem; 
            background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-muted); cursor: pointer; 
        }
        .filter-chip.active { background: var(--gold-gradient); color: #0F172A; border-color: transparent; font-weight: 700; }

        .thread-list { flex: 1; overflow-y: auto; padding: 10px 0; }
        .thread-item {
            display: flex; align-items: center; padding: 16px 20px; cursor: pointer; transition: all 0.2s;
            border-left: 3px solid transparent; position: relative; margin-bottom: 2px;
        }
        .thread-item:hover { background: var(--bg-hover); }
        .thread-item.active { background: rgba(217, 119, 6, 0.2); border-left-color: var(--gold-base); }
        .thread-item.pinned { background: rgba(139, 92, 246, 0.1); }
        
        .t-avatar-box { position: relative; margin-right: 15px; flex-shrink: 0; }
        .t-avatar { width: 48px; height: 48px; border-radius: 14px; background: var(--bg-input); display: grid; place-items: center; font-weight: 700; color: var(--gold-base); border: 1px solid var(--border-color); object-fit: cover; }
        
        .t-info { flex: 1; min-width: 0; }
        .t-top { display: flex; justify-content: space-between; margin-bottom: 4px; align-items: center; }
        .t-name { font-weight: 600; color: var(--text-main); font-size: 0.95rem; }
        .t-time { font-size: 0.75rem; color: var(--text-muted); font-weight: 500; }
        .t-btm { display: flex; justify-content: space-between; align-items: center; }
        .t-msg { color: var(--text-muted); font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80%; }
        .t-msg.unread { color: var(--text-main); font-weight: 600; }
        
        .badges-container { display: flex; gap: 5px; align-items: center; }
        .unread-badge { background: var(--gold-base); color: #000; font-size: 0.65rem; font-weight: 700; padding: 2px 6px; border-radius: 10px; min-width: 18px; text-align: center; }
        .pin-icon { color: var(--text-muted); font-size: 0.7rem; transform: rotate(45deg); display: none; }
        .thread-item.pinned .pin-icon { display: block; color: var(--neon-purple); }

        /* --- CHAT AREA --- */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: rgba(15, 23, 42, 0.2); position: relative; overflow: hidden; }

        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); text-align: center; animation: fadeIn 0.5s ease; }
        .empty-icon { font-size: 3rem; margin-bottom: 20px; color: var(--gold-base); opacity: 0.5; }

        .chat-header {
            height: 75px; background: var(--bg-glass-heavy); border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; padding: 0 24px; flex-shrink: 0;
            backdrop-filter: blur(15px);
        }
        .ch-user { display: flex; align-items: center; gap: 12px; }
        .ch-avatar { width: 42px; height: 42px; border-radius: 12px; background: var(--gold-gradient); color: #000; font-weight: 700; display: grid; place-items: center; object-fit: cover; border: 1px solid var(--border-color); }
        .mobile-back { display: none; font-size: 1.2rem; margin-right: 15px; color: var(--text-muted); cursor: pointer; }

        .messages-container { 
            flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; 
            background-image: radial-gradient(circle at center, rgba(217,119,6,0.03) 0%, transparent 70%);
        }
        
        .date-divider { text-align: center; margin: 20px 0; font-size: 0.75rem; color: var(--text-muted); position: relative; }
        .date-divider::before { content: ''; position: absolute; left: 0; top: 50%; width: 100%; height: 1px; background: var(--border-color); z-index: -1; }
        .date-span { background: var(--bg-glass-heavy); padding: 4px 12px; border-radius: 12px; border: 1px solid var(--border-color); font-weight: 500; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; }

        .msg-row { display: flex; flex-direction: column; max-width: 75%; position: relative; margin-bottom: 5px; group; }
        .msg-row.sent { align-self: flex-end; align-items: flex-end; }
        .msg-row.received { align-self: flex-start; align-items: flex-start; }

        .msg-bubble { 
            padding: 12px 18px; border-radius: 18px; font-size: 0.95rem; line-height: 1.5; 
            position: relative; word-wrap: break-word; box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer;
            backdrop-filter: blur(5px);
        }
        .msg-row.sent .msg-bubble { background: var(--gold-gradient); color: #0F172A; border-bottom-right-radius: 4px; font-weight: 600; }
        .msg-row.received .msg-bubble { background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border-color); border-bottom-left-radius: 4px; }
        
        .msg-img { max-width: 250px; border-radius: 12px; margin-bottom: 8px; border: 1px solid var(--border-color); display: block; }
        .msg-meta { font-size: 0.7rem; margin-top: 5px; color: var(--text-muted); opacity: 0.9; display: flex; align-items: center; gap: 5px; font-family: var(--font-display); font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .msg-row.sent .msg-meta { justify-content: flex-end; }
        .read-check.read { color: var(--neon-purple); }

        /* INPUT AREA */
        .input-zone {
            background: var(--bg-glass-heavy); border-top: 1px solid var(--border-color);
            padding: 20px; padding-bottom: calc(20px + var(--safe-bottom));
            display: flex; flex-direction: column; gap: 12px; flex-shrink: 0; z-index: 20;
            backdrop-filter: blur(20px);
        }
        .preview-area { display: none; align-items: center; gap: 12px; padding: 12px; background: var(--bg-input); border-radius: 12px; border: 1px solid var(--border-color); animation: fadeIn 0.3s; }
        .preview-thumb { height: 50px; border-radius: 8px; border: 1px solid var(--border-color); }
        .input-flex { display: flex; align-items: flex-end; gap: 12px; position: relative; }
        
        .tool-btn { width: 44px; height: 44px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-muted); cursor: pointer; display: grid; place-items: center; flex-shrink: 0; }
        .chat-input { flex: 1; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 14px; padding: 12px 16px; color: var(--text-main); font-family: var(--font-body); font-size: 0.95rem; resize: none; min-height: 44px; max-height: 120px; }
        .send-btn { width: 44px; height: 44px; border-radius: 12px; background: var(--gold-gradient); border: none; color: #0F172A; font-size: 1.1rem; cursor: pointer; display: grid; place-items: center; }

        /* EMOJI & MENUS */
        .emoji-picker-container { position: absolute; bottom: 80px; left: 0; width: 100%; max-width: 350px; height: 280px; background: var(--bg-glass-heavy); border: 1px solid var(--border-color); border-radius: 16px; display: none; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.6); z-index: 100; backdrop-filter: blur(25px); }
        .emoji-picker-container.active { display: flex; }
        .emoji-grid { flex: 1; overflow-y: auto; padding: 12px; display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
        .emoji-btn { font-size: 1.4rem; cursor: pointer; border-radius: 8px; display: grid; place-items: center; height: 40px; transition: 0.2s; }
        .emoji-btn:hover { background: var(--bg-hover); }

        .dropdown { position: absolute; top: 110%; right: 0; width: 220px; background: var(--bg-glass-heavy); border: 1px solid var(--border-color); border-radius: 12px; display: none; flex-direction: column; z-index: 1000; backdrop-filter: blur(20px); }
        .dropdown.show { display: flex; }
        .dd-item { padding: 14px 20px; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 12px; color: var(--text-muted); border-bottom: 1px solid rgba(255,255,255,0.03); }
        .dd-item.danger { color: var(--danger); }

        .ctx-menu { position: fixed; background: var(--bg-glass-heavy); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); z-index: 2000; display: none; flex-direction: column; min-width: 160px; backdrop-filter: blur(10px); }
        .ctx-item { padding: 10px 15px; font-size: 0.85rem; color: var(--text-main); cursor: pointer; display: flex; gap: 10px; align-items: center; }

        /* UPGRADE MODAL */
        .upgrade-modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000;
            display: none; place-items: center; backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }
        .upgrade-modal {
            background: #0F172A; border: 1px solid var(--border-color);
            width: 90%; max-width: 400px; border-radius: 20px; padding: 30px;
            text-align: center; position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: zoomIn 0.3s ease;
        }
        .modal-icon-lock {
            font-size: 2.5rem; color: var(--gold-base); margin-bottom: 15px;
            background: rgba(217, 119, 6, 0.1); width: 80px; height: 80px;
            display: grid; place-items: center; border-radius: 50%; margin-left: auto; margin-right: auto;
        }
        .modal-title { font-family: var(--font-head); font-size: 1.5rem; margin-bottom: 10px; color: var(--text-main); }
        .modal-desc { color: var(--text-muted); font-size: 0.9rem; line-height: 1.6; margin-bottom: 25px; }
        .btn-upgrade {
            display: block; width: 100%; padding: 14px; border-radius: 12px;
            background: var(--gold-gradient); color: #000; font-weight: 700;
            text-decoration: none; border: none; cursor: pointer; font-size: 1rem;
            margin-bottom: 10px; transition: 0.3s;
        }
        .btn-upgrade:hover { transform: scale(1.02); }
        .btn-close-modal {
            background: transparent; color: var(--text-muted); border: none;
            cursor: pointer; font-size: 0.9rem; text-decoration: underline;
        }

        /* PWA Popup */
        .pwa-install-popup {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px); border: 1px solid var(--gold-base);
            border-radius: 20px; padding: 20px; z-index: 3000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: none;
            animation: slideUp 0.5s ease;
        }
        @keyframes slideUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        .pwa-content { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .pwa-icon { width: 50px; height: 50px; border-radius: 12px; background: var(--gold-gradient); display: grid; place-items: center; font-size: 1.5rem; color: #000; }
        .pwa-actions { display: flex; gap: 10px; }
        .btn-pwa-install { flex: 2; padding: 10px; background: var(--gold-gradient); border: none; border-radius: 10px; font-weight: 700; cursor: pointer; color: #000; }
        .btn-pwa-dismiss { flex: 1; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-muted); cursor: pointer; }

        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
        @keyframes zoomIn { from{opacity:0; transform:scale(0.9);} to{opacity:1; transform:scale(1);} }

        /* --- MOBILE RESPONSIVE FIXES --- */
        @media (max-width: 992px) {
            .global-search-container { display: none; }
            .sidebar { transform: translateX(-100%); } .sidebar.active { transform: translateX(0); }
            .hamburger { display: block; }
            
            main { margin-left: 0; width: 100%; display: block; }
            
            .thread-sidebar { width: 100%; height: 100%; display: flex; }
            .chat-area { width: 100%; height: 100%; display: none; }
            
            body.chat-active .thread-sidebar { display: none; }
            body.chat-active .chat-area { display: flex; }
            
            .mobile-back { display: block; }
            .empty-state { display: none; }
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header>
        <div class="header-left">
            <i class="fas fa-bars hamburger" onclick="toggleSidebar()"></i>
            <a href="seeker-dashboard.html" class="logo">EAST<span>LINK</span></a>
        </div>
        
        <div class="global-search-container">
            <input type="text" class="global-search-input" placeholder="Search across EastLink...">
            <i class="fas fa-search" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
        </div>

        <div class="header-actions">
            <div class="icon-btn" title="Messages" style="color:var(--gold-base); background:var(--bg-hover);">
                <i class="fa-regular fa-envelope"></i>
                <div class="notification-badge" id="msg-badge">0</div>
            </div>
            <div class="icon-btn" title="Notifications" onclick="location.href='seeker-notifications.html'">
                <i class="fa-regular fa-bell"></i>
                <div class="notification-badge" id="notif-badge">0</div>
            </div>
            <div class="profile-widget" onclick="location.href='seeker-profile.html'">
                <img src="" id="header-avatar-img" class="user-avatar img-mode" alt="Profile" style="display:none;">
                <div id="header-avatar-fallback" class="user-avatar">U</div>
            </div>
        </div>
    </header>

    <!-- SIDEBAR -->
    <nav class="sidebar" id="sidebar">
        <div class="nav-group">
            <div class="nav-label">Overview</div>
            <a href="seeker-dashboard.html" class="nav-item"><i class="fa-solid fa-compass"></i> Dashboard</a>
        </div>
        <div class="nav-group">
            <div class="nav-label">Job Hunt</div>
            <a href="seeker-applications.html" class="nav-item"><i class="fa-solid fa-file-signature"></i> Applied Jobs</a>
            <a href="seeker-jobs.html" class="nav-item"><i class="fa-solid fa-briefcase"></i> Browse Jobs</a>
            <a href="seeker-featured-jobs.html" class="nav-item link-std" id="nav-featured"><i class="fa-solid fa-star"></i> Featured Jobs <i class="fas fa-lock lock-icon"></i></a>
            <a href="seeker-urgentlyhiring.html" class="nav-item link-pro" id="nav-urgent"><i class="fa-solid fa-bolt" style="color:var(--gold-base);"></i> Recommended <i class="fas fa-lock lock-icon"></i></a>
            <a href="seeker-guaranteed-jobs.html" class="nav-item link-pro" id="nav-guaranteed"><i class="fa-solid fa-shield-halved" style="color:var(--success);"></i> Guaranteed Jobs <i class="fas fa-lock lock-icon"></i></a>
        </div>
        <div class="nav-group">
            <div class="nav-label">Finance</div>
            <a href="seeker-wallet.html" class="nav-item"><i class="fa-solid fa-wallet"></i> My Wallet</a>
            <a href="seeker-premium.html" class="nav-item"><i class="fa-solid fa-crown"></i> My Plan</a>
            <a href="seeker-referrals.html" class="nav-item link-std" id="nav-referrals"><i class="fa-solid fa-user-plus"></i> Invite & Earn <i class="fas fa-lock lock-icon"></i></a>
            <a href="seeker-invest.html" class="nav-item link-std" id="nav-invest"><i class="fa-solid fa-chart-line"></i> Invest <i class="fas fa-lock lock-icon"></i></a>
        </div>
        <div class="nav-group">
            <div class="nav-label">Resources</div>
            <a href="seeker-blog.html" class="nav-item"><i class="fa-solid fa-newspaper"></i> News & Insights</a>
            <a href="seeker-resources.html" class="nav-item link-pro" id="nav-resources"><i class="fa-solid fa-book"></i> Resources <i class="fas fa-lock lock-icon"></i></a>
        </div>
        <div class="nav-group">
            <div class="nav-label">Settings</div>
            <a href="seeker-profile.html" class="nav-item"><i class="fa-solid fa-user-gear"></i> Profile</a>
            <a href="seeker-settings.html" class="nav-item"><i class="fa-solid fa-sliders"></i> Settings</a>
            <a href="#" onclick="logout()" class="nav-item" style="color:var(--danger); margin-top:10px;"><i class="fa-solid fa-right-from-bracket"></i> Sign Out</a>
        </div>
    </nav>
    <div class="overlay" id="overlay" onclick="closeSidebar()"></div>

    <!-- MAIN CONTENT -->
    <main>
        <!-- THREAD LIST PANE -->
        <aside class="thread-sidebar">
            <div class="thread-header">
                <div class="search-wrapper">
                    <input type="text" id="search-input" class="search-input" placeholder="Search conversations..." onkeyup="renderThreads()">
                    <i class="fas fa-search search-icon"></i>
                </div>
                
                <div class="filter-row">
                    <div class="filter-chip active" onclick="setFilter('all', this)">All</div>
                    <div class="filter-chip" onclick="setFilter('unread', this)">Unread</div>
                    <div class="filter-chip" onclick="setFilter('pinned', this)"><i class="fas fa-thumbtack" style="font-size:0.7rem; margin-right:4px;"></i> Pinned</div>
                    <div class="filter-chip" onclick="setFilter('archived', this)">Archived</div>
                </div>

                <div id="bulk-actions" style="display:none; align-items:center; justify-content:space-between; margin-top:10px; padding-top:10px; border-top:1px solid var(--border-color);">
                    <span style="font-size:0.8rem; color:var(--text-muted);"><span id="select-count">0</span> selected</span>
                    <div style="display:flex; gap:10px;">
                        <button onclick="deleteBulk()" style="color:var(--danger); background:none; border:none; cursor:pointer; font-weight:600; font-size:0.8rem;">Delete</button>
                        <button onclick="toggleSelectMode()" style="color:var(--text-muted); background:none; border:none; cursor:pointer; font-size:0.8rem;">Cancel</button>
                    </div>
                </div>
            </div>

            <div class="thread-list" id="thread-list">
                <div style="padding:40px; text-align:center; color:var(--text-muted);">
                    <i class="fas fa-circle-notch fa-spin" style="color:var(--gold-base);"></i> Loading chats...
                </div>
            </div>
        </aside>

        <!-- CHAT AREA -->
        <section class="chat-area" id="chat-ui">
            
            <div class="empty-state" id="empty-state">
                <i class="far fa-comments empty-icon animate__animated animate__rubberBand"></i>
                <h2 style="font-family:var(--font-head); margin-bottom:10px; color:var(--text-main);">EastLink Messages</h2>
                <p>Select a conversation to start chatting.</p>
                <button onclick="toggleSelectMode()" style="margin-top:20px; padding:10px 20px; border:1px solid var(--border-color); background:transparent; color:var(--text-main); border-radius:30px; cursor:pointer; transition:0.3s; font-size:0.9rem;">
                    <i class="fas fa-tasks" style="margin-right:8px; color:var(--gold-base);"></i> Manage Chats
                </button>
            </div>

            <!-- Active Chat -->
            <div id="active-chat-container" style="display:none; flex-direction:column; height:100%; width:100%;">
                
                <div class="chat-header">
                    <div style="display:flex; align-items:center;">
                        <i class="fas fa-chevron-left mobile-back" onclick="closeChat()"></i>
                        <div class="ch-user">
                            <img src="" class="ch-avatar" id="header-avatar-chat">
                            <div>
                                <h3 style="font-size:1rem; font-weight:600; color:var(--text-main);" id="header-name">User</h3>
                                <div style="font-size:0.75rem; color:var(--text-muted);" id="header-status">
                                    Click info to view profile
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="position:relative;">
                        <button class="icon-btn" onclick="document.getElementById('chat-dropdown').classList.toggle('show')"><i class="fas fa-ellipsis-vertical"></i></button>
                        <div class="dropdown animate__animated animate__zoomIn" id="chat-dropdown">
                            <div class="dd-item" onclick="togglePinCurrent()"><i class="fas fa-thumbtack"></i> Pin Chat</div>
                            <div class="dd-item" onclick="markAsUnread()"><i class="fas fa-envelope"></i> Mark Unread</div>
                            <div class="dd-item" onclick="toggleMute()"><i class="fas fa-bell-slash"></i> Mute Notifications</div>
                            <div class="dd-item" onclick="archiveChat()"><i class="fas fa-archive"></i> Archive Chat</div>
                            <div class="dd-item danger" onclick="deleteCurrentChat()"><i class="fas fa-trash-alt"></i> Delete Conversation</div>
                        </div>
                    </div>
                </div>

                <div class="messages-container" id="messages-box"></div>

                <!-- Input Zone -->
                <div class="input-zone">
                    <div class="preview-area" id="attachment-preview">
                        <img src="" class="preview-thumb" id="preview-img">
                        <span style="font-size:0.8rem; color:var(--text-muted); flex:1;">Image attached</span>
                        <i class="fas fa-times" style="cursor:pointer; color:var(--danger)" onclick="clearAttachment()"></i>
                    </div>

                    <div class="input-flex">
                        <div class="emoji-picker-container" id="emoji-picker">
                            <div style="padding:15px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                                <span style="font-weight:600; font-size:0.9rem;">Emoji Library</span>
                                <i class="fas fa-times" onclick="toggleEmojiPicker()" style="cursor:pointer; color:var(--text-muted);"></i>
                            </div>
                            <div class="emoji-grid" id="emoji-grid"></div>
                        </div>

                        <input type="file" id="file-input" accept="image/*" hidden onchange="handleFileSelect(this)">
                        
                        <button class="tool-btn" onclick="document.getElementById('file-input').click()" title="Attach File"><i class="fas fa-paperclip"></i></button>
                        <button class="tool-btn" onclick="toggleEmojiPicker()" title="Emojis"><i class="far fa-smile"></i></button>
                        
                        <textarea class="chat-input" id="msg-input" placeholder="Type a message..." rows="1" oninput="autoResize(this)"></textarea>
                        
                        <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Context Menu for Messages -->
    <div class="ctx-menu animate__animated animate__zoomIn" id="ctx-menu">
        <div class="ctx-item" onclick="copyMessage()"><i class="far fa-copy"></i> Copy Text</div>
        <div class="ctx-item" onclick="deleteMessage()" style="color:var(--danger);"><i class="far fa-trash-alt"></i> Delete Message</div>
    </div>

    <!-- Upgrade / Lock Modal -->
    <div class="upgrade-modal-overlay" id="upgrade-modal">
        <div class="upgrade-modal">
            <div class="modal-icon-lock"><i class="fas fa-lock"></i></div>
            <h3 class="modal-title" id="modal-title">Access Locked</h3>
            <p class="modal-desc" id="modal-desc">
                This feature requires a higher tier plan. Upgrade now to unlock exclusive access.
            </p>
            <button class="btn-upgrade" onclick="location.href='seeker-premium.html'">Upgrade Now</button>
            <button class="btn-close-modal" onclick="closeUpgradeModal()">I'll stay on my current plan</button>
        </div>
    </div>

    <!-- PWA INSTALL POPUP -->
    <div id="pwa-install-popup" class="pwa-install-popup">
        <div class="pwa-content">
            <div class="pwa-icon"><i class="fas fa-download"></i></div>
            <div>
                <div style="font-weight:700; color:#fff; font-size:1rem; margin-bottom:4px;">Install App</div>
                <div style="font-size:0.8rem; color:#94A3B8;">Add to home screen for quick access.</div>
            </div>
        </div>
        <div class="pwa-actions">
            <button class="btn-pwa-install" onclick="installPWA()">Install</button>
            <button class="btn-pwa-dismiss" onclick="dismissPWA()">Later</button>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, addDoc, onSnapshot, serverTimestamp, updateDoc, deleteDoc, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCE_C6R4EyV7hip1yYrOaTzYac9Wrwh5Ys", authDomain: "eastlink-web.firebaseapp.com", projectId: "eastlink-web" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let currentUser = null;
        let userTier = 'Free'; // Default
        let allThreads = [];
        let activeThreadId = null;
        let activeThreadData = null;
        let msgUnsub = null;
        let userCache = {}; 
        let isSelectMode = false;
        let selectedThreads = new Set();
        let currentFilter = 'all';
        let currentAttachment = null;
        let contextMessageId = null;
        let contextMessageText = null;

        const emojiLibrary = ["ðŸ˜€","ðŸ˜ƒ","ðŸ˜„","ðŸ˜","ðŸ˜†","ðŸ˜…","ðŸ˜‚","ðŸ¤£","ðŸ˜Š","ðŸ˜‡","ðŸ™‚","ðŸ˜‰","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ˜Ž","â¤ï¸","ðŸ”¥","ðŸ‘","ðŸ‘Ž","ðŸ’¼","ðŸ¤","ðŸ’°","ðŸ“„","ðŸ™","ðŸŽ‰","ðŸ‘€","ðŸš€","ðŸ’¯"];

        // --- AUTH & INIT ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) { window.location.href = 'signin.html'; return; }
            currentUser = user;
            
            // 1. Initialize Profile
            initProfile(user);
            
            // 2. Check Tier & Apply Locks
            await checkUserTier(user.uid);
            
            // 3. Load Data
            listenForBadges(user.uid);
            loadThreads();
            initEmojiPicker();
        });

        // --- TIER LOGIC & ACCESS LOCKING ---
        async function checkUserTier(uid) {
            try {
                const docSnap = await getDoc(doc(db, "users", uid));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    userTier = data.tier || 'Free'; // Default to Free
                }
            } catch (error) {
                console.error("Error fetching tier:", error);
            }
            updateUIForTier();
        }

        function updateUIForTier() {
            // Sidebar Locking Logic
            // Reset all first
            const links = ['nav-featured', 'nav-urgent', 'nav-guaranteed', 'nav-resources', 'nav-referrals', 'nav-invest'];
            links.forEach(id => unlockLink(id));

            if (userTier === 'Free') {
                // Free Plan (Passive Observer): Lock everything except basic search
                lockLink('nav-featured', 'Standard', 'Featured Jobs are locked.', 'Upgrade to Standard to view and apply to verified, active roles.');
                lockLink('nav-urgent', 'Pro', 'Urgent Roles are locked.', 'These roles require immediate placement. Upgrade to Pro.');
                lockLink('nav-guaranteed', 'Pro', 'Exclusive Access Only.', 'Guaranteed jobs are reserved for Executive Pro members.');
                lockLink('nav-referrals', 'Standard', 'Referral Program Locked.', 'Unlock the ability to earn by referring friends.');
                lockLink('nav-invest', 'Standard', 'Investment Access Locked.', 'Crowdfunding opportunities are for paying members only.');
                lockLink('nav-resources', 'Pro', 'Premium Resources.', 'Executive guides and salary insights are Pro-only.');
            } 
            else if (userTier === 'Standard') {
                // Standard Plan (Casual Seeker): Access to Featured, but locked from Urgent/Pro
                // (Featured is implicitly unlocked by reset)
                lockLink('nav-urgent', 'Pro', 'Urgent Hiring Mode.', 'These roles require <7 day placement. Priority application needed.');
                lockLink('nav-guaranteed', 'Pro', 'Executive Search Only.', 'Retained searches and guaranteed interview loops are for Pro members.');
                lockLink('nav-resources', 'Pro', 'Advanced Insights.', 'Deep market analysis is locked.');
            }
            // Pro Plan: No locks applied
        }

        function lockLink(elementId, requiredTier, title, desc) {
            const el = document.getElementById(elementId);
            if (!el) return;
            
            el.classList.add('locked');
            el.onclick = (e) => {
                e.preventDefault();
                showUpgradeModal(title, desc);
            };
        }

        function unlockLink(elementId) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.classList.remove('locked');
            el.onclick = null; // Remove interception
        }

        window.showUpgradeModal = (title, desc) => {
            document.getElementById('modal-title').innerText = title || "Access Restricted";
            document.getElementById('modal-desc').innerText = desc || "Upgrade your plan to unlock this feature.";
            document.getElementById('upgrade-modal').style.display = 'grid';
        };

        window.closeUpgradeModal = () => {
            document.getElementById('upgrade-modal').style.display = 'none';
        };

        // --- PROFILE IMAGE LOADER ---
        async function initProfile(user) {
            const img = document.getElementById('header-avatar-img');
            const fb = document.getElementById('header-avatar-fallback');
            let photoUrl = user.photoURL;

            try {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    photoUrl = data.photoURL || data.profilePic || data.avatar || user.photoURL;
                }
            } catch (e) { console.error(e); }

            if (photoUrl) {
                img.src = photoUrl; img.style.display = 'block'; fb.style.display = 'none';
                img.onerror = function() { this.style.display = 'none'; fb.style.display = 'grid'; fb.innerText = (user.displayName || 'U').charAt(0).toUpperCase(); };
            } else {
                img.style.display = 'none'; fb.style.display = 'grid'; fb.innerText = (user.displayName || 'U').charAt(0).toUpperCase();
            }
        }

        // --- 1. THREADS LOGIC ---
        function loadThreads() {
            try {
                const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid));
                onSnapshot(q, (snap) => {
                    const raw = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    processThreads(raw);
                }, (err) => {
                    console.error("Thread Error:", err);
                    document.getElementById('thread-list').innerHTML = `<div style="padding:20px; text-align:center; color:var(--danger)">Unable to load chats.</div>`;
                });
            } catch (err) { console.error(err); }
        }

        async function processThreads(chats) {
            allThreads = [];
            if(chats.length === 0) { renderThreads(); return; }

            const promises = chats.map(async (chat) => {
                let pid = chat.participants ? chat.participants.find(uid => uid !== currentUser.uid) : null;
                let name = "Unknown User";
                let pic = "";

                if (pid) {
                    if (userCache[pid]) {
                        name = userCache[pid].name;
                        pic = userCache[pid].pic;
                    } else {
                        try {
                            const uSnap = await getDoc(doc(db, "users", pid));
                            if (uSnap.exists()) {
                                const d = uSnap.data();
                                name = d.companyName || d.fullName || "User";
                                pic = d.photoURL || d.profilePic || "";
                                userCache[pid] = { name, pic };
                            }
                        } catch(e) {}
                    }
                }
                
                const isUnread = !chat.isRead && chat.lastSenderId !== currentUser.uid;
                const badge = isUnread ? (chat.unreadCount || 1) : 0;
                const isPinned = chat.pinnedBy && chat.pinnedBy.includes(currentUser.uid);

                return {
                    ...chat,
                    pid, name, pic, badge, isPinned,
                    time: chat.lastUpdated ? chat.lastUpdated.seconds : 0
                };
            });

            allThreads = await Promise.all(promises);
            
            allThreads.sort((a,b) => {
                if (a.isPinned !== b.isPinned) return b.isPinned ? 1 : -1;
                return b.time - a.time;
            });
            renderThreads();
        }

        window.renderThreads = () => {
            const listEl = document.getElementById('thread-list');
            const search = document.getElementById('search-input').value.toLowerCase();
            listEl.innerHTML = "";

            const filtered = allThreads.filter(t => {
                const isArchived = t.archivedBy && t.archivedBy.includes(currentUser.uid);
                if (currentFilter === 'archived') {
                    if (!isArchived) return false;
                } else {
                    if (isArchived && search.length === 0) return false;
                }
                if(currentFilter === 'unread' && t.badge === 0) return false;
                if(currentFilter === 'pinned' && !t.isPinned) return false;
                
                const matchName = t.name.toLowerCase().includes(search);
                const matchMsg = t.lastMessage && t.lastMessage.toLowerCase().includes(search);
                return matchName || matchMsg;
            });

            if(filtered.length === 0) {
                listEl.innerHTML = `<div style="text-align:center; padding:30px; color:var(--text-muted); font-size:0.9rem;">No conversations found.</div>`;
                return;
            }

            filtered.forEach((t, index) => {
                const date = t.time ? new Date(t.time * 1000) : new Date();
                const timeStr = date.toLocaleDateString() === new Date().toLocaleDateString() 
                    ? date.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) 
                    : date.toLocaleDateString([],{month:'short',day:'numeric'});

                const div = document.createElement('div');
                div.className = `thread-item ${activeThreadId === t.id ? 'active' : ''} ${t.isPinned ? 'pinned' : ''} animate__animated animate__fadeInLeft`;
                div.style.animationDelay = `${index * 0.05}s`;
                div.style.animationDuration = '0.3s';
                
                const checkboxHtml = isSelectMode 
                    ? `<input type="checkbox" style="margin-right:12px; width:18px; height:18px; accent-color:var(--gold-base);" 
                       ${selectedThreads.has(t.id)?'checked':''} onclick="event.stopPropagation(); toggleSelectThread('${t.id}')">` 
                    : '';
                const badgeHtml = t.badge > 0 ? `<div class="unread-badge animate__animated animate__bounceIn">${t.badge}</div>` : '';

                div.innerHTML = `
                    ${checkboxHtml}
                    <div class="t-avatar-box">
                        <img src="${t.pic || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzMzMyI+PGc+PHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00czLTEuNzktNC00LTRzLTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvZz48L3N2Zz4='}" class="t-avatar">
                    </div>
                    <div class="t-info">
                        <div class="t-top">
                            <div class="t-name">${t.name}</div>
                            <div class="t-time">${timeStr}</div>
                        </div>
                        <div class="t-btm">
                            <div class="t-msg ${t.badge > 0 ?'unread':''}">${t.lastSenderId === currentUser.uid ? 'You: ' : ''}${t.lastMessage}</div>
                            <div class="badges-container">
                                <i class="fas fa-thumbtack pin-icon"></i>
                                ${badgeHtml}
                            </div>
                        </div>
                    </div>
                `;
                div.onclick = () => isSelectMode ? toggleSelectThread(t.id) : openChat(t);
                listEl.appendChild(div);
            });
        };

        // --- 2. CHAT FUNCTIONS ---
        window.openChat = async (thread) => {
            if(activeThreadId === thread.id) return;
            activeThreadId = thread.id;
            activeThreadData = thread;

            document.body.classList.add('chat-active'); 
            document.getElementById('empty-state').style.display = 'none';
            
            const chatContainer = document.getElementById('active-chat-container');
            chatContainer.style.display = 'flex';
            chatContainer.classList.remove('animate__fadeIn');
            void chatContainer.offsetWidth;
            chatContainer.classList.add('animate__fadeIn');
            
            renderThreads(); 

            document.getElementById('header-name').innerText = thread.name;
            const chatAv = document.getElementById('header-avatar-chat');
            chatAv.src = thread.pic || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzMzMyI+PGc+PHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00czLTEuNzktNC00LTRzLTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvZz48L3N2Zz4=';

            if(thread.badge > 0) {
                const tIndex = allThreads.findIndex(t => t.id === thread.id);
                if(tIndex > -1) allThreads[tIndex].badge = 0;
                renderThreads();

                await updateDoc(doc(db, "chats", thread.id), { isRead: true, unreadCount: 0 });
            }

            loadMessages(thread.id);
        };

        function loadMessages(chatId) {
            if(msgUnsub) msgUnsub();
            const box = document.getElementById('messages-box');
            box.innerHTML = `<div style="text-align:center; margin-top:50px; color:var(--text-muted);"><i class="fas fa-circle-notch fa-spin"></i> Loading...</div>`;

            const q = query(collection(db, "messages"), where("chatId", "==", chatId), orderBy("timestamp", "asc"));

            msgUnsub = onSnapshot(q, (snap) => {
                box.innerHTML = "";
                
                if(snap.empty) {
                    box.innerHTML = `<div style="text-align:center; margin-top:50px; color:var(--text-muted); opacity:0.7;">No messages yet.<br>Start the conversation!</div>`;
                    return;
                }

                let lastDate = "";
                snap.forEach(d => {
                    const m = d.data();
                    const mid = d.id;
                    const isMe = m.senderId === currentUser.uid;
                    const dateObj = m.timestamp ? new Date(m.timestamp.seconds * 1000) : new Date();
                    const dateStr = dateObj.toLocaleDateString();

                    if(dateStr !== lastDate) {
                        let label = dateStr;
                        const today = new Date().toLocaleDateString();
                        const yesterday = new Date(Date.now() - 86400000).toLocaleDateString();
                        if(dateStr === today) label = "Today";
                        else if(dateStr === yesterday) label = "Yesterday";
                        box.innerHTML += `<div class="date-divider"><span class="date-span">${label}</span></div>`;
                        lastDate = dateStr;
                    }

                    const checkIcon = isMe 
                        ? (m.read ? '<i class="fas fa-check-double read-check read"></i>' : '<i class="fas fa-check read-check"></i>') 
                        : '';

                    let content = "";
                    if(m.image) content += `<img src="${m.image}" class="msg-img" onclick="window.open('${m.image}','_blank')">`;
                    if(m.text) content += `<div>${m.text}</div>`;

                    const row = document.createElement('div');
                    row.className = `msg-row ${isMe ? 'sent' : 'received'} animate__animated animate__fadeInUp`;
                    
                    const bubble = document.createElement('div');
                    bubble.className = 'msg-bubble';
                    bubble.innerHTML = `
                        ${content}
                        <div class="msg-meta">
                            ${dateObj.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} ${checkIcon}
                        </div>
                    `;
                    
                    bubble.oncontextmenu = (e) => showContextMenu(e, mid, m.text, isMe);
                    row.appendChild(bubble);
                    box.appendChild(row);
                });
                
                box.scrollTop = box.scrollHeight;
            }, (error) => {
                if (error.message.includes("index")) {
                     Toastify({ text: "Database Index Required", style: { background: "var(--danger)" } }).showToast();
                }
            });
        }

        // --- 3. SEND MESSAGES ---
        window.sendMessage = async () => {
            const inp = document.getElementById('msg-input');
            const txt = inp.value.trim();
            
            if ((!txt && !currentAttachment) || !activeThreadId) return;

            const payload = {
                chatId: activeThreadId,
                senderId: currentUser.uid,
                receiverId: activeThreadData.pid, 
                text: txt,
                image: currentAttachment || null,
                timestamp: serverTimestamp(),
                read: false
            };

            inp.value = ''; 
            inp.style.height = 'auto';
            clearAttachment();
            document.getElementById('emoji-picker').classList.remove('active');

            try {
                await addDoc(collection(db, "messages"), payload);

                await updateDoc(doc(db, "chats", activeThreadId), {
                    lastMessage: txt || 'Sent an attachment',
                    lastSenderId: currentUser.uid,
                    lastUpdated: serverTimestamp(),
                    isRead: false,
                    unreadCount: (activeThreadData.unreadCount || 0) + 1,
                    archivedBy: (activeThreadData.archivedBy || []).filter(id => id !== activeThreadData.pid) 
                });
            } catch (e) {
                Toastify({ text: "Failed to send", style: { background: "var(--danger)" } }).showToast();
            }
        };

        // --- 4. MANAGEMENT & UI ---
        
        window.togglePinCurrent = async () => {
            if(!activeThreadId) return;
            const ref = doc(db, "chats", activeThreadId);
            const isPinned = activeThreadData.isPinned;
            try {
                const snap = await getDoc(ref);
                let currentPins = snap.data().pinnedBy || [];
                
                if(isPinned) {
                    currentPins = currentPins.filter(uid => uid !== currentUser.uid);
                    Toastify({text: "Unpinned", style:{background:"var(--bg-card)"}}).showToast();
                } else {
                    currentPins.push(currentUser.uid);
                    Toastify({text: "Pinned", style:{background:"var(--gold-base)", color:"black"}}).showToast();
                }
                
                await updateDoc(ref, { pinnedBy: currentPins });
                document.getElementById('chat-dropdown').classList.remove('show');
            } catch(e) { console.error(e); }
        };

        window.markAsUnread = async () => {
            if(!activeThreadId) return;
            try {
                await updateDoc(doc(db, "chats", activeThreadId), {
                    isRead: false,
                    lastSenderId: activeThreadData.pid, 
                    unreadCount: 1
                });
                closeChat();
                Toastify({text: "Marked as Unread"}).showToast();
            } catch(e) { console.error(e); }
        };

        window.archiveChat = async () => {
            if(!activeThreadId) return;
            try {
                const ref = doc(db, "chats", activeThreadId);
                const snap = await getDoc(ref);
                let archives = snap.data().archivedBy || [];
                
                if(!archives.includes(currentUser.uid)) {
                    archives.push(currentUser.uid);
                    await updateDoc(ref, { archivedBy: archives });
                    Toastify({text: "Archived"}).showToast();
                    closeChat();
                }
            } catch(e) { console.error(e); }
        };

        window.toggleMute = async () => {
            if(!activeThreadId) return;
            try {
                const ref = doc(db, "chats", activeThreadId);
                const snap = await getDoc(ref);
                let mutes = snap.data().mutedBy || [];
                
                if(mutes.includes(currentUser.uid)) {
                    mutes = mutes.filter(u => u !== currentUser.uid);
                    Toastify({text: "Unmuted"}).showToast();
                } else {
                    mutes.push(currentUser.uid);
                    Toastify({text: "Muted"}).showToast();
                }
                await updateDoc(ref, { mutedBy: mutes });
                document.getElementById('chat-dropdown').classList.remove('show');
            } catch(e) { console.error(e); }
        };

        window.deleteCurrentChat = async () => {
            if(!activeThreadId || !confirm("Delete this conversation permanently?")) return;
            try {
                await deleteDoc(doc(db, "chats", activeThreadId));
                closeChat();
                Toastify({text: "Deleted", style:{background:"var(--danger)"}}).showToast();
            } catch(e) { console.error(e); }
        };

        window.showContextMenu = (e, msgId, text, isMe) => {
            e.preventDefault();
            contextMessageId = msgId;
            contextMessageText = text;
            const menu = document.getElementById('ctx-menu');
            menu.style.display = 'flex';
            menu.style.top = `${e.clientY}px`;
            if (e.clientX + 160 > window.innerWidth) menu.style.left = `${e.clientX - 160}px`;
            else menu.style.left = `${e.clientX}px`;
            
            const deleteBtn = menu.querySelector('.ctx-item:last-child');
            deleteBtn.style.display = isMe ? 'flex' : 'none';
        };

        window.copyMessage = () => {
            if(contextMessageText) {
                navigator.clipboard.writeText(contextMessageText);
                Toastify({text: "Copied", style:{background:"var(--bg-card)"}}).showToast();
            }
            hideContextMenu();
        };

        window.deleteMessage = async () => {
            if(contextMessageId && confirm("Delete this message?")) {
                try {
                    await deleteDoc(doc(db, "messages", contextMessageId));
                    Toastify({text: "Message deleted"}).showToast();
                } catch(e) { console.error(e); }
            }
            hideContextMenu();
        };

        function hideContextMenu() {
            document.getElementById('ctx-menu').style.display = 'none';
            contextMessageId = null;
        }

        window.closeChat = () => {
            document.body.classList.remove('chat-active'); 
            activeThreadId = null;
            if(msgUnsub) msgUnsub();
            renderThreads();
        };

        window.handleFileSelect = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentAttachment = e.target.result;
                    document.getElementById('preview-img').src = currentAttachment;
                    document.getElementById('attachment-preview').style.display = 'flex';
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.clearAttachment = () => {
            currentAttachment = null;
            document.getElementById('file-input').value = "";
            document.getElementById('attachment-preview').style.display = 'none';
        };

        window.autoResize = (el) => {
            el.style.height = 'auto';
            el.style.height = (el.scrollHeight) + 'px';
        };

        function initEmojiPicker() {
            const grid = document.getElementById('emoji-grid');
            if(!grid) return;
            grid.innerHTML = "";
            emojiLibrary.forEach(char => {
                const btn = document.createElement('div');
                btn.className = 'emoji-btn';
                btn.innerText = char;
                btn.onclick = () => insertEmoji(char);
                grid.appendChild(btn);
            });
        }
        window.toggleEmojiPicker = () => document.getElementById('emoji-picker').classList.toggle('active');
        window.insertEmoji = (char) => {
            const inp = document.getElementById('msg-input');
            inp.value += char;
            inp.focus();
        };

        window.toggleSelectMode = () => {
            isSelectMode = !isSelectMode;
            selectedThreads.clear();
            document.getElementById('bulk-actions').style.display = isSelectMode ? 'flex' : 'none';
            document.getElementById('select-count').innerText = "0";
            renderThreads();
        };
        window.toggleSelectThread = (id) => {
            if(selectedThreads.has(id)) selectedThreads.delete(id);
            else selectedThreads.add(id);
            document.getElementById('select-count').innerText = selectedThreads.size;
            renderThreads(); 
        };
        window.deleteBulk = async () => {
            if(!confirm(`Delete ${selectedThreads.size} conversations?`)) return;
            const batch = writeBatch(db);
            selectedThreads.forEach(id => batch.delete(doc(db, "chats", id)));
            await batch.commit();
            toggleSelectMode();
        };
        window.setFilter = (f, btn) => {
            currentFilter = f;
            document.querySelectorAll('.filter-chip').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            renderThreads();
        };

        window.onclick = (e) => {
            if(!e.target.closest('.icon-btn') && !e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
            }
            if(!e.target.closest('.tool-btn') && !e.target.closest('.emoji-picker-container')) {
                document.getElementById('emoji-picker').classList.remove('active');
            }
            if(!e.target.closest('.ctx-menu') && !e.target.closest('.msg-bubble')) {
                hideContextMenu();
            }
            if(e.target.id === 'upgrade-modal') closeUpgradeModal();
        };

        window.toggleSidebar = () => {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').style.display = document.getElementById('sidebar').classList.contains('active') ? 'block' : 'none';
        };
        window.closeSidebar = () => {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('overlay').style.display = 'none';
        };
        window.logout = () => signOut(auth).then(() => window.location.href = 'signin.html');
        
        function listenForBadges(uid) {
             onSnapshot(query(collection(db, "notifications"), where("userId", "==", uid), where("read", "==", false)), s => {
                const el = document.getElementById('notif-badge'); if(el){ el.innerText=s.size>9?'9+':s.size; el.style.display=s.empty?'none':'flex';}
            });
             onSnapshot(query(collection(db, "chats"), where("participants", "array-contains", uid)), s => {
                 let total = 0;
                 s.docs.forEach(d => { 
                     if(d.data().lastSenderId !== uid && d.data().unreadCount > 0) total += d.data().unreadCount; 
                 });
                 const el = document.getElementById('msg-badge'); if(el){ el.innerText=total>9?'9+':total; el.style.display=total===0?'none':'flex';}
            });
        }
        
        // --- PWA LOGIC ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('pwa-install-popup').style.display = 'block';
        });

        window.installPWA = async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                document.getElementById('pwa-install-popup').style.display = 'none';
            }
            deferredPrompt = null;
        };

        window.dismissPWA = () => {
            document.getElementById('pwa-install-popup').style.display = 'none';
        };

        if ("serviceWorker" in navigator) navigator.serviceWorker.register("./service-worker.js");
    </script>
</body>
</html>
