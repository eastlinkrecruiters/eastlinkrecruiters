<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Messages | EastLink Recruiters</title>
    
    <!-- PWA & Meta -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#020617">
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <style>
        :root {
            /* Theme Variables */
            --bg-body: #020617;       
            --bg-card: #0f172a; 
            --bg-glass: rgba(15, 23, 42, 0.95); 
            --bg-glass-heavy: rgba(15, 23, 42, 0.98);
            --bg-input: rgba(255, 255, 255, 0.05);
            --bg-hover: rgba(255, 255, 255, 0.08);
            --border-color: rgba(255, 255, 255, 0.12);
            --text-main: #F8FAFC;     
            --text-muted: #94A3B8; 
            --gold-base: #D97706;
            --gold-gradient: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            --success: #10B981;
            --danger: #EF4444;
            --neon-purple: #8b5cf6;
            
            --sidebar-width: 260px; 
            --thread-list-width: 340px;
            --header-height: 65px;
            --radius: 12px;
            --font-head: 'Cinzel', serif;
            --font-body: 'Inter', sans-serif;
            --font-display: 'Space Grotesk', sans-serif;
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: var(--font-body); 
            background-color: var(--bg-body); 
            background-image: url('assets/images/background.png'); 
            background-size: cover;
            background-attachment: fixed;
            color: var(--text-main); 
            height: 100vh; width: 100vw;
            overflow: hidden; 
            display: flex; flex-direction: column;
        }

        /* --- HEADER (Master Template) --- */
        header {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height);
            background: var(--bg-glass-heavy); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 1000;
        }

        .logo { font-family: var(--font-head); font-weight: 700; color: var(--text-main); font-size: 1.2rem; text-decoration: none; display:flex; flex-direction: column; line-height: 1; }
        .logo span { color: var(--gold-base); }
        .logo small { font-size: 0.6em; color: var(--text-muted); font-family: var(--font-body); letter-spacing: 1px; margin-top: 3px; font-weight: 400; opacity: 0.8; }
        
        .icon-btn { 
            width: 38px; height: 38px; display: grid; place-items: center; border-radius: 50%;
            color: var(--text-muted); cursor: pointer; transition: 0.2s; position: relative;
        }
        .icon-btn:hover { background: var(--bg-hover); color: var(--text-main); }
        
        .badge { 
            position: absolute; top: -3px; right: -3px; 
            background: var(--danger); color: white;
            font-size: 0.65rem; font-weight: 700;
            min-width: 16px; height: 16px; 
            border-radius: 50%; 
            display: none; align-items: center; justify-content: center;
            border: 2px solid var(--bg-card);
            z-index: 10;
        }

        /* --- SIDEBAR (Master Template) --- */
        .sidebar {
            position: fixed; top: var(--header-height); left: 0; width: var(--sidebar-width); height: calc(100vh - var(--header-height));
            background: var(--bg-glass-heavy); border-right: 1px solid var(--border-color); padding: 20px 0; 
            overflow-y: auto; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 999;
            display: flex; flex-direction: column;
        }
        .nav-group-label { font-size: 0.7rem; text-transform: uppercase; color: var(--gold-base); font-weight: 700; padding: 0 24px; margin-bottom: 8px; letter-spacing: 1px; margin-top: 20px; }
        .nav-item { 
            display: flex; align-items: center; padding: 12px 24px; color: var(--text-muted); text-decoration: none; 
            font-size: 0.9rem; transition: 0.2s; border-left: 3px solid transparent; position: relative;
        }
        .nav-item:hover { color: var(--text-main); background: var(--bg-hover); }
        .nav-item.active { color: var(--gold-base); font-weight: 600; border-left-color: var(--gold-base); background: linear-gradient(90deg, rgba(217,119,6,0.1), transparent); }
        .nav-item i { width: 25px; margin-right: 10px; text-align: center; }
        
        .nav-badge-count { 
            background: var(--danger); color: #fff; font-size: 0.7rem; padding: 1px 6px; 
            border-radius: 10px; margin-left: auto; font-weight: 600; display: none;
        }
        .nav-lock-icon { margin-left: auto; font-size: 0.8rem; opacity: 0.5; }
        .nav-item.locked { opacity: 0.5; cursor: not-allowed; pointer-events: none; filter: grayscale(1); }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index:998; display:none; backdrop-filter:blur(3px); }

        /* --- MAIN LAYOUT (Chat Specific) --- */
        main { 
            margin-left: var(--sidebar-width); margin-top: var(--header-height); 
            height: calc(100vh - var(--header-height)); width: calc(100% - var(--sidebar-width)); 
            display: flex; overflow: hidden; position: relative;
            background: rgba(15, 23, 42, 0.5); /* Slight tint for chat background */
        }

        /* --- THREAD LIST PANE --- */
        .thread-sidebar {
            width: var(--thread-list-width); height: 100%;
            background: var(--bg-glass); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; z-index: 50; flex-shrink: 0;
            backdrop-filter: blur(15px);
        }
        .thread-header { padding: 20px 15px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        
        .search-wrapper { position: relative; margin-bottom: 15px; }
        .search-input {
            width: 100%; background: var(--bg-input); border: 1px solid var(--border-color);
            padding: 10px 35px 10px 15px; border-radius: 12px; color: var(--text-main); font-size: 0.9rem;
        }
        .search-icon { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.9rem; }

        .filter-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .filter-chip { 
            white-space: nowrap; padding: 6px 14px; border-radius: 20px; font-size: 0.75rem; 
            background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-muted); cursor: pointer; transition: 0.2s;
        }
        .filter-chip:hover { background: var(--bg-hover); }
        .filter-chip.active { background: var(--gold-gradient); color: #0F172A; border-color: transparent; font-weight: 700; }

        .thread-list { flex: 1; overflow-y: auto; padding: 10px 0; }
        .thread-item {
            display: flex; align-items: center; padding: 16px 20px; cursor: pointer; transition: all 0.2s;
            border-left: 3px solid transparent; position: relative; margin-bottom: 2px;
        }
        .thread-item:hover { background: var(--bg-hover); }
        .thread-item.active { background: rgba(217, 119, 6, 0.15); border-left-color: var(--gold-base); }
        .thread-item.pinned { background: rgba(139, 92, 246, 0.08); }
        
        .t-avatar-box { position: relative; margin-right: 15px; flex-shrink: 0; }
        .t-avatar { width: 48px; height: 48px; border-radius: 12px; background: var(--bg-input); display: grid; place-items: center; font-weight: 700; color: var(--gold-base); border: 1px solid var(--border-color); object-fit: cover; }
        
        .t-info { flex: 1; min-width: 0; }
        .t-top { display: flex; justify-content: space-between; margin-bottom: 4px; align-items: center; }
        .t-name { font-weight: 600; color: var(--text-main); font-size: 0.95rem; }
        .t-time { font-size: 0.75rem; color: var(--text-muted); font-weight: 500; }
        .t-btm { display: flex; justify-content: space-between; align-items: center; }
        .t-msg { color: var(--text-muted); font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80%; }
        .t-msg.unread { color: var(--text-main); font-weight: 600; }
        
        .badges-container { display: flex; gap: 5px; align-items: center; }
        .unread-badge { background: var(--danger); color: #fff; font-size: 0.65rem; font-weight: 700; padding: 2px 6px; border-radius: 10px; min-width: 18px; text-align: center; }
        .pin-icon { color: var(--neon-purple); font-size: 0.7rem; transform: rotate(45deg); display: none; }
        .thread-item.pinned .pin-icon { display: block; }

        /* --- CHAT AREA --- */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: transparent; position: relative; overflow: hidden; }

        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); text-align: center; animation: fadeIn 0.5s ease; }
        .empty-icon { font-size: 3rem; margin-bottom: 20px; color: var(--gold-base); opacity: 0.5; }

        .chat-header {
            height: 75px; background: var(--bg-glass-heavy); border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; padding: 0 24px; flex-shrink: 0;
            backdrop-filter: blur(15px);
        }
        .ch-user { display: flex; align-items: center; gap: 12px; }
        .ch-avatar { width: 42px; height: 42px; border-radius: 12px; background: var(--bg-input); color: var(--text-muted); font-weight: 700; display: grid; place-items: center; object-fit: cover; border: 1px solid var(--border-color); }
        .mobile-back { display: none; font-size: 1.2rem; margin-right: 15px; color: var(--text-muted); cursor: pointer; }

        .messages-container { 
            flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; 
            background-image: radial-gradient(circle at center, rgba(217,119,6,0.03) 0%, transparent 70%);
        }
        
        .date-divider { text-align: center; margin: 20px 0; font-size: 0.75rem; color: var(--text-muted); position: relative; }
        .date-divider::before { content: ''; position: absolute; left: 0; top: 50%; width: 100%; height: 1px; background: var(--border-color); z-index: -1; }
        .date-span { background: var(--bg-card); padding: 4px 12px; border-radius: 12px; border: 1px solid var(--border-color); font-weight: 500; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; }

        .msg-row { display: flex; flex-direction: column; max-width: 75%; position: relative; margin-bottom: 5px; group; }
        .msg-row.sent { align-self: flex-end; align-items: flex-end; }
        .msg-row.received { align-self: flex-start; align-items: flex-start; }

        .msg-bubble { 
            padding: 12px 18px; border-radius: 18px; font-size: 0.95rem; line-height: 1.5; 
            position: relative; word-wrap: break-word; box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer;
            backdrop-filter: blur(5px);
        }
        .msg-row.sent .msg-bubble { background: var(--gold-gradient); color: #0F172A; border-bottom-right-radius: 4px; font-weight: 600; }
        .msg-row.received .msg-bubble { background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border-color); border-bottom-left-radius: 4px; }
        
        .msg-img { max-width: 250px; border-radius: 12px; margin-bottom: 8px; border: 1px solid var(--border-color); display: block; }
        .msg-meta { font-size: 0.7rem; margin-top: 5px; color: var(--text-muted); opacity: 0.9; display: flex; align-items: center; gap: 5px; font-family: var(--font-display); font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .msg-row.sent .msg-meta { justify-content: flex-end; }
        .read-check.read { color: var(--neon-purple); }

        /* INPUT AREA */
        .input-zone {
            background: var(--bg-glass-heavy); border-top: 1px solid var(--border-color);
            padding: 20px; padding-bottom: calc(20px + var(--safe-bottom));
            display: flex; flex-direction: column; gap: 12px; flex-shrink: 0; z-index: 20;
            backdrop-filter: blur(20px);
        }
        .preview-area { display: none; align-items: center; gap: 12px; padding: 12px; background: var(--bg-input); border-radius: 12px; border: 1px solid var(--border-color); animation: fadeIn 0.3s; }
        .preview-thumb { height: 50px; border-radius: 8px; border: 1px solid var(--border-color); }
        .input-flex { display: flex; align-items: flex-end; gap: 12px; position: relative; }
        
        .tool-btn { width: 44px; height: 44px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-muted); cursor: pointer; display: grid; place-items: center; flex-shrink: 0; transition: 0.2s; }
        .tool-btn:hover { background: var(--bg-hover); color: var(--gold-base); }
        .chat-input { flex: 1; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 14px; padding: 12px 16px; color: var(--text-main); font-family: var(--font-body); font-size: 0.95rem; resize: none; min-height: 44px; max-height: 120px; }
        .send-btn { width: 44px; height: 44px; border-radius: 12px; background: var(--gold-gradient); border: none; color: #0F172A; font-size: 1.1rem; cursor: pointer; display: grid; place-items: center; transition: 0.2s; }
        .send-btn:hover { transform: scale(1.05); }

        /* DROPDOWNS & MENUS */
        .dropdown { position: absolute; top: 110%; right: 0; width: 220px; background: var(--bg-glass-heavy); border: 1px solid var(--border-color); border-radius: 12px; display: none; flex-direction: column; z-index: 1000; backdrop-filter: blur(20px); }
        .dropdown.show { display: flex; }
        .dd-item { padding: 14px 20px; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 12px; color: var(--text-muted); border-bottom: 1px solid rgba(255,255,255,0.03); transition: 0.2s; }
        .dd-item:hover { background: var(--bg-hover); color: var(--text-main); }
        .dd-item.danger { color: var(--danger); }
        
        .emoji-picker-container { position: absolute; bottom: 80px; left: 0; width: 100%; max-width: 350px; height: 280px; background: var(--bg-glass-heavy); border: 1px solid var(--border-color); border-radius: 16px; display: none; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.6); z-index: 100; backdrop-filter: blur(25px); }
        .emoji-picker-container.active { display: flex; }
        .emoji-grid { flex: 1; overflow-y: auto; padding: 12px; display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
        .emoji-btn { font-size: 1.4rem; cursor: pointer; border-radius: 8px; display: grid; place-items: center; height: 40px; transition: 0.2s; }
        .emoji-btn:hover { background: var(--bg-hover); }

        .ctx-menu { position: fixed; background: var(--bg-glass-heavy); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); z-index: 2000; display: none; flex-direction: column; min-width: 160px; backdrop-filter: blur(10px); }
        .ctx-item { padding: 10px 15px; font-size: 0.85rem; color: var(--text-main); cursor: pointer; display: flex; gap: 10px; align-items: center; }
        .ctx-item:hover { background: var(--bg-hover); }

        /* PWA Popup */
        .pwa-install-popup {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px); border: 1px solid var(--gold-base);
            border-radius: 20px; padding: 20px; z-index: 3000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: none;
            animation: slideUp 0.5s ease;
        }
        @keyframes slideUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        .pwa-content { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .pwa-icon { width: 50px; height: 50px; border-radius: 12px; background: var(--gold-gradient); display: grid; place-items: center; font-size: 1.5rem; color: #000; }
        .pwa-actions { display: flex; gap: 10px; }
        .btn-pwa-install { flex: 2; padding: 10px; background: var(--gold-gradient); border: none; border-radius: 10px; font-weight: 700; cursor: pointer; color: #000; }
        .btn-pwa-dismiss { flex: 1; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-muted); cursor: pointer; }

        @media(max-width: 992px) {
            .sidebar { transform: translateX(-100%); } .sidebar.active { transform: translateX(0); }
            main { margin-left: 0; width: 100%; display: block; }
            
            /* Logic: Show Sidebar by default, Hide Chat. Flip when active. */
            .thread-sidebar { width: 100%; height: 100%; display: flex; }
            .chat-area { width: 100%; height: 100%; display: none; }
            
            /* When chat is active */
            body.chat-active .thread-sidebar { display: none; }
            body.chat-active .chat-area { display: flex; }
            
            .mobile-back { display: block; }
            .empty-state { display: none; }
        }
    </style>
</head>
<body>

    <!-- OVERLAY -->
    <div class="overlay" id="overlay" onclick="closeSidebar()"></div>

    <!-- HEADER -->
    <header>
        <div style="display:flex; align-items:center; gap:15px;">
            <i class="fas fa-bars" style="font-size:1.2rem; color:var(--text-muted); cursor:pointer; display:block; @media(min-width:993px){display:none;}" onclick="toggleSidebar()"></i>
            <a href="employer-dashboard.html" class="logo">
                <span>EastLink</span>
                <small>PARTNER</small>
            </a>
        </div>
        <div style="display:flex; align-items:center; gap:12px;">
            <!-- Notifications with Badge -->
            <div class="icon-btn" onclick="location.href='employer-notifications.html'">
                <i class="fa-regular fa-bell"></i>
                <div class="badge" id="header-notif-badge"></div>
            </div>

            <!-- Messages with Badge -->
            <div class="icon-btn" onclick="location.href='employer-messages.html'" style="background: var(--bg-hover); color: var(--gold-base);">
                <i class="fa-regular fa-comment-dots"></i>
                <div class="badge" id="header-msg-badge"></div>
            </div>

            <!-- Avatar -->
            <div onclick="location.href='employer-profile.html'" id="header-avatar" style="width:34px; height:34px; background:var(--gold-gradient); border-radius:50%; display:grid; place-items:center; color:white; font-size:0.9rem; font-weight:bold; cursor:pointer; overflow:hidden; border:1px solid var(--border-color);">
                <i class="fas fa-building"></i>
            </div>
        </div>
    </header>

    <!-- SIDEBAR NAVIGATION -->
    <nav class="sidebar" id="sidebar">
        <div class="nav-group-label">Overview</div>
        <a href="employer-dashboard.html" class="nav-item"><i class="fas fa-th-large"></i> Dashboard</a>
        <a href="employer-post-job.html" class="nav-item"><i class="fas fa-plus-circle"></i> Post a job ad</a>
        <a href="employer-jobs.html" class="nav-item"><i class="fas fa-briefcase"></i> My jobs</a>
        
        <div class="nav-group-label">Candidates & Comms</div>
        <a href="employer-candidates.html" class="nav-item">
            <i class="fas fa-users"></i> Manage applicants 
            <span class="nav-badge-count" id="nav-badge-candidates">0</span>
        </a>
        <a href="employer-messages.html" class="nav-item active">
            <i class="fas fa-comment-alt"></i> Messages 
            <span class="nav-badge-count" id="nav-badge-messages">0</span>
        </a>

        <div class="nav-group-label">Organization</div>
        <a href="employer-profile.html" class="nav-item"><i class="fas fa-building"></i> Company profile</a>
        <a href="employer-wallet.html" class="nav-item"><i class="fas fa-wallet"></i> My wallet</a>
        <a href="employer-premium.html" class="nav-item"><i class="fas fa-crown"></i> My plan</a>

        <div class="nav-group-label">Growth</div>
        <a href="employer-referrals.html" class="nav-item" id="nav-invite">
            <i class="fas fa-share-nodes"></i> Invite and earn
            <i class="fas fa-lock nav-lock-icon" id="lock-invite" style="display:none;"></i>
        </a>
        <a href="employer-investment.html" class="nav-item" id="nav-invest">
            <i class="fas fa-chart-line"></i> Invest
            <i class="fas fa-lock nav-lock-icon" id="lock-invest" style="display:none;"></i>
        </a>

        <div class="nav-group-label">Resources</div>
        <a href="employer-blogs.html" class="nav-item"><i class="fas fa-newspaper"></i> News and insights</a>
        <a href="employer-resources.html" class="nav-item" id="nav-resources">
            <i class="fas fa-book"></i> Resources
            <i class="fas fa-lock nav-lock-icon" id="lock-resources" style="display:none;"></i>
        </a>

        <div class="nav-group-label">Account</div>
        <a href="employer-profile.html" class="nav-item"><i class="fas fa-user"></i> My profile</a>
        <a href="employer-settings.html" class="nav-item"><i class="fas fa-cog"></i> Settings</a>
        
        <div style="margin-top:auto; padding:20px 24px;">
            <a href="#" onclick="logout()" style="color:var(--danger); text-decoration:none; font-size:0.9rem; display:flex; align-items:center;"><i class="fa-solid fa-right-from-bracket" style="margin-right:10px;"></i> Signout</a>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main>
        <!-- THREAD LIST PANE -->
        <aside class="thread-sidebar">
            <div class="thread-header">
                <div class="search-wrapper">
                    <input type="text" id="search-input" class="search-input" placeholder="Search conversations..." onkeyup="renderThreads()">
                    <i class="fas fa-search search-icon"></i>
                </div>
                
                <div class="filter-row">
                    <div class="filter-chip active" onclick="setFilter('all', this)">All</div>
                    <div class="filter-chip" onclick="setFilter('unread', this)">Unread</div>
                    <div class="filter-chip" onclick="setFilter('pinned', this)"><i class="fas fa-thumbtack" style="font-size:0.7rem; margin-right:4px;"></i> Pinned</div>
                    <div class="filter-chip" onclick="setFilter('archived', this)">Archived</div>
                </div>

                <div id="bulk-actions" style="display:none; align-items:center; justify-content:space-between; margin-top:10px; padding-top:10px; border-top:1px solid var(--border-color);">
                    <span style="font-size:0.8rem; color:var(--text-muted);"><span id="select-count">0</span> selected</span>
                    <div style="display:flex; gap:10px;">
                        <button onclick="deleteBulk()" style="color:var(--danger); background:none; border:none; cursor:pointer; font-weight:600; font-size:0.8rem;">Delete</button>
                        <button onclick="toggleSelectMode()" style="color:var(--text-muted); background:none; border:none; cursor:pointer; font-size:0.8rem;">Cancel</button>
                    </div>
                </div>
            </div>

            <div class="thread-list" id="thread-list">
                <div style="padding:40px; text-align:center; color:var(--text-muted);">
                    <i class="fas fa-circle-notch fa-spin" style="color:var(--gold-base);"></i> Loading chats...
                </div>
            </div>
        </aside>

        <!-- CHAT AREA -->
        <section class="chat-area" id="chat-ui">
            
            <div class="empty-state" id="empty-state">
                <i class="far fa-comments empty-icon animate__animated animate__rubberBand"></i>
                <h2 style="font-family:var(--font-head); margin-bottom:10px; color:var(--text-main);">Employer Messages</h2>
                <p>Select a candidate to start messaging.</p>
                <button onclick="toggleSelectMode()" style="margin-top:20px; padding:10px 20px; border:1px solid var(--border-color); background:transparent; color:var(--text-main); border-radius:30px; cursor:pointer; transition:0.3s; font-size:0.9rem;">
                    <i class="fas fa-tasks" style="margin-right:8px; color:var(--gold-base);"></i> Manage Chats
                </button>
            </div>

            <!-- Active Chat -->
            <div id="active-chat-container" style="display:none; flex-direction:column; height:100%; width:100%;">
                
                <div class="chat-header">
                    <div style="display:flex; align-items:center;">
                        <i class="fas fa-chevron-left mobile-back" onclick="closeChat()"></i>
                        <div class="ch-user">
                            <img src="" class="ch-avatar" id="header-avatar-chat">
                            <div>
                                <h3 style="font-size:1rem; font-weight:600; color:var(--text-main);" id="header-name">Candidate</h3>
                                <div style="font-size:0.75rem; color:var(--text-muted);" id="header-status">
                                    Applicant
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="position:relative;">
                        <button class="icon-btn" onclick="document.getElementById('chat-dropdown').classList.toggle('show')"><i class="fas fa-ellipsis-vertical"></i></button>
                        <div class="dropdown animate__animated animate__zoomIn" id="chat-dropdown">
                            <div class="dd-item" onclick="togglePinCurrent()"><i class="fas fa-thumbtack"></i> Pin Chat</div>
                            <div class="dd-item" onclick="markAsUnread()"><i class="fas fa-envelope"></i> Mark Unread</div>
                            <div class="dd-item" onclick="toggleMute()"><i class="fas fa-bell-slash"></i> Mute Notifications</div>
                            <div class="dd-item" onclick="archiveChat()"><i class="fas fa-archive"></i> Archive Chat</div>
                            <div class="dd-item danger" onclick="deleteCurrentChat()"><i class="fas fa-trash-alt"></i> Delete Conversation</div>
                        </div>
                    </div>
                </div>

                <div class="messages-container" id="messages-box"></div>

                <!-- Input Zone -->
                <div class="input-zone">
                    <div class="preview-area" id="attachment-preview">
                        <img src="" class="preview-thumb" id="preview-img">
                        <span style="font-size:0.8rem; color:var(--text-muted); flex:1;">Image attached</span>
                        <i class="fas fa-times" style="cursor:pointer; color:var(--danger)" onclick="clearAttachment()"></i>
                    </div>

                    <div class="input-flex">
                        <div class="emoji-picker-container" id="emoji-picker">
                            <div style="padding:15px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                                <span style="font-weight:600; font-size:0.9rem;">Emoji Library</span>
                                <i class="fas fa-times" onclick="toggleEmojiPicker()" style="cursor:pointer; color:var(--text-muted);"></i>
                            </div>
                            <div class="emoji-grid" id="emoji-grid"></div>
                        </div>

                        <input type="file" id="file-input" accept="image/*" hidden onchange="handleFileSelect(this)">
                        
                        <button class="tool-btn" onclick="document.getElementById('file-input').click()" title="Attach File"><i class="fas fa-paperclip"></i></button>
                        <button class="tool-btn" onclick="toggleEmojiPicker()" title="Emojis"><i class="far fa-smile"></i></button>
                        
                        <textarea class="chat-input" id="msg-input" placeholder="Type a message..." rows="1" oninput="autoResize(this)"></textarea>
                        
                        <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Context Menu for Messages -->
    <div class="ctx-menu animate__animated animate__zoomIn" id="ctx-menu">
        <div class="ctx-item" onclick="copyMessage()"><i class="far fa-copy"></i> Copy Text</div>
        <div class="ctx-item" onclick="deleteMessage()" style="color:var(--danger);"><i class="far fa-trash-alt"></i> Delete Message</div>
    </div>

    <!-- PWA INSTALL POPUP -->
    <div id="pwa-install-popup" class="pwa-install-popup">
        <div class="pwa-content">
            <div class="pwa-icon"><i class="fas fa-download"></i></div>
            <div>
                <div style="font-weight:700; color:#fff; font-size:1rem; margin-bottom:4px;">Install App</div>
                <div style="font-size:0.8rem; color:#94A3B8;">Add EastLink to home screen.</div>
            </div>
        </div>
        <div class="pwa-actions">
            <button class="btn-pwa-install" onclick="installPWA()">Install</button>
            <button class="btn-pwa-dismiss" onclick="dismissPWA()">Later</button>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, addDoc, onSnapshot, serverTimestamp, updateDoc, deleteDoc, orderBy, writeBatch, getCountFromServer } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCE_C6R4EyV7hip1yYrOaTzYac9Wrwh5Ys", authDomain: "eastlink-web.firebaseapp.com", projectId: "eastlink-web" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let currentUser = null;
        let allThreads = [];
        let activeThreadId = null;
        let activeThreadData = null;
        let msgUnsub = null;
        let userCache = {}; 
        let isSelectMode = false;
        let selectedThreads = new Set();
        let currentFilter = 'all';
        let currentAttachment = null;
        let contextMessageId = null;
        let contextMessageText = null;

        const emojiLibrary = ["ðŸ˜€","ðŸ˜ƒ","ðŸ˜„","ðŸ˜","ðŸ˜†","ðŸ˜…","ðŸ˜‚","ðŸ¤£","ðŸ˜Š","ðŸ˜‡","ðŸ™‚","ðŸ˜‰","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ˜Ž","â¤ï¸","ðŸ”¥","ðŸ‘","ðŸ‘Ž","ðŸ’¼","ðŸ¤","ðŸ’°","ðŸ“„","ðŸ™","ðŸŽ‰","ðŸ‘€","ðŸš€","ðŸ’¯"];

        // --- UI HELPERS (Global) ---
        window.toggleSidebar = () => {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('active');
            document.getElementById('overlay').style.display = sb.classList.contains('active') ? 'block' : 'none';
        };
        window.closeSidebar = () => {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('overlay').style.display = 'none';
        };
        window.logout = () => signOut(auth).then(() => location.href = 'signin.html');

        // --- AUTH & INIT ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) { window.location.href = 'signin.html'; return; }
            currentUser = user;
            
            // 1. GET USER DATA & PLAN (Master Template Logic)
            onSnapshot(doc(db, "users", user.uid), (docSnap) => {
                if (!docSnap.exists()) return;
                const data = docSnap.data();
                
                if (data.role !== 'employer') return location.href = 'seeker-dashboard.html';

                // Set Header Avatar
                if(data.logoUrl) {
                    document.getElementById('header-avatar').innerHTML = `<img src="${data.logoUrl}" style="width:100%; height:100%; object-fit:cover;">`;
                }

                // PLAN & LOCK LOGIC
                const plan = (data.plan || data.subscription || 'free').toLowerCase();
                // Lock Invite if Free
                if(plan === 'free') lockNav('nav-invite', 'lock-invite');
                else unlockNav('nav-invite', 'lock-invite');
                // Lock Invest & Resources if NOT Growth/Scale
                if(!plan.includes('growth') && !plan.includes('scale') && !plan.includes('enterprise')) {
                    lockNav('nav-invest', 'lock-invest');
                    lockNav('nav-resources', 'lock-resources');
                } else {
                    unlockNav('nav-invest', 'lock-invest');
                    unlockNav('nav-resources', 'lock-resources');
                }
            });

            // 2. LOAD GLOBAL BADGES (Master Template Logic)
            loadGlobalBadges(user.uid);

            // 3. LOAD THREADS (Specific Page Logic)
            loadThreads();
            initEmojiPicker();
        });

        // --- NAVIGATION HELPERS ---
        function lockNav(id, lockId) {
            const el = document.getElementById(id);
            const lock = document.getElementById(lockId);
            if(el) el.classList.add('locked');
            if(lock) lock.style.display = 'block';
        }
        function unlockNav(id, lockId) {
            const el = document.getElementById(id);
            const lock = document.getElementById(lockId);
            if(el) el.classList.remove('locked');
            if(lock) lock.style.display = 'none';
        }

        // --- GLOBAL BADGES ---
        function loadGlobalBadges(uid) {
            // Unread Messages (Global Sidebar Badge)
            const msgQuery = query(collection(db, "chats"), where("participants", "array-contains", uid), where("hasUnread", "==", true));
            onSnapshot(msgQuery, (snap) => {
                let unreadCount = 0;
                snap.docs.forEach(doc => {
                    const d = doc.data();
                    if(d.lastSenderId !== uid) unreadCount++;
                });

                // Update Header
                const headerBadge = document.getElementById('header-msg-badge');
                if(headerBadge) {
                    headerBadge.style.display = unreadCount > 0 ? 'flex' : 'none';
                    headerBadge.innerText = unreadCount > 9 ? '9+' : unreadCount;
                }
                // Update Sidebar
                const sidebarBadge = document.getElementById('nav-badge-messages');
                if(sidebarBadge) {
                    sidebarBadge.style.display = unreadCount > 0 ? 'inline-block' : 'none';
                    sidebarBadge.innerText = unreadCount > 9 ? '9+' : unreadCount;
                }
            });

            // Unread Notifications
            const notifQuery = query(collection(db, "notifications"), where("userId", "==", uid), where("read", "==", false));
            onSnapshot(notifQuery, (snap) => {
                const count = snap.size;
                const headerNotif = document.getElementById('header-notif-badge');
                if(headerNotif) {
                    headerNotif.style.display = count > 0 ? 'flex' : 'none';
                    headerNotif.innerText = count > 9 ? '9+' : count;
                }
            });

            // Applicants Badge
            const appQuery = query(collection(db, "applications"), where("employerId", "==", uid), where("status", "==", "new"));
            onSnapshot(appQuery, (snap) => {
                const el = document.getElementById('nav-badge-candidates');
                if(el) {
                    if(!snap.empty) {
                        el.style.display = 'inline-block';
                        el.innerText = snap.size > 99 ? '99+' : snap.size;
                    } else {
                        el.style.display = 'none';
                    }
                }
            });
        }

        // --- 1. THREADS LOGIC ---
        function loadThreads() {
            try {
                const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid));
                onSnapshot(q, (snap) => {
                    const raw = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    processThreads(raw);
                }, (err) => {
                    console.error("Thread Error:", err);
                    document.getElementById('thread-list').innerHTML = `<div style="padding:20px; text-align:center; color:var(--danger)">Unable to load chats.</div>`;
                });
            } catch (err) { console.error(err); }
        }

        async function processThreads(chats) {
            allThreads = [];
            if(chats.length === 0) { renderThreads(); return; }

            const promises = chats.map(async (chat) => {
                let pid = chat.participants ? chat.participants.find(uid => uid !== currentUser.uid) : null;
                let name = "Unknown Candidate";
                let pic = "";

                if (pid) {
                    if (userCache[pid]) {
                        name = userCache[pid].name;
                        pic = userCache[pid].pic;
                    } else {
                        try {
                            const uSnap = await getDoc(doc(db, "users", pid));
                            if (uSnap.exists()) {
                                const d = uSnap.data();
                                name = d.fullName || d.companyName || "Candidate";
                                pic = d.photoURL || d.logoUrl || "";
                                userCache[pid] = { name, pic };
                            }
                        } catch(e) {}
                    }
                }

                const isUnread = !chat.isRead && chat.lastSenderId !== currentUser.uid;
                const badge = isUnread ? (chat.unreadCount || 1) : 0;
                const isPinned = chat.pinnedBy && chat.pinnedBy.includes(currentUser.uid);

                return {
                    ...chat,
                    pid, name, pic, badge, isPinned,
                    time: chat.lastUpdated ? chat.lastUpdated.seconds : 0
                };
            });

            allThreads = await Promise.all(promises);
            
            // Sort: Pinned first, then Newest
            allThreads.sort((a,b) => {
                if (a.isPinned !== b.isPinned) return b.isPinned ? 1 : -1;
                return b.time - a.time;
            });
            renderThreads();
        }

        window.renderThreads = () => {
            const listEl = document.getElementById('thread-list');
            const search = document.getElementById('search-input').value.toLowerCase();
            listEl.innerHTML = "";

            const filtered = allThreads.filter(t => {
                const isArchived = t.archivedBy && t.archivedBy.includes(currentUser.uid);

                // Filter Logic
                if (currentFilter === 'archived') {
                    if (!isArchived) return false;
                } else {
                    if (isArchived && search.length === 0) return false; // Hide archived unless searching or filtered
                }

                if(currentFilter === 'unread' && t.badge === 0) return false;
                if(currentFilter === 'pinned' && !t.isPinned) return false;
                
                // Search Logic
                const matchName = t.name.toLowerCase().includes(search);
                const matchMsg = t.lastMessage && t.lastMessage.toLowerCase().includes(search);
                return matchName || matchMsg;
            });

            if(filtered.length === 0) {
                listEl.innerHTML = `<div style="text-align:center; padding:30px; color:var(--text-muted); font-size:0.9rem;">No conversations found.</div>`;
                return;
            }

            filtered.forEach((t, index) => {
                const date = t.time ? new Date(t.time * 1000) : new Date();
                const timeStr = date.toLocaleDateString() === new Date().toLocaleDateString() 
                    ? date.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) 
                    : date.toLocaleDateString([],{month:'short',day:'numeric'});

                const div = document.createElement('div');
                // Animation staggered for list items
                div.className = `thread-item ${activeThreadId === t.id ? 'active' : ''} ${t.isPinned ? 'pinned' : ''} animate__animated animate__fadeInLeft`;
                div.style.animationDelay = `${index * 0.05}s`;
                div.style.animationDuration = '0.3s';
                
                const checkboxHtml = isSelectMode 
                    ? `<input type="checkbox" style="margin-right:12px; width:18px; height:18px; accent-color:var(--gold-base);" 
                       ${selectedThreads.has(t.id)?'checked':''} onclick="event.stopPropagation(); toggleSelectThread('${t.id}')">` 
                    : '';

                const badgeHtml = t.badge > 0 ? `<div class="unread-badge animate__animated animate__bounceIn">${t.badge}</div>` : '';

                div.innerHTML = `
                    ${checkboxHtml}
                    <div class="t-avatar-box">
                        <img src="${t.pic || 'assets/images/default-avatar.png'}" class="t-avatar">
                    </div>
                    <div class="t-info">
                        <div class="t-top">
                            <div class="t-name">${t.name}</div>
                            <div class="t-time">${timeStr}</div>
                        </div>
                        <div class="t-btm">
                            <div class="t-msg ${t.badge > 0 ?'unread':''}">${t.lastSenderId === currentUser.uid ? 'You: ' : ''}${t.lastMessage}</div>
                            <div class="badges-container">
                                <i class="fas fa-thumbtack pin-icon"></i>
                                ${badgeHtml}
                            </div>
                        </div>
                    </div>
                `;
                div.onclick = () => isSelectMode ? toggleSelectThread(t.id) : openChat(t);
                listEl.appendChild(div);
            });
        };

        // --- 2. CHAT FUNCTIONS ---
        window.openChat = async (thread) => {
            if(activeThreadId === thread.id) return;
            activeThreadId = thread.id;
            activeThreadData = thread;

            // UI Transitions (Mobile & Desktop)
            document.body.classList.add('chat-active'); 
            document.getElementById('empty-state').style.display = 'none';
            
            const chatContainer = document.getElementById('active-chat-container');
            chatContainer.style.display = 'flex';
            // Reset animation
            chatContainer.classList.remove('animate__fadeIn');
            void chatContainer.offsetWidth; 
            chatContainer.classList.add('animate__fadeIn');
            
            // Re-render list to highlight active
            renderThreads(); 

            // Update Header
            document.getElementById('header-name').innerText = thread.name;
            const chatAv = document.getElementById('header-avatar-chat');
            chatAv.src = thread.pic || 'assets/images/default-avatar.png';

            // Mark Read Logic
            if(thread.badge > 0) {
                // Update local model first for instant UI response
                const tIndex = allThreads.findIndex(t => t.id === thread.id);
                if(tIndex > -1) allThreads[tIndex].badge = 0;
                renderThreads();
                
                // Update Firestore
                await updateDoc(doc(db, "chats", thread.id), { isRead: true, unreadCount: 0 });
            }

            loadMessages(thread.id);
        };

        function loadMessages(chatId) {
            if(msgUnsub) msgUnsub();
            const box = document.getElementById('messages-box');
            box.innerHTML = `<div style="text-align:center; margin-top:50px; color:var(--text-muted);"><i class="fas fa-circle-notch fa-spin"></i> Loading...</div>`;

            const q = query(collection(db, "messages"), where("chatId", "==", chatId), orderBy("timestamp", "asc"));

            msgUnsub = onSnapshot(q, (snap) => {
                box.innerHTML = "";
                
                if(snap.empty) {
                    box.innerHTML = `<div style="text-align:center; margin-top:50px; color:var(--text-muted); opacity:0.7;">No messages yet.<br>Start the conversation!</div>`;
                    return;
                }

                let lastDate = "";
                snap.forEach(d => {
                    const m = d.data();
                    const mid = d.id;
                    const isMe = m.senderId === currentUser.uid;
                    const dateObj = m.timestamp ? new Date(m.timestamp.seconds * 1000) : new Date();
                    const dateStr = dateObj.toLocaleDateString();

                    // Date Dividers
                    if(dateStr !== lastDate) {
                        let label = dateStr;
                        const today = new Date().toLocaleDateString();
                        const yesterday = new Date(Date.now() - 86400000).toLocaleDateString();
                        if(dateStr === today) label = "Today";
                        else if(dateStr === yesterday) label = "Yesterday";
                        
                        box.innerHTML += `<div class="date-divider"><span class="date-span">${label}</span></div>`;
                        lastDate = dateStr;
                    }

                    // Read Receipts (Only for my sent messages)
                    const checkIcon = isMe 
                        ? (m.read ? '<i class="fas fa-check-double read-check read"></i>' : '<i class="fas fa-check read-check"></i>') 
                        : '';

                    let content = "";
                    if(m.image) content += `<img src="${m.image}" class="msg-img" onclick="window.open('${m.image}','_blank')">`;
                    if(m.text) content += `<div>${m.text}</div>`;

                    const row = document.createElement('div');
                    row.className = `msg-row ${isMe ? 'sent' : 'received'} animate__animated animate__fadeInUp`;
                    
                    const bubble = document.createElement('div');
                    bubble.className = 'msg-bubble';
                    bubble.innerHTML = `
                        ${content}
                        <div class="msg-meta">
                            ${dateObj.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} ${checkIcon}
                        </div>
                    `;
                    
                    // Right click context menu
                    bubble.oncontextmenu = (e) => showContextMenu(e, mid, m.text, isMe);
                    row.appendChild(bubble);
                    box.appendChild(row);
                });
                
                // Scroll to bottom
                box.scrollTop = box.scrollHeight;

            }, (error) => {
                console.error("Msg Load:", error);
                if (error.message.includes("index")) {
                     Toastify({ text: "Database Index Required", style: { background: "var(--danger)" } }).showToast();
                }
            });
        }

        // --- 3. SEND MESSAGES ---
        window.sendMessage = async () => {
            const inp = document.getElementById('msg-input');
            const txt = inp.value.trim();
            
            if ((!txt && !currentAttachment) || !activeThreadId) return;

            const payload = {
                chatId: activeThreadId,
                senderId: currentUser.uid,
                receiverId: activeThreadData.pid, 
                text: txt,
                image: currentAttachment || null,
                timestamp: serverTimestamp(),
                read: false
            };

            // Reset UI
            inp.value = ''; 
            inp.style.height = 'auto';
            clearAttachment();
            document.getElementById('emoji-picker').classList.remove('active');

            try {
                // 1. Add Message
                await addDoc(collection(db, "messages"), payload);

                // 2. Update Chat Meta
                await updateDoc(doc(db, "chats", activeThreadId), {
                    lastMessage: txt || 'Sent an attachment',
                    lastSenderId: currentUser.uid,
                    lastUpdated: serverTimestamp(),
                    isRead: false,
                    unreadCount: (activeThreadData.unreadCount || 0) + 1,
                    // If the other user archived this chat, bring it back
                    archivedBy: (activeThreadData.archivedBy || []).filter(id => id !== activeThreadData.pid) 
                });
            } catch (e) {
                console.error("Send Failed:", e);
                Toastify({ text: "Failed to send", style: { background: "var(--danger)" } }).showToast();
            }
        };

        // --- 4. MANAGEMENT FEATURES ---
        
        // Pin/Unpin
        window.togglePinCurrent = async () => {
            if(!activeThreadId) return;
            const ref = doc(db, "chats", activeThreadId);
            const isPinned = activeThreadData.isPinned;
            try {
                const snap = await getDoc(ref);
                let currentPins = snap.data().pinnedBy || [];
                
                if(isPinned) {
                    currentPins = currentPins.filter(uid => uid !== currentUser.uid);
                    Toastify({text: "Chat Unpinned", style:{background:"var(--bg-card)"}}).showToast();
                } else {
                    currentPins.push(currentUser.uid);
                    Toastify({text: "Chat Pinned", style:{background:"var(--gold-base)", color:"black"}}).showToast();
                }
                
                await updateDoc(ref, { pinnedBy: currentPins });
                document.getElementById('chat-dropdown').classList.remove('show');
            } catch(e) { console.error(e); }
        };

        // Mark Unread
        window.markAsUnread = async () => {
            if(!activeThreadId) return;
            try {
                await updateDoc(doc(db, "chats", activeThreadId), {
                    isRead: false,
                    lastSenderId: activeThreadData.pid, // Trick logic to show badge
                    unreadCount: 1
                });
                closeChat();
                Toastify({text: "Marked as Unread"}).showToast();
            } catch(e) { console.error(e); }
        };

        // Archive
        window.archiveChat = async () => {
            if(!activeThreadId) return;
            try {
                const ref = doc(db, "chats", activeThreadId);
                const snap = await getDoc(ref);
                let archives = snap.data().archivedBy || [];
                
                if(!archives.includes(currentUser.uid)) {
                    archives.push(currentUser.uid);
                    await updateDoc(ref, { archivedBy: archives });
                    Toastify({text: "Chat Archived"}).showToast();
                    closeChat();
                }
            } catch(e) { console.error(e); }
        };

        // Mute
        window.toggleMute = async () => {
            if(!activeThreadId) return;
            try {
                const ref = doc(db, "chats", activeThreadId);
                const snap = await getDoc(ref);
                let mutes = snap.data().mutedBy || [];
                
                if(mutes.includes(currentUser.uid)) {
                    mutes = mutes.filter(u => u !== currentUser.uid);
                    Toastify({text: "Notifications Unmuted"}).showToast();
                } else {
                    mutes.push(currentUser.uid);
                    Toastify({text: "Notifications Muted"}).showToast();
                }
                await updateDoc(ref, { mutedBy: mutes });
                document.getElementById('chat-dropdown').classList.remove('show');
            } catch(e) { console.error(e); }
        };

        // Delete Conversation
        window.deleteCurrentChat = async () => {
            if(!activeThreadId || !confirm("Delete this conversation permanently? This cannot be undone.")) return;
            try {
                // Delete chat doc
                await deleteDoc(doc(db, "chats", activeThreadId));
                // Ideally also delete sub-collection 'messages' via Cloud Function
                closeChat();
                Toastify({text: "Conversation Deleted", style:{background:"var(--danger)"}}).showToast();
            } catch(e) { console.error(e); }
        };

        // --- 5. CONTEXT MENU & ACTIONS ---
        window.showContextMenu = (e, msgId, text, isMe) => {
            e.preventDefault();
            contextMessageId = msgId;
            contextMessageText = text;
            
            const menu = document.getElementById('ctx-menu');
            menu.style.display = 'flex';
            menu.style.top = `${e.clientY}px`;
            
            // Adjust X position if too close to edge
            if (e.clientX + 160 > window.innerWidth) {
                menu.style.left = `${e.clientX - 160}px`;
            } else {
                menu.style.left = `${e.clientX}px`;
            }
            
            // Only show delete option for own messages
            const deleteBtn = menu.querySelector('.ctx-item:last-child');
            deleteBtn.style.display = isMe ? 'flex' : 'none';
        };

        window.copyMessage = () => {
            if(contextMessageText) {
                navigator.clipboard.writeText(contextMessageText);
                Toastify({text: "Copied to clipboard", style:{background:"var(--bg-card)"}}).showToast();
            }
            hideContextMenu();
        };

        window.deleteMessage = async () => {
            if(contextMessageId && confirm("Delete this message?")) {
                try {
                    await deleteDoc(doc(db, "messages", contextMessageId));
                    Toastify({text: "Message deleted"}).showToast();
                } catch(e) { console.error(e); }
            }
            hideContextMenu();
        };

        function hideContextMenu() {
            document.getElementById('ctx-menu').style.display = 'none';
            contextMessageId = null;
        }

        // --- 6. UTILS & HELPERS ---
        window.closeChat = () => {
            document.body.classList.remove('chat-active'); // Revert mobile view
            activeThreadId = null;
            if(msgUnsub) msgUnsub();
            renderThreads();
        };

        window.handleFileSelect = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentAttachment = e.target.result;
                    document.getElementById('preview-img').src = currentAttachment;
                    document.getElementById('attachment-preview').style.display = 'flex';
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.clearAttachment = () => {
            currentAttachment = null;
            document.getElementById('file-input').value = "";
            document.getElementById('attachment-preview').style.display = 'none';
        };

        window.autoResize = (el) => {
            el.style.height = 'auto';
            el.style.height = (el.scrollHeight) + 'px';
        };

        // Emoji System
        function initEmojiPicker() {
            const grid = document.getElementById('emoji-grid');
            if(!grid) return;
            grid.innerHTML = "";
            emojiLibrary.forEach(char => {
                const btn = document.createElement('div');
                btn.className = 'emoji-btn';
                btn.innerText = char;
                btn.onclick = () => insertEmoji(char);
                grid.appendChild(btn);
            });
        }
        window.toggleEmojiPicker = () => document.getElementById('emoji-picker').classList.toggle('active');
        window.insertEmoji = (char) => {
            const inp = document.getElementById('msg-input');
            inp.value += char;
            inp.focus();
        };

        // Bulk Selection
        window.toggleSelectMode = () => {
            isSelectMode = !isSelectMode;
            selectedThreads.clear();
            document.getElementById('bulk-actions').style.display = isSelectMode ? 'flex' : 'none';
            document.getElementById('select-count').innerText = "0";
            renderThreads();
        };
        window.toggleSelectThread = (id) => {
            if(selectedThreads.has(id)) selectedThreads.delete(id);
            else selectedThreads.add(id);
            document.getElementById('select-count').innerText = selectedThreads.size;
            renderThreads(); 
        };
        window.deleteBulk = async () => {
            if(!confirm(`Delete ${selectedThreads.size} conversations?`)) return;
            const batch = writeBatch(db);
            selectedThreads.forEach(id => batch.delete(doc(db, "chats", id)));
            await batch.commit();
            toggleSelectMode();
        };
        window.setFilter = (f, btn) => {
            currentFilter = f;
            document.querySelectorAll('.filter-chip').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            renderThreads();
        };

        // Click Outside Handlers
        window.onclick = (e) => {
            if(!e.target.closest('.icon-btn') && !e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
            }
            if(!e.target.closest('.tool-btn') && !e.target.closest('.emoji-picker-container')) {
                document.getElementById('emoji-picker').classList.remove('active');
            }
            if(!e.target.closest('.ctx-menu') && !e.target.closest('.msg-bubble')) {
                hideContextMenu();
            }
        };

        // --- PWA LOGIC ---
        let deferredPrompt;
        const pwaPopup = document.getElementById('pwa-install-popup');
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if(!localStorage.getItem('pwaDismissed')) {
                pwaPopup.style.display = 'flex';
            }
        });

        window.installPWA = async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                pwaPopup.style.display = 'none';
            }
            deferredPrompt = null;
        };

        window.dismissPWA = () => {
            pwaPopup.style.display = 'none';
            localStorage.setItem('pwaDismissed', 'true');
        };

    </script>
</body>
</html>
