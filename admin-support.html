<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Support Console | EastLink Admin</title>
    
    <!-- PWA & Meta -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0F172A">
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <style>
        :root {
            --bg-body: #0F172A;       
            /* INCREASED TRANSPARENCY HERE */
            --bg-card: rgba(30, 41, 59, 0.5); 
            --bg-glass: rgba(30, 41, 59, 0.6);
            --bg-glass-heavy: rgba(15, 23, 42, 0.85); /* Was 0.95 */
            --bg-input: rgba(255, 255, 255, 0.07);
            --bg-hover: rgba(255, 255, 255, 0.12);
            --border-color: rgba(255, 255, 255, 0.12);
            --text-main: #F8FAFC;     
            --text-muted: #94A3B8; 
            --gold-base: #D97706;
            --gold-gradient: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            --neon-purple: #8b5cf6;
            --success: #10B981;
            --danger: #EF4444;
            --blue: #3B82F6;
            
            --sidebar-width: 260px; 
            --thread-list-width: 360px;
            --header-height: 60px;
            --font-body: 'Inter', sans-serif;
            --font-head: 'Cinzel', serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: var(--font-body); 
            background-color: var(--bg-body); 
            background-image: url('assets/images/background.png');
            background-size: cover; background-position: center; background-attachment: fixed;
            color: var(--text-main); 
            height: 100vh; overflow: hidden; 
            display: flex; flex-direction: column;
        }

        /* --- HEADER --- */
        header {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height);
            background: var(--bg-glass-heavy); backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 20px; z-index: 1000;
        }
        
        .header-left { display: flex; align-items: center; gap: 12px; }
        .logo { font-family: var(--font-head); font-weight: 700; color: var(--text-main); font-size: 1.15rem; text-decoration: none; text-transform: uppercase; letter-spacing: 1px; }
        .logo span { color: var(--gold-base); }
        .admin-badge { font-family: var(--font-body); font-size: 0.55rem; background: var(--bg-input); border: 1px solid var(--border-color); padding: 2px 6px; border-radius: 4px; margin-left: 8px; color: var(--text-muted); letter-spacing: 0.5px; }
        .hamburger { font-size: 1.2rem; cursor: pointer; color: var(--text-muted); display: none; }

        .header-actions { display: flex; align-items: center; gap: 8px; }
        .icon-btn { width: 32px; height: 32px; display: grid; place-items: center; border-radius: 8px; font-size: 0.9rem; color: var(--text-muted); cursor: pointer; transition: 0.3s; position: relative; }
        .icon-btn:hover { background: var(--bg-hover); color: var(--text-main); }
        .notification-badge { position: absolute; top: 2px; right: 2px; min-width: 14px; height: 14px; background: var(--danger); border-radius: 10px; font-size: 0.55rem; color: white; font-weight: 700; display: none; place-items: center; justify-content: center; padding: 0 3px; border: 2px solid var(--bg-card); }
        .profile-widget { width: 34px; height: 34px; background: var(--bg-input); border-radius: 10px; display: grid; place-items: center; border: 1px solid var(--border-color); color: var(--gold-base); font-size: 0.9rem; cursor: pointer; margin-left: 4px; }

        /* --- SIDEBAR --- */
        .sidebar {
            position: fixed; top: var(--header-height); left: 0; width: var(--sidebar-width); height: calc(100vh - var(--header-height));
            background: var(--bg-glass-heavy); border-right: 1px solid var(--border-color); padding: 15px 0; overflow-y: auto; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 999; display: flex; flex-direction: column; 
            backdrop-filter: blur(15px); /* Enhanced Blur */
        }
        .nav-group { padding: 0 20px; margin-bottom: 15px; }
        .nav-label { font-size: 0.7rem; text-transform: uppercase; color: var(--gold-base); font-weight: 700; margin-bottom: 8px; letter-spacing: 1px; }
        .nav-item { display: flex; align-items: center; padding: 10px 12px; color: var(--text-muted); text-decoration: none; font-size: 0.85rem; transition: 0.3s; border-radius: 8px; margin-bottom: 2px; }
        .nav-item:hover { color: var(--text-main); background: var(--bg-hover); transform: translateX(5px); }
        .nav-item.active { background: rgba(217, 119, 6, 0.1); color: var(--gold-base); font-weight: 600; }
        .nav-item i { width: 22px; text-align: center; margin-right: 8px; }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 998; backdrop-filter: blur(4px); }

        /* --- MAIN LAYOUT --- */
        main { 
            margin-left: var(--sidebar-width); margin-top: var(--header-height); 
            height: calc(100vh - var(--header-height)); width: calc(100% - var(--sidebar-width));
            display: flex; overflow: hidden; padding: 0; 
        }

        /* THREAD SIDEBAR */
        .thread-sidebar {
            width: var(--thread-list-width); height: 100%;
            background: rgba(15, 23, 42, 0.4); /* More Transparent */
            border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; z-index: 50; flex-shrink: 0;
            backdrop-filter: blur(10px);
        }
        .search-area { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 12px; background: rgba(15,23,42,0.3); }
        .search-wrap input { width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; color: var(--text-main); font-family: var(--font-body); }
        
        .filter-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .filter-chip { 
            white-space: nowrap; padding: 6px 14px; border-radius: 20px; font-size: 0.7rem; font-weight: 500;
            background: var(--bg-input); border: 1px solid var(--border-color); 
            color: var(--text-muted); cursor: pointer; transition: 0.3s; 
        }
        .filter-chip.active { background: var(--gold-gradient); color: #000; font-weight: 700; border-color: transparent; box-shadow: 0 4px 12px rgba(217,119,6,0.2); }
        
        .thread-list { flex: 1; overflow-y: auto; }
        .thread-item {
            padding: 16px 20px; display: flex; gap: 14px; align-items: center; cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.03); transition: 0.2s; position: relative;
        }
        .thread-item:hover { background: var(--bg-hover); }
        .thread-item.active { background: rgba(217, 119, 6, 0.1); border-left: 3px solid var(--gold-base); }
        
        .u-avatar { 
            width: 42px; height: 42px; border-radius: 10px; background: var(--bg-input); 
            display: grid; place-items: center; font-weight: 700; color: var(--gold-base); 
            border: 1px solid var(--border-color); flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .u-info { flex: 1; overflow: hidden; }
        .u-head { display: flex; justify-content: space-between; margin-bottom: 4px; align-items: center; }
        .u-name { font-weight: 600; font-size: 0.9rem; color: var(--text-main); }
        .u-time { font-size: 0.7rem; color: var(--text-muted); font-family: 'Space Grotesk', sans-serif; }
        .u-msg { font-size: 0.8rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .u-msg.bold { font-weight: 600; color: var(--text-main); }
        
        .cat-tag { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-right: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .cat-ticket { background: rgba(139, 92, 246, 0.15); color: var(--neon-purple); border: 1px solid rgba(139, 92, 246, 0.3); }
        .cat-dm { background: rgba(59, 130, 246, 0.15); color: var(--blue); border: 1px solid rgba(59, 130, 246, 0.3); }

        .thread-badge { background: var(--gold-gradient); color: #000; font-weight: 700; font-size: 0.65rem; min-width: 18px; height: 18px; border-radius: 9px; display: flex; align-items: center; justify-content: center; padding: 0 5px; margin-left: 5px; }

        /* CHAT AREA */
        .chat-area { 
            flex: 1; display: flex; flex-direction: column; 
            background: rgba(15, 23, 42, 0.3); /* Transparent for background image */
            position: relative; backdrop-filter: blur(10px); 
        }
        
        .cv-header { 
            height: 65px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; 
            justify-content: space-between; padding: 0 24px; background: var(--bg-glass-heavy); z-index: 50;
        }
        
        /* IN-CHAT SEARCH BAR */
        .chat-search-bar {
            position: absolute; top: 65px; left: 0; right: 0; background: var(--bg-glass-heavy);
            padding: 10px 20px; border-bottom: 1px solid var(--border-color); z-index: 40;
            display: none; animation: slideDown 0.3s forwards;
        }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
        .chat-search-input { width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 8px; color: var(--text-main); }

        .back-btn { margin-right: 15px; font-size: 1.2rem; color: var(--text-muted); cursor: pointer; display: none; }
        
        /* Resolve Button */
        .resolve-btn {
            background: rgba(16, 185, 129, 0.15); color: var(--success); border: 1px solid var(--success);
            padding: 8px 16px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; cursor: pointer;
            display: none; align-items: center; gap: 6px; transition: 0.3s;
        }
        .resolve-btn:hover { background: var(--success); color: white; box-shadow: 0 0 15px rgba(16,185,129,0.4); }
        .resolve-btn.hidden { display: none !important; }

        /* HEADER TOOLS */
        .chat-tools { display: flex; align-items: center; gap: 10px; }
        .tool-btn { width: 32px; height: 32px; border-radius: 50%; display: grid; place-items: center; cursor: pointer; color: var(--text-muted); transition: 0.3s; }
        .tool-btn:hover { background: var(--bg-hover); color: var(--text-main); }
        .tool-btn.active { color: var(--gold-base); }

        /* MESSAGES & ACTIONS */
        .messages-feed { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth; position: relative; }
        .msg-group { max-width: 70%; display: flex; flex-direction: column; position: relative; }
        .msg-group:hover .msg-actions { opacity: 1; }
        .msg-group.sent { align-self: flex-end; align-items: flex-end; }
        .msg-group.received { align-self: flex-start; align-items: flex-start; }
        
        .msg-bubble { 
            padding: 12px 18px; border-radius: 18px; font-size: 0.95rem; line-height: 1.5; 
            position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: 0.3s; 
            display: flex; flex-direction: column; min-width: 120px;
        }
        .msg-group.sent .msg-bubble { background: var(--gold-gradient); color: #000; font-weight: 500; border-bottom-right-radius: 4px; }
        .msg-group.received .msg-bubble { background: var(--bg-glass-heavy); border: 1px solid var(--border-color); color: var(--text-main); border-bottom-left-radius: 4px; }
        
        /* NEW: TIMESTAMP STYLE */
        .msg-time {
            font-size: 0.6rem; margin-top: 4px; align-self: flex-end; opacity: 0.7; font-weight: 600; font-family: 'Space Grotesk', sans-serif;
        }
        .msg-group.sent .msg-time { color: rgba(0,0,0,0.6); }
        .msg-group.received .msg-time { color: var(--text-muted); }

        /* Pinned Style */
        .msg-group.pinned .msg-bubble { border: 1px solid var(--gold-base); box-shadow: 0 0 15px rgba(217, 119, 6, 0.2); }
        .pin-indicator { position: absolute; top: -8px; right: -8px; background: var(--gold-base); color: #000; font-size: 0.6rem; width: 18px; height: 18px; border-radius: 50%; display: grid; place-items: center; z-index: 2; display: none; }
        .msg-group.pinned .pin-indicator { display: grid; }

        /* Message Actions Menu */
        .msg-actions { 
            position: absolute; top: 50%; transform: translateY(-50%); 
            display: flex; gap: 5px; opacity: 0; transition: 0.2s; 
            background: var(--bg-glass-heavy); padding: 4px; border-radius: 20px; border: 1px solid var(--border-color);
        }
        .msg-group.sent .msg-actions { left: -90px; }
        .msg-group.received .msg-actions { right: -90px; }
        
        .msg-action-btn { 
            width: 26px; height: 26px; border-radius: 50%; display: grid; place-items: center; 
            font-size: 0.8rem; color: var(--text-muted); cursor: pointer; transition: 0.2s; 
        }
        .msg-action-btn:hover { background: var(--bg-hover); color: var(--text-main); }
        .msg-action-btn.delete:hover { color: var(--danger); }
        .msg-action-btn.pin:hover { color: var(--gold-base); }

        .input-zone { background: var(--bg-glass-heavy); padding: 20px 24px; border-top: 1px solid var(--border-color); display: flex; gap: 12px; align-items: flex-end; }
        .chat-input { 
            flex: 1; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 12px; 
            padding: 14px; color: var(--text-main); resize: none; min-height: 50px; max-height: 150px; 
            font-family: var(--font-body); font-size: 0.95rem;
        }
        .chat-input:focus { border-color: var(--gold-base); background: var(--bg-hover); }
        
        .send-btn { width: 50px; height: 50px; background: var(--gold-gradient); border: none; border-radius: 12px; color: black; font-size: 1.1rem; cursor: pointer; transition: 0.3s; }
        .send-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(217,119,6,0.3); }
        
        .ai-btn { color: var(--neon-purple); border: 1px solid var(--neon-purple); background: rgba(139, 92, 246, 0.1); width: 50px; height: 50px; border-radius: 12px; cursor: pointer; transition: 0.3s; display: grid; place-items: center; font-size: 1.1rem; }
        .ai-btn:hover { background: var(--neon-purple); color: white; box-shadow: 0 0 15px rgba(139, 92, 246, 0.5); transform: rotate(15deg); }

        /* AI POPUP */
        .ai-popup { 
            position: absolute; bottom: 100px; left: 24px; right: 24px; 
            background: rgba(15, 23, 42, 0.98); border: 1px solid var(--neon-purple); border-radius: 16px; 
            padding: 24px; box-shadow: 0 -10px 40px rgba(139, 92, 246, 0.2); z-index: 200; display: none; backdrop-filter: blur(20px);
        }
        .ai-step { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px; opacity: 0; animation: fadeInUp 0.4s forwards; display: flex; align-items: center; gap: 12px; font-family: 'Space Grotesk', sans-serif; }

        /* PWA Popup */
        .pwa-install-popup {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px); border: 1px solid var(--gold-base);
            border-radius: 20px; padding: 20px; z-index: 3000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: none;
            animation: slideUp 0.5s ease;
        }
        @keyframes slideUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        .pwa-content { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .pwa-icon { width: 50px; height: 50px; border-radius: 12px; background: var(--gold-gradient); display: grid; place-items: center; font-size: 1.5rem; color: #000; }
        .pwa-actions { display: flex; gap: 10px; }
        .btn-pwa-install { flex: 2; padding: 10px; background: var(--gold-gradient); border: none; border-radius: 10px; font-weight: 700; cursor: pointer; color: #000; }
        .btn-pwa-dismiss { flex: 1; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-muted); cursor: pointer; }

        @media (max-width: 992px) {
            .sidebar { transform: translateX(-100%); } .sidebar.active { transform: translateX(0); }
            .hamburger, .back-btn { display: block; }
            
            /* Fix Black Void on Mobile */
            main { margin-left: 0; width: 100%; display: block; height: calc(100vh - var(--header-height)); }
            .thread-sidebar { width: 100%; height: 100%; display: flex; }
            
            /* Ensure Chat Area takes full screen and sits on top */
            .chat-area { 
                display: none; 
                width: 100%; 
                height: 100%; 
                position: fixed; 
                top: 0; 
                left: 0; 
                z-index: 2000; 
                /* Glass Effect for Mobile */
                background: rgba(15, 23, 42, 0.9);
                backdrop-filter: blur(20px);
                flex-direction: column;
            }
            body.chat-active .thread-sidebar { display: none; }
            body.chat-active .chat-area { display: flex; }
            
            /* Mobile Adjustments */
            .cv-header { padding-top: env(safe-area-inset-top, 10px); height: auto; min-height: 70px; }
            .input-zone { padding: 15px; padding-bottom: max(15px, env(safe-area-inset-bottom, 20px)); }
            .msg-group { max-width: 85%; }
            
            /* Show Actions on Mobile without Hover */
            .msg-actions { opacity: 1 !important; background: transparent; position: static; transform: none; margin-top: 5px; justify-content: flex-end; border: none; padding: 0; }
            .msg-group.received .msg-actions { justify-content: flex-start; }
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header>
        <div class="header-left">
            <i class="fas fa-bars hamburger" onclick="toggleSidebar()"></i>
            <a href="admin-dashboard.html" class="logo">East<span>Link</span> <span class="admin-badge">ADMIN</span></a>
        </div>
        <div class="header-actions">
            <div class="icon-btn active" onclick="location.href='admin-support.html'" title="Support Tickets" style="color:var(--gold-base); background:rgba(217,119,6,0.1);">
                <i class="fa-solid fa-envelope"></i><div class="notification-badge" id="msg-badge">0</div>
            </div>
            <div class="icon-btn" onclick="location.href='admin-notifications.html'" title="System Alerts">
                <i class="fa-solid fa-bell"></i><div class="notification-badge" id="notif-badge">0</div>
            </div>
            <div class="profile-widget" onclick="location.href='admin-settings.html'" title="Admin Settings"><i class="fa-solid fa-user-shield"></i></div>
        </div>
    </header>

    <!-- SIDEBAR -->
    <nav class="sidebar" id="sidebar">
        <div class="nav-group">
            <div class="nav-label">Analytics</div>
            <a href="admin-dashboard.html" class="nav-item"><i class="fa-solid fa-chart-pie"></i> Dashboard</a>
        </div>
        <div class="nav-group">
            <div class="nav-label">User Management</div>
            <a href="admin-users.html" class="nav-item"><i class="fa-solid fa-users"></i> Manage Users</a>
            <a href="admin-plans.html" class="nav-item"><i class="fa-solid fa-tags"></i> Manage Plans</a>
            <a href="admin-referrals.html" class="nav-item"><i class="fa-solid fa-share-nodes"></i> Referrals</a>
        </div>
        <div class="nav-group">
            <div class="nav-label">Jobs & Service</div>
            <a href="admin-jobs-mod.html" class="nav-item"><i class="fa-solid fa-briefcase"></i> Job Approvals</a>
            <a href="admin-guaranteed-jobs.html" class="nav-item link-pro"><i class="fa-solid fa-certificate" style="color:var(--gold-base);"></i> Guaranteed Jobs</a>
            <a href="admin-post-guaranteed.html" class="nav-item"><i class="fa-solid fa-plus-circle"></i> Post Guaranteed</a>
        </div>
        <div class="nav-group">
            <div class="nav-label">Finance</div>
            <a href="admin-deposits.html" class="nav-item"><i class="fa-solid fa-arrow-down" style="color:var(--success);"></i> Deposits</a>
            <a href="admin-withdrawals.html" class="nav-item"><i class="fa-solid fa-arrow-up" style="color:var(--danger);"></i> Withdrawals</a>
            <a href="admin-deposit-issues.html" class="nav-item"><i class="fas fa-exclamation-triangle"></i> Errors</a>
        </div>
        <div class="nav-group">
            <div class="nav-label">System</div>
            <a href="admin-blogs.html" class="nav-item"><i class="fa-solid fa-blog"></i> Blogs & News</a>
            <a href="admin-support.html" class="nav-item active"><i class="fa-solid fa-headset"></i> Support</a>
            <a href="admin-broadcasts.html" class="nav-item"><i class="fa-solid fa-bullhorn"></i> Broadcasts</a>
            <a href="#" onclick="logout()" class="nav-item" style="color:var(--danger); margin-top:10px;"><i class="fa-solid fa-right-from-bracket"></i> Sign Out</a>
        </div>
    </nav>
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <!-- MAIN -->
    <main>
        <!-- THREADS -->
        <aside class="thread-sidebar">
            <div class="search-area">
                <div class="search-wrap"><input type="text" id="search-input" placeholder="Search conversations..." onkeyup="renderList()"></div>
                <div class="filter-row">
                    <div class="filter-chip active" onclick="setFilter('all', this)">All</div>
                    <div class="filter-chip" onclick="setFilter('ticket', this)"><i class="fas fa-ticket-alt"></i> Tickets</div>
                    <div class="filter-chip" onclick="setFilter('dm', this)"><i class="fas fa-comment-alt"></i> DMs</div>
                </div>
            </div>
            <div class="thread-list" id="thread-list">
                <div style="text-align:center; padding:40px; color:var(--text-muted);"><i class="fas fa-circle-notch fa-spin"></i> Syncing...</div>
            </div>
        </aside>

        <!-- CHAT -->
        <section class="chat-area" id="chat-ui">
            <!-- Empty State -->
            <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; opacity:0.6;" id="empty-state">
                <div style="width:100px; height:100px; background:var(--bg-input); border-radius:50%; display:grid; place-items:center; margin-bottom:20px; border:1px solid var(--border-color);">
                    <i class="fas fa-comments" style="font-size:3rem; color:var(--gold-base);"></i>
                </div>
                <h3 style="font-family:var(--font-head);">Support Console</h3>
                <p style="color:var(--text-muted);">Select a conversation to begin.</p>
            </div>

            <!-- Chat View -->
            <div id="chat-view" style="display:none; flex-direction:column; height:100%; width:100%;">
                <div class="cv-header">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <i class="fas fa-arrow-left back-btn" onclick="closeChat()"></i>
                        <div class="u-avatar" id="active-avatar">U</div>
                        <div>
                            <h4 id="active-name" style="margin:0; color:var(--text-main); font-size:1rem;">User</h4>
                            <span id="active-type" style="font-size:0.7rem; color:var(--gold-base); font-weight:700;">TICKET</span>
                        </div>
                    </div>
                    
                    <div class="chat-tools">
                        <div class="tool-btn" onclick="toggleChatSearch()" title="Search in Chat"><i class="fas fa-search"></i></div>
                        <button id="resolve-btn" class="resolve-btn hidden" onclick="resolveTicket()">
                            <i class="fas fa-check-circle"></i> Resolved
                        </button>
                    </div>
                </div>
                
                <!-- In-Chat Search -->
                <div class="chat-search-bar" id="chat-search-bar">
                    <input type="text" id="chat-search-input" class="chat-search-input" placeholder="Find in conversation..." onkeyup="filterChatMessages()">
                </div>

                <div class="messages-feed" id="feed"></div>

                <!-- AI -->
                <div class="ai-popup animate__animated animate__fadeInUp" id="ai-modal">
                    <div style="color:var(--neon-purple); font-weight:700; margin-bottom:15px; display:flex; align-items:center; gap:8px;">
                        <i class="fas fa-brain animate__animated animate__pulse animate__infinite"></i> EastLink AI Cortex
                    </div>
                    <div id="ai-steps"></div>
                </div>

                <div class="input-zone">
                    <button class="ai-btn" onclick="triggerAI()" title="Smart Reply"><i class="fas fa-wand-magic-sparkles"></i></button>
                    <textarea id="msg-input" class="chat-input" placeholder="Type a message..." rows="1"></textarea>
                    <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </section>
    </main>

    <!-- PWA INSTALL POPUP -->
    <div id="pwa-install-popup" class="pwa-install-popup">
        <div class="pwa-content">
            <div class="pwa-icon"><i class="fas fa-download"></i></div>
            <div>
                <div style="font-weight:700; color:#fff; font-size:1rem; margin-bottom:4px;">Install Admin App</div>
                <div style="font-size:0.8rem; color:#94A3B8;">Add to home screen for quick access.</div>
            </div>
        </div>
        <div class="pwa-actions">
            <button class="btn-pwa-install" onclick="installPWA()">Install</button>
            <button class="btn-pwa-dismiss" onclick="dismissPWA()">Later</button>
        </div>
    </div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, limit, addDoc, doc, getDocs, serverTimestamp, updateDoc, setDoc, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCE_C6R4EyV7hip1yYrOaTzYac9Wrwh5Ys", authDomain: "eastlink-web.firebaseapp.com", projectId: "eastlink-web" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);

        let currentUser = null;
        let allItems = [];
        let usersMap = {};
        let activeId = null, activeType = null, activeUser = null;
        let msgUnsub = null;
        let lastUserMessageText = "";
        let currentFilter = 'all';

        // --- GLOBAL UI ---
        window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').style.display = document.getElementById('sidebar').classList.contains('active') ? 'block' : 'none'; };
        window.logout = () => { if(confirm("Log Out?")) signOut(auth).then(()=>location.href='signin.html'); };

        onAuthStateChanged(auth, async (user) => {
            if(!user) return location.href = 'signin.html';
            currentUser = user;
            initBadges(); 
            const uSnap = await getDocs(collection(db, "users"));
            uSnap.forEach(d => { usersMap[d.id] = d.data(); });
            loadConversations();
        });

        function initBadges() {
            onSnapshot(query(collection(db, "transactions"), where("status", "==", "pending")), s => {
                const b = document.getElementById('notif-badge'); b.innerText = s.size; b.style.display = s.size > 0 ? 'flex' : 'none';
            });
            onSnapshot(query(collection(db, "support_tickets"), where("status", "==", "open")), s => {
                const b = document.getElementById('msg-badge'); b.innerText = s.size; b.style.display = s.size > 0 ? 'flex' : 'none';
            });
        }

        function loadConversations() {
            const tQuery = query(collection(db, "support_tickets"), limit(50));
            const cQuery = query(collection(db, "chats"), limit(50));
            let tickets = [], chats = [];

            const updateUI = () => {
                allItems = [...tickets, ...chats].sort((a,b) => (b.updated || 0) - (a.updated || 0));
                renderList();
            };
            onSnapshot(tQuery, s => {
                tickets = s.docs.map(d => { const dt = d.data(); return { id: d.id, type: 'ticket', title: dt.userName||"Support", sub: dt.category, msg: `Status: ${dt.status}`, updated: dt.lastUpdated?.seconds||0, unreadCount: !dt.isReadByAdmin?1:0, data: dt }; });
                updateUI();
            });
            onSnapshot(cQuery, s => {
                chats = s.docs.map(d => { const dt = d.data(); const pid = (dt.participants||[]).find(p=>p!==currentUser.uid); const u = usersMap[pid]||{fullName:dt.seekerName||"User"}; return { id: d.id, type: 'dm', title: u.fullName||"User", sub: "DM", msg: dt.lastMessage||"...", updated: dt.lastUpdated?.seconds||0, unreadCount: (!dt.isRead&&dt.lastSenderId!==currentUser.uid)?1:0, partnerId: pid, data: dt }; });
                updateUI();
            });
        }

        window.setFilter = (type, el) => { currentFilter = type; document.querySelectorAll('.filter-chip').forEach(e => e.classList.remove('active')); el.classList.add('active'); renderList(); };

        window.renderList = () => {
            const list = document.getElementById('thread-list');
            const search = document.getElementById('search-input').value.toLowerCase();
            const filtered = allItems.filter(i => i.title.toLowerCase().includes(search) && (currentFilter === 'all' || i.type === currentFilter));
            
            list.innerHTML = filtered.map(i => `
                <div class="thread-item animate__animated animate__fadeInLeft ${activeId === i.id ? 'active' : ''}" onclick="openChat('${i.id}', '${i.type}')">
                    <div class="u-avatar">${i.title.charAt(0)}</div>
                    <div class="u-info">
                        <div class="u-head"><span class="u-name">${i.type==='ticket'?'<span class="cat-tag cat-ticket">TICKET</span>':'<span class="cat-tag cat-dm">DM</span>'} ${i.title}</span> <span style="display:flex;align-items:center;"><span class="u-time">${new Date(i.updated*1000).toLocaleDateString()}</span> ${i.unreadCount>0?`<div class="thread-badge">${i.unreadCount}</div>`:''}</span></div>
                        <div class="u-msg ${i.unreadCount>0?'bold':''}">${i.msg}</div>
                    </div>
                </div>
            `).join('') || '<div style="padding:40px; text-align:center; opacity:0.5;">No conversations found.</div>';
        };

        // --- OPEN CHAT LOGIC (FIXED & TIMESTAMPS ADDED) ---
        window.openChat = async (id, type) => {
            activeId = id; activeType = type;
            const item = allItems.find(i => i.id === id);
            activeUser = item;
            
            document.body.classList.add('chat-active');
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('chat-view').style.display = 'flex';
            document.getElementById('active-name').innerText = item.title;
            document.getElementById('active-avatar').innerText = item.title.charAt(0);
            document.getElementById('active-type').innerText = type === 'ticket' ? "SUPPORT TICKET" : "DIRECT MESSAGE";
            
            const resBtn = document.getElementById('resolve-btn');
            if(type === 'ticket' && item.data.status !== 'resolved') {
                resBtn.classList.remove('hidden'); resBtn.style.display = 'flex';
            } else {
                resBtn.classList.add('hidden'); resBtn.style.display = 'none';
            }

            if(item.unreadCount > 0) {
                if(type === 'ticket') updateDoc(doc(db, "support_tickets", id), { isReadByAdmin: true });
                else updateDoc(doc(db, "chats", id), { isRead: true, unreadCount: 0 });
            }
            renderList();

            if(msgUnsub) msgUnsub();
            const feed = document.getElementById('feed');
            feed.innerHTML = '<div style="flex:1; display:flex; align-items:center; justify-content:center; color:var(--text-muted);"><i class="fas fa-circle-notch fa-spin" style="font-size:1.5rem;"></i></div>';
            
            let q;
            if (type === 'ticket') {
                q = collection(db, "support_tickets", id, "messages");
            } else {
                q = query(collection(db, "messages"), where("chatId", "==", id));
            }
            
            msgUnsub = onSnapshot(q, snap => {
                feed.innerHTML = "";
                let msgs = [];
                snap.forEach(d => { msgs.push({id: d.id, ...d.data()}); });

                // Client-side sort
                msgs.sort((a,b) => (a.timestamp?.seconds||0) - (b.timestamp?.seconds||0));

                if(msgs.length === 0) {
                    feed.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">No messages yet.</div>';
                    return;
                }

                const userMsgs = msgs.filter(m => type==='ticket' ? (m.sender!=='admin' && m.sender!=='agent') : (m.senderId!==currentUser.uid));
                if(userMsgs.length > 0) lastUserMessageText = userMsgs[userMsgs.length-1].text;

                msgs.forEach(m => {
                    const isMe = type === 'ticket' ? (m.sender==='admin') : (m.senderId===currentUser.uid);
                    
                    // TIMESTAMP CALCULATION
                    let timeStr = "";
                    if(m.timestamp) {
                        const date = new Date(m.timestamp.seconds * 1000);
                        const today = new Date();
                        const isToday = date.getDate() === today.getDate() && 
                                      date.getMonth() === today.getMonth() && 
                                      date.getFullYear() === today.getFullYear();
                        
                        const time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        const datePart = date.toLocaleDateString([], { month: 'short', day: 'numeric' });
                        
                        timeStr = isToday ? `Today, ${time}` : `${datePart}, ${time}`;
                    }

                    const div = document.createElement('div');
                    div.className = `msg-group ${isMe ? 'sent' : 'received'} ${m.isPinned ? 'pinned' : ''} animate__animated animate__fadeInUp`;
                    
                    div.innerHTML = `
                        <div class="msg-bubble">
                            <div class="pin-indicator"><i class="fas fa-thumbtack"></i></div>
                            <span class="msg-text">${m.text}</span>
                            <span class="msg-time">${timeStr}</span>
                        </div>
                        <div class="msg-actions">
                            <div class="msg-action-btn pin" onclick="pinMessage('${m.id}', ${m.isPinned || false})" title="${m.isPinned?'Unpin':'Pin'}"><i class="fas fa-thumbtack"></i></div>
                            <div class="msg-action-btn" onclick="copyMessage('${m.text.replace(/'/g, "\\'")}')" title="Copy"><i class="fas fa-copy"></i></div>
                            <div class="msg-action-btn delete" onclick="deleteMessage('${m.id}')" title="Delete"><i class="fas fa-trash"></i></div>
                        </div>
                    `;
                    feed.appendChild(div);
                });
                setTimeout(() => feed.scrollTop = feed.scrollHeight, 100);
            });
        };

        window.closeChat = () => { document.body.classList.remove('chat-active'); activeId = null; if(msgUnsub) msgUnsub(); };

        // --- FEATURES ---
        window.toggleChatSearch = () => {
            const bar = document.getElementById('chat-search-bar');
            bar.style.display = bar.style.display === 'block' ? 'none' : 'block';
            if(bar.style.display === 'block') document.getElementById('chat-search-input').focus();
        };

        window.filterChatMessages = () => {
            const term = document.getElementById('chat-search-input').value.toLowerCase();
            const groups = document.querySelectorAll('.msg-group');
            groups.forEach(g => {
                const text = g.querySelector('.msg-text').innerText.toLowerCase();
                if(term && text.includes(term)) {
                    g.style.background = 'rgba(255, 255, 255, 0.1)';
                    g.scrollIntoView({behavior: "smooth", block: "center"});
                } else {
                    g.style.background = 'transparent';
                }
            });
        };

        window.pinMessage = async (msgId, currentStatus) => {
            if(!activeId) return;
            const ref = activeType === 'ticket' ? doc(db, `support_tickets/${activeId}/messages`, msgId) : doc(db, "messages", msgId);
            try {
                await updateDoc(ref, { isPinned: !currentStatus });
                Toastify({text: currentStatus ? "Unpinned" : "Message Pinned", style:{background:"var(--gold-base)"}}).showToast();
            } catch(e) { console.error(e); }
        };

        window.deleteMessage = async (msgId) => {
            if(!confirm("Permanently delete this message?")) return;
            const ref = activeType === 'ticket' ? doc(db, `support_tickets/${activeId}/messages`, msgId) : doc(db, "messages", msgId);
            try {
                await deleteDoc(ref);
                Toastify({text: "Message Deleted", style:{background:"var(--danger)"}}).showToast();
            } catch(e) { console.error(e); }
        };

        window.copyMessage = (text) => {
            navigator.clipboard.writeText(text);
            Toastify({text: "Copied to Clipboard", style:{background:"var(--success)"}}).showToast();
        };

        window.triggerAI = async () => {
            if(!activeId) return;
            const modal = document.getElementById('ai-modal');
            const steps = document.getElementById('ai-steps');
            const input = document.getElementById('msg-input');
            modal.style.display = 'block'; steps.innerHTML = ''; 

            const addStep = (icon, text, color) => {
                return new Promise(resolve => {
                    const div = document.createElement('div'); div.className = 'ai-step';
                    div.innerHTML = `<i class="${icon}" style="color:${color}; width:20px;"></i> ${text}`;
                    steps.appendChild(div); setTimeout(resolve, 800); 
                });
            };

            await addStep('fas fa-fingerprint', `Authenticating...`, '#8b5cf6');
            await addStep('fas fa-microscope', `Analyzing context...`, '#3b82f6');
            
            let sentiment = "Neutral", response = "";
            const msg = lastUserMessageText.toLowerCase();
            const name = activeUser ? activeUser.title.split(' ')[0] : "User";

            if(msg.includes("urgent") || msg.includes("fail") || msg.includes("error")) sentiment = "Urgent";
            
            if(msg.includes("pay") || msg.includes("deposit") || msg.includes("mpesa")) {
                response = `Hello ${name}, I see you have a payment query. To trace this quickly, please provide the MPESA transaction code or the exact amount/time of transfer.`;
            } 
            else if(msg.includes("job") || msg.includes("post")) {
                response = `Hi ${name}, regarding your job posting: Our team reviews new listings hourly. If it has been over 2 hours, please share the Job ID so I can expedite the approval.`;
            }
            else {
                response = `Hello ${name}, thank you for reaching out. I'm reviewing your message now. Could you provide a few more details so I can resolve this for you immediately?`;
            }

            await addStep('fas fa-brain', `Generating Response...`, '#d97706');

            setTimeout(() => {
                modal.style.display = 'none';
                input.value = response;
                input.focus();
                input.style.height = 'auto'; 
                input.style.height = input.scrollHeight + 'px';
            }, 600);
        };

        window.sendMessage = async () => {
            const inp = document.getElementById('msg-input');
            const txt = inp.value.trim();
            if(!txt || !activeId) return;
            inp.value = ''; 
            inp.style.height = 'auto';

            const payload = { 
                text: txt, 
                timestamp: serverTimestamp() 
            };

            if(activeType === 'ticket') {
                payload.sender = 'admin';
                await addDoc(collection(db, "support_tickets", activeId, "messages"), payload);
                await updateDoc(doc(db, "support_tickets", activeId), { 
                    lastUpdated: serverTimestamp(), 
                    isReadByUser: false 
                });
            } else {
                payload.senderId = currentUser.uid;
                payload.chatId = activeId;
                await addDoc(collection(db, "messages"), payload);
                await updateDoc(doc(db, "chats", activeId), {
                    lastMessage: txt, 
                    lastUpdated: serverTimestamp(), 
                    lastSenderId: currentUser.uid, 
                    isRead: false
                });
            }
        };

        window.resolveTicket = async () => {
            if(!activeId || activeType !== 'ticket') return;
            if(!confirm("Resolve this ticket?")) return;
            try {
                await updateDoc(doc(db, "support_tickets", activeId), { status: 'resolved', lastUpdated: serverTimestamp() });
                await addDoc(collection(db, "support_tickets", activeId, "messages"), { text: "SYSTEM: Ticket Resolved.", sender: "admin", timestamp: serverTimestamp() });
                Toastify({text: "Ticket Resolved", style:{background:"var(--success)"}}).showToast();
                document.getElementById('resolve-btn').classList.add('hidden');
                document.getElementById('resolve-btn').style.display = 'none';
            } catch(e) { console.error(e); }
        };

        // --- PWA LOGIC ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('pwa-install-popup').style.display = 'block';
        });

        window.installPWA = async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                document.getElementById('pwa-install-popup').style.display = 'none';
            }
            deferredPrompt = null;
        };

        window.dismissPWA = () => {
            document.getElementById('pwa-install-popup').style.display = 'none';
        };

        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("./service-worker.js").catch(e => console.log("SW Fail:", e));
        }

    </script>
</body>
</html>
