<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Support Console | EastLink Admin</title>
    
    <!-- PWA & Meta -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/svg+xml" href="./assets/images/favicon.svg">
    <meta name="theme-color" content="#0F172A">
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <style>
        :root {
            --bg-body: #0F172A;       
            --bg-card: rgba(30, 41, 59, 0.5); 
            --bg-glass: rgba(30, 41, 59, 0.6);
            --bg-glass-heavy: rgba(15, 23, 42, 0.95);
            --bg-input: rgba(255, 255, 255, 0.07);
            --bg-hover: rgba(255, 255, 255, 0.12);
            --border-color: rgba(255, 255, 255, 0.12);
            --text-main: #F8FAFC;     
            --text-muted: #94A3B8; 
            --gold-base: #D97706;
            --gold-gradient: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            --neon-purple: #8b5cf6;
            --success: #10B981;
            --danger: #EF4444;
            --blue: #3B82F6;
            
            --sidebar-width: 260px; 
            --thread-list-width: 360px;
            --header-height: 60px;
            --font-body: 'Inter', sans-serif;
            --font-head: 'Cinzel', serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: var(--font-body); 
            background-color: var(--bg-body); 
            background-image: url('assets/images/background.png');
            background-size: cover; background-position: center; background-attachment: fixed;
            color: var(--text-main); 
            height: 100vh; overflow: hidden; 
            display: flex; flex-direction: column;
        }

        /* --- HEADER --- */
        header {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height);
            background: var(--bg-glass-heavy); backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 20px; z-index: 1000;
        }
        
        .header-left { display: flex; align-items: center; gap: 12px; }
        .logo { font-family: var(--font-head); font-weight: 700; color: var(--text-main); font-size: 1.15rem; text-decoration: none; text-transform: uppercase; letter-spacing: 1px; }
        .logo span { color: var(--gold-base); }
        .admin-badge { font-family: var(--font-body); font-size: 0.55rem; background: var(--bg-input); border: 1px solid var(--border-color); padding: 2px 6px; border-radius: 4px; margin-left: 8px; color: var(--text-muted); letter-spacing: 0.5px; }
        .hamburger { font-size: 1.2rem; cursor: pointer; color: var(--text-muted); display: none; }

        .header-actions { display: flex; align-items: center; gap: 8px; }
        .icon-btn { width: 32px; height: 32px; display: grid; place-items: center; border-radius: 8px; font-size: 0.9rem; color: var(--text-muted); cursor: pointer; transition: 0.3s; position: relative; }
        .icon-btn:hover { background: var(--bg-hover); color: var(--text-main); }
        .notification-badge { position: absolute; top: 2px; right: 2px; min-width: 14px; height: 14px; background: var(--danger); border-radius: 10px; font-size: 0.55rem; color: white; font-weight: 700; display: none; place-items: center; justify-content: center; padding: 0 3px; border: 2px solid var(--bg-card); }
        .profile-widget { width: 34px; height: 34px; background: var(--bg-input); border-radius: 10px; display: grid; place-items: center; border: 1px solid var(--border-color); color: var(--gold-base); font-size: 0.9rem; cursor: pointer; margin-left: 4px; }

        /* --- SIDEBAR --- */
        .sidebar {
            position: fixed; top: var(--header-height); left: 0; width: var(--sidebar-width); height: calc(100vh - var(--header-height));
            background: var(--bg-glass-heavy); border-right: 1px solid var(--border-color); padding: 15px 0; overflow-y: auto; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 999; display: flex; flex-direction: column; 
            backdrop-filter: blur(15px);
        }
        .nav-group { padding: 0 20px; margin-bottom: 15px; }
        .nav-label { font-size: 0.7rem; text-transform: uppercase; color: var(--gold-base); font-weight: 700; margin-bottom: 8px; letter-spacing: 1px; }
        .nav-item { display: flex; align-items: center; padding: 10px 12px; color: var(--text-muted); text-decoration: none; font-size: 0.85rem; transition: 0.3s; border-radius: 8px; margin-bottom: 2px; }
        .nav-item:hover { color: var(--text-main); background: var(--bg-hover); transform: translateX(5px); }
        .nav-item.active { background: rgba(217, 119, 6, 0.1); color: var(--gold-base); font-weight: 600; }
        .nav-item i { width: 22px; text-align: center; margin-right: 8px; }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 998; backdrop-filter: blur(4px); }

        /* --- MAIN LAYOUT --- */
        main { 
            margin-left: var(--sidebar-width); margin-top: var(--header-height); 
            height: calc(100vh - var(--header-height)); width: calc(100% - var(--sidebar-width));
            display: flex; overflow: hidden; padding: 0; 
        }

        /* THREAD SIDEBAR */
        .thread-sidebar {
            width: var(--thread-list-width); height: 100%;
            background: rgba(15, 23, 42, 0.4); 
            border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; z-index: 50; flex-shrink: 0;
            backdrop-filter: blur(10px);
        }
        .search-area { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 12px; background: rgba(15,23,42,0.3); }
        
        .search-row-wrap { display: flex; gap: 8px; align-items: center; }
        .search-wrap input { width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; color: var(--text-main); font-family: var(--font-body); }
        
        .btn-new-msg {
            width: 40px; height: 40px; border-radius: 8px; background: var(--gold-gradient);
            color: #000; border: none; font-size: 1.2rem; cursor: pointer; display: grid; place-items: center;
            flex-shrink: 0; transition: 0.2s;
        }
        .btn-new-msg:hover { transform: scale(1.05); }

        .filter-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .filter-chip { 
            white-space: nowrap; padding: 6px 14px; border-radius: 20px; font-size: 0.7rem; font-weight: 500;
            background: var(--bg-input); border: 1px solid var(--border-color); 
            color: var(--text-muted); cursor: pointer; transition: 0.3s; 
        }
        .filter-chip.active { background: var(--gold-gradient); color: #000; font-weight: 700; border-color: transparent; box-shadow: 0 4px 12px rgba(217,119,6,0.2); }
        
        .thread-list { flex: 1; overflow-y: auto; }
        .thread-item {
            padding: 16px 20px; display: flex; gap: 14px; align-items: center; cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.03); transition: 0.2s; position: relative;
        }
        .thread-item:hover { background: var(--bg-hover); }
        .thread-item.active { background: rgba(217, 119, 6, 0.1); border-left: 3px solid var(--gold-base); }
        .thread-item.pinned { background: rgba(217,119,6,0.05); border-left: 3px solid var(--text-muted); }
        .thread-item.pinned.active { border-left: 3px solid var(--gold-base); }

        .u-avatar { 
            width: 42px; height: 42px; border-radius: 10px; background: var(--bg-input); 
            display: grid; place-items: center; font-weight: 700; color: var(--gold-base); 
            border: 1px solid var(--border-color); flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .u-avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        .u-info { flex: 1; overflow: hidden; }
        .u-head { display: flex; justify-content: space-between; margin-bottom: 4px; align-items: center; }
        .u-name { font-weight: 600; font-size: 0.95rem; color: var(--text-main); }
        .u-time { font-size: 0.7rem; color: var(--text-muted); font-family: 'Space Grotesk', sans-serif; }
        
        /* Clean UI: Message preview styling */
        .u-msg { font-size: 0.8rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .u-msg.bold { font-weight: 600; color: var(--text-main); }
        
        .cat-tag { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-right: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .cat-ticket { background: rgba(139, 92, 246, 0.15); color: var(--neon-purple); border: 1px solid rgba(139, 92, 246, 0.3); }
        .cat-dm { background: rgba(59, 130, 246, 0.15); color: var(--blue); border: 1px solid rgba(59, 130, 246, 0.3); }

        .thread-badge { background: var(--gold-gradient); color: #000; font-weight: 700; font-size: 0.65rem; min-width: 18px; height: 18px; border-radius: 9px; display: flex; align-items: center; justify-content: center; padding: 0 5px; margin-left: 5px; }
        .pin-icon { font-size: 0.7rem; color: var(--text-muted); transform: rotate(45deg); margin-right: 5px; }

        /* CHAT AREA */
        .chat-area { 
            flex: 1; display: flex; flex-direction: column; 
            background: rgba(15, 23, 42, 0.3); 
            position: relative; backdrop-filter: blur(10px); 
        }
        
        .cv-header { 
            height: 70px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; 
            justify-content: space-between; padding: 0 24px; background: var(--bg-glass-heavy); z-index: 50;
        }
        
        /* IN-CHAT SEARCH BAR */
        .chat-search-bar {
            position: absolute; top: 65px; left: 0; right: 0; background: var(--bg-glass-heavy);
            padding: 10px 20px; border-bottom: 1px solid var(--border-color); z-index: 40;
            display: none; animation: slideDown 0.3s forwards;
        }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
        .chat-search-input { width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 8px; color: var(--text-main); }

        .back-btn { margin-right: 15px; font-size: 1.2rem; color: var(--text-muted); cursor: pointer; display: none; }
        
        .chat-tools { display: flex; align-items: center; gap: 10px; }
        .tool-btn { width: 32px; height: 32px; border-radius: 50%; display: grid; place-items: center; cursor: pointer; color: var(--text-muted); transition: 0.3s; }
        .tool-btn:hover { background: var(--bg-hover); color: var(--text-main); }

        /* MESSAGES & ACTIONS (MATCHING SEEKER STYLE) */
        .messages-feed { 
            flex: 1; overflow-y: auto; padding: 24px; 
            display: flex; flex-direction: column; gap: 8px; 
            scroll-behavior: smooth; position: relative; 
        }
        
        .date-divider { text-align: center; margin: 15px 0; font-size: 0.7rem; color: var(--text-muted); opacity: 0.8; font-weight: 500; font-family: 'Space Grotesk', sans-serif; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .date-divider::before, .date-divider::after { content: ''; width: 30px; height: 1px; background: var(--border-color); }

        .msg-row { display: flex; width: 100%; margin-bottom: 2px; }
        .msg-row.sent { justify-content: flex-end; }
        .msg-row.received { justify-content: flex-start; }

        .msg-content { max-width: 75%; display: flex; flex-direction: column; }
        .msg-row.sent .msg-content { align-items: flex-end; }
        .msg-row.received .msg-content { align-items: flex-start; }

        .msg-bubble { 
            padding: 10px 14px; 
            border-radius: 12px; 
            font-size: 0.95rem; 
            line-height: 1.5; 
            position: relative; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); 
            transition: 0.2s;
            word-wrap: break-word;
        }
        
        /* Seeker-Style Bubbles */
        .msg-row.sent .msg-bubble { 
            background: var(--gold-gradient); 
            color: #000; 
            font-weight: 500; 
            border-bottom-right-radius: 2px; 
        }
        .msg-row.received .msg-bubble { 
            background: var(--bg-glass-heavy); 
            border: 1px solid var(--border-color); 
            color: var(--text-main); 
            border-bottom-left-radius: 2px; 
        }

        .msg-meta {
            font-size: 0.65rem; margin-top: 3px; 
            display: flex; align-items: center; gap: 4px;
            font-family: 'Space Grotesk', sans-serif; opacity: 0.7;
        }
        .msg-row.sent .msg-meta { justify-content: flex-end; color: rgba(255,255,255,0.6); }
        .msg-row.received .msg-meta { justify-content: flex-start; color: var(--text-muted); }

        /* TICKS */
        .tick-icon { font-size: 0.7rem; margin-left: 3px; }
        .tick-read { color: #60a5fa; } /* Blue ticks */
        .tick-sent { color: rgba(255,255,255,0.6); }

        /* Context Menu Styles */
        .context-menu {
            position: fixed; display: none; flex-direction: column;
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px);
            border: 1px solid var(--border-color); border-radius: 12px;
            padding: 6px; width: 180px; z-index: 5000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: fadeIn 0.15s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .ctx-item {
            padding: 10px 12px; border-radius: 8px; color: var(--text-main);
            font-size: 0.85rem; display: flex; align-items: center; gap: 10px;
            cursor: pointer; transition: 0.2s;
        }
        .ctx-item:hover { background: var(--bg-hover); }
        .ctx-item.danger { color: var(--danger); }
        .ctx-item.danger:hover { background: rgba(239, 68, 68, 0.1); }
        .ctx-divider { height: 1px; background: var(--border-color); margin: 4px 0; }

        .msg-selected { transform: scale(0.98); opacity: 0.8; }

        /* Quote Reply */
        .quote-box {
            background: rgba(139, 92, 246, 0.1); border-left: 3px solid var(--neon-purple);
            padding: 8px; margin-bottom: 8px; border-radius: 4px; font-size: 0.8rem; color: var(--text-muted);
            display: none; animation: slideIn 0.2s;
        }
        .quote-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .input-zone { background: var(--bg-glass-heavy); padding: 15px 20px; border-top: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .input-wrapper { display: flex; gap: 12px; align-items: flex-end; width: 100%; }

        .chat-input { 
            flex: 1; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 12px; 
            padding: 12px; color: var(--text-main); resize: none; min-height: 46px; max-height: 150px; 
            font-family: var(--font-body); font-size: 0.95rem; overflow:hidden;
        }
        .chat-input:focus { border-color: var(--gold-base); background: var(--bg-hover); }
        
        .send-btn { width: 46px; height: 46px; background: var(--gold-gradient); border: none; border-radius: 12px; color: black; font-size: 1.1rem; cursor: pointer; transition: 0.3s; display: grid; place-items: center;}
        .send-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(217,119,6,0.3); }
        
        .ai-btn { color: var(--neon-purple); border: 1px solid var(--neon-purple); background: rgba(139, 92, 246, 0.1); width: 46px; height: 46px; border-radius: 12px; cursor: pointer; transition: 0.3s; display: grid; place-items: center; font-size: 1.1rem; }
        .ai-btn:hover { background: var(--neon-purple); color: white; box-shadow: 0 0 15px rgba(139, 92, 246, 0.5); transform: rotate(15deg); }

        /* AI POPUP */
        .ai-popup { 
            position: absolute; bottom: 80px; left: 20px; right: 20px; 
            background: rgba(15, 23, 42, 0.98); border: 1px solid var(--neon-purple); border-radius: 16px; 
            padding: 20px; box-shadow: 0 -10px 40px rgba(139, 92, 246, 0.2); z-index: 200; display: none; backdrop-filter: blur(20px);
        }
        .ai-step { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 8px; opacity: 0; animation: fadeInUp 0.4s forwards; display: flex; align-items: center; gap: 12px; font-family: 'Space Grotesk', sans-serif; }

        /* NEW CHAT MODAL */
        .new-chat-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
            z-index: 3000; display: none; justify-content: center; padding-top: 80px;
        }
        .nc-content {
            width: 90%; max-width: 500px; background: var(--bg-glass-heavy);
            border: 1px solid var(--border-color); border-radius: 16px;
            max-height: 80vh; display: flex; flex-direction: column;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6); animation: zoomIn 0.3s;
        }
        .nc-header { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .nc-search-box { padding: 15px; border-bottom: 1px solid var(--border-color); background: rgba(255,255,255,0.02); }
        .nc-input { width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); padding: 12px; border-radius: 10px; color: var(--text-main); font-family: var(--font-body); }
        .nc-list { flex: 1; overflow-y: auto; padding: 10px 0; }
        .nc-user-item { 
            display: flex; align-items: center; gap: 15px; padding: 12px 20px; 
            cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.02); 
            transition: 0.2s; 
        }
        .nc-user-item:hover { background: var(--bg-hover); }
        .nc-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--gold-gradient); color: #000; display: grid; place-items: center; font-weight: 700; flex-shrink: 0; overflow: hidden; }
        .nc-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .nc-info h4 { margin: 0; color: var(--text-main); font-size: 0.95rem; }
        .nc-info p { margin: 2px 0 0; color: var(--text-muted); font-size: 0.8rem; }
        .nc-btn-chat { margin-left: auto; width: 32px; height: 32px; border-radius: 8px; background: rgba(139, 92, 246, 0.1); color: var(--neon-purple); display: grid; place-items: center; }

        /* PWA Popup */
        .pwa-install-popup {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px); border: 1px solid var(--gold-base);
            border-radius: 20px; padding: 20px; z-index: 3000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: none;
            animation: slideUp 0.5s ease;
        }
        @keyframes slideUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        .pwa-content { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .pwa-icon { width: 50px; height: 50px; border-radius: 12px; background: var(--gold-gradient); display: grid; place-items: center; font-size: 1.5rem; color: #000; }
        .pwa-actions { display: flex; gap: 10px; }
        .btn-pwa-install { flex: 2; padding: 10px; background: var(--gold-gradient); border: none; border-radius: 10px; font-weight: 700; cursor: pointer; color: #000; }
        .btn-pwa-dismiss { flex: 1; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-muted); cursor: pointer; }

        @media (max-width: 992px) {
            .sidebar { transform: translateX(-100%); } .sidebar.active { transform: translateX(0); }
            .hamburger, .back-btn { display: block; }
            main { margin-left: 0; width: 100%; display: block; height: calc(100vh - var(--header-height)); }
            .thread-sidebar { width: 100%; height: 100%; display: flex; }
            
            .chat-area { 
                display: none; width: 100%; height: 100%; position: fixed; top: 0; left: 0; z-index: 2000; 
                background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); flex-direction: column;
            }
            body.chat-active .thread-sidebar { display: none; }
            body.chat-active .chat-area { display: flex; }
            
            .cv-header { padding-top: env(safe-area-inset-top, 10px); height: auto; min-height: 70px; }
            .input-zone { padding: 10px 15px; padding-bottom: max(10px, env(safe-area-inset-bottom, 20px)); }
            .nc-content { width: 100%; height: 100%; border-radius: 0; max-height: 100%; padding-top: 20px; }
        }
    </style>
</head>
<body>

    <!-- CONTEXT MENUS (HIDDEN) -->
    <div id="thread-ctx-menu" class="context-menu">
        <div class="ctx-item" id="ctx-pin" onclick="toggleThreadPin()"><i class="fas fa-thumbtack"></i> Pin Chat</div>
        <div class="ctx-item" id="ctx-resolve" onclick="resolveOrArchive()"><i class="fas fa-check-circle"></i> Resolve</div>
        <div class="ctx-divider"></div>
        <div class="ctx-item danger" onclick="deleteThread()"><i class="fas fa-trash"></i> Delete</div>
    </div>

    <div id="msg-ctx-menu" class="context-menu">
        <div class="ctx-item" onclick="replyMsgAction()"><i class="fas fa-reply"></i> Reply</div>
        <div class="ctx-item" onclick="copyMsgAction()"><i class="fas fa-copy"></i> Copy Text</div>
        <div class="ctx-divider"></div>
        <div class="ctx-item danger" onclick="deleteMsgAction()"><i class="fas fa-trash"></i> Delete</div>
    </div>

    <!-- HEADER -->
    <header>
        <div class="header-left">
            <i class="fas fa-bars hamburger" onclick="toggleSidebar()"></i>
            <a href="admin-dashboard.html" class="logo">East<span>Link</span> <span class="admin-badge">ADMIN</span></a>
        </div>
        <div class="header-actions">
            <div class="icon-btn active" onclick="location.href='admin-support.html'" title="Support Tickets" style="color:var(--gold-base); background:rgba(217,119,6,0.1);">
                <i class="fa-solid fa-envelope"></i><div class="notification-badge" id="msg-badge">0</div>
            </div>
            <div class="icon-btn" onclick="location.href='admin-notifications.html'" title="System Alerts">
                <i class="fa-solid fa-bell"></i><div class="notification-badge" id="notif-badge">0</div>
            </div>
            <div class="profile-widget" onclick="location.href='admin-settings.html'" title="Admin Settings"><i class="fa-solid fa-user-shield"></i></div>
            <div class="icon-btn" onclick="logout()" style="color:var(--danger);" title="Logout">
                <i class="fa-solid fa-power-off"></i>
            </div>
        </div>
    </header>

    <!-- SIDEBAR -->
    <nav class="sidebar" id="sidebar">
        <div class="nav-group">
            <div class="nav-label">Analytics</div>
            <a href="admin-dashboard.html" class="nav-item"><i class="fa-solid fa-chart-pie"></i> Dashboard</a>
        </div>
        <div class="nav-group">
            <div class="nav-label">User Management</div>
            <a href="admin-users.html" class="nav-item"><i class="fa-solid fa-users"></i> Manage Users</a>
            <a href="admin-plans.html" class="nav-item"><i class="fa-solid fa-tags"></i> Manage Plans</a>
            <a href="admin-referrals.html" class="nav-item"><i class="fa-solid fa-share-nodes"></i> Referrals</a>
        </div>
        <div class="nav-group">
            <div class="nav-label">Jobs & Service</div>
            <a href="admin-jobs-mod.html" class="nav-item"><i class="fa-solid fa-briefcase"></i> Job Approvals</a>
            <a href="admin-guaranteed-jobs.html" class="nav-item link-pro"><i class="fa-solid fa-certificate" style="color:var(--gold-base);"></i> Guaranteed Jobs</a>
            <a href="admin-post-guaranteed.html" class="nav-item"><i class="fa-solid fa-plus-circle"></i> Post Vacancy</a>
        </div>
        <div class="nav-group">
            <div class="nav-label">Finance</div>
            <a href="admin-deposits.html" class="nav-item"><i class="fa-solid fa-arrow-down" style="color:var(--success);"></i> Deposits</a>
            <a href="admin-withdrawals.html" class="nav-item"><i class="fa-solid fa-arrow-up" style="color:var(--danger);"></i> Withdrawals</a>
            <a href="admin-deposit-issues.html" class="nav-item"><i class="fas fa-exclamation-triangle"></i> Errors</a>
        </div>
        <div class="nav-group">
            <div class="nav-label">System</div>
            <a href="admin-settings.html" class="nav-item"><i class="fa-solid fa-sliders"></i> Settings</a>
        </div>
    </nav>
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <!-- MAIN -->
    <main>
        <!-- THREADS -->
        <aside class="thread-sidebar">
            <div class="search-area">
                <div class="search-row-wrap">
                    <div class="search-wrap" style="flex:1;">
                        <input type="text" id="search-input" placeholder="Search conversations..." onkeyup="renderList()">
                    </div>
                    <!-- PLUS BUTTON -->
                    <button class="btn-new-msg" onclick="openNewChatModal()" title="New Direct Message">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="filter-row">
                    <div class="filter-chip active" onclick="setFilter('all', this)">All</div>
                    <div class="filter-chip" onclick="setFilter('ticket', this)"><i class="fas fa-ticket-alt"></i> Tickets</div>
                    <div class="filter-chip" onclick="setFilter('dm', this)"><i class="fas fa-comment-alt"></i> DMs</div>
                </div>
            </div>
            <div class="thread-list" id="thread-list">
                <div style="text-align:center; padding:40px; color:var(--text-muted);"><i class="fas fa-circle-notch fa-spin"></i> Syncing...</div>
            </div>
        </aside>

        <!-- CHAT -->
        <section class="chat-area" id="chat-ui">
            <!-- Empty State -->
            <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; opacity:0.6;" id="empty-state">
                <div style="width:100px; height:100px; background:var(--bg-input); border-radius:50%; display:grid; place-items:center; margin-bottom:20px; border:1px solid var(--border-color);">
                    <i class="fas fa-comments" style="font-size:3rem; color:var(--gold-base);"></i>
                </div>
                <h3 style="font-family:var(--font-head);">Support Console</h3>
                <p style="color:var(--text-muted);">Select a conversation to begin.</p>
            </div>

            <!-- Chat View -->
            <div id="chat-view" style="display:none; flex-direction:column; height:100%; width:100%;">
                <div class="cv-header">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <i class="fas fa-arrow-left back-btn" onclick="closeChat()"></i>
                        <div class="u-avatar" id="active-avatar">U</div>
                        <div style="display:flex; flex-direction:column;">
                            <h4 id="active-name" style="margin:0; color:var(--text-main); font-size:1rem; line-height:1.2;">User</h4>
                            <span id="active-email" style="font-size:0.75rem; color:var(--text-muted);">email@example.com</span>
                        </div>
                    </div>
                    
                    <div class="chat-tools">
                        <div class="tool-btn" onclick="toggleChatSearch()" title="Search in Chat"><i class="fas fa-search"></i></div>
                    </div>
                </div>
                
                <!-- In-Chat Search -->
                <div class="chat-search-bar" id="chat-search-bar">
                    <input type="text" id="chat-search-input" class="chat-search-input" placeholder="Find in conversation..." onkeyup="filterChatMessages()">
                </div>

                <div class="messages-feed" id="feed"></div>

                <!-- AI -->
                <div class="ai-popup animate__animated animate__fadeInUp" id="ai-modal">
                    <div style="color:var(--neon-purple); font-weight:700; margin-bottom:15px; display:flex; align-items:center; gap:8px;">
                        <i class="fas fa-brain animate__animated animate__pulse animate__infinite"></i> EastLink AI Cortex
                    </div>
                    <div id="ai-steps"></div>
                </div>

                <div class="input-zone">
                    <div id="reply-quote" class="quote-box">
                        <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                            <span style="font-weight:600; color:var(--neon-purple);">Replying to user</span>
                            <i class="fas fa-times" onclick="cancelReply()" style="cursor:pointer;"></i>
                        </div>
                        <div id="quote-text" class="quote-text">...</div>
                    </div>
                    <div class="input-wrapper">
                        <button class="ai-btn" onclick="triggerAI()" title="Smart Reply"><i class="fas fa-wand-magic-sparkles"></i></button>
                        <textarea id="msg-input" class="chat-input" placeholder="Type a message..." rows="1"></textarea>
                        <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- NEW CHAT MODAL -->
    <div id="new-chat-modal" class="new-chat-modal" onclick="closeNewChatModal(event)">
        <div class="nc-content" onclick="event.stopPropagation()">
            <div class="nc-header">
                <h3 style="color:var(--text-main); font-family:var(--font-head);">New Message</h3>
                <i class="fas fa-times" onclick="closeNewChatModal(event)" style="cursor:pointer; font-size:1.2rem; color:var(--text-muted);"></i>
            </div>
            <div class="nc-search-box">
                <input type="text" id="nc-search" class="nc-input" placeholder="Search by name or email..." onkeyup="filterNewChatUsers()">
            </div>
            <div class="nc-list" id="nc-list">
                <div style="text-align:center; padding:20px; color:var(--text-muted);"><i class="fas fa-circle-notch fa-spin"></i> Loading users...</div>
            </div>
        </div>
    </div>

    <!-- PWA INSTALL POPUP -->
    <div id="pwa-install-popup" class="pwa-install-popup">
        <div class="pwa-content">
            <div class="pwa-icon"><i class="fas fa-download"></i></div>
            <div>
                <div style="font-weight:700; color:#fff; font-size:1rem; margin-bottom:4px;">Install Admin App</div>
                <div style="font-size:0.8rem; color:#94A3B8;">Add to home screen for quick access.</div>
            </div>
        </div>
        <div class="pwa-actions">
            <button class="btn-pwa-install" onclick="installPWA()">Install</button>
            <button class="btn-pwa-dismiss" onclick="dismissPWA()">Later</button>
        </div>
    </div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script type="module">
        import { auth, db } from './config.js'; 
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { collection, onSnapshot, query, limit, addDoc, doc, getDocs, serverTimestamp, updateDoc, setDoc, where, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        let currentUser = null;
        let allItems = [];
        let usersMap = {}; 
        let activeId = null, activeType = null, activeUser = null;
        let msgUnsub = null;
        let lastUserMessageText = "";
        let currentFilter = 'all';
        let allUsersList = [];
        let threadCtxId = null; 
        let ctxMsgId = null;
        let ctxMsgText = null;
        let replyingTo = null; // Store quote context

        // --- GLOBAL UI HANDLERS ---
        window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').style.display = document.getElementById('sidebar').classList.contains('active') ? 'block' : 'none'; };
        window.logout = () => { if(confirm("Log Out?")) signOut(auth).then(()=>location.href='signin.html'); };

        // Auto-Resize Textarea
        const tx = document.getElementById('msg-input');
        tx.setAttribute("style", "height:46px;overflow-y:hidden;");
        tx.addEventListener("input", OnInput, false);
        function OnInput() {
            this.style.height = 0;
            this.style.height = (this.scrollHeight) + "px";
        }

        // Close Context Menus
        window.onclick = (e) => {
            if(!e.target.closest('.context-menu')) {
                document.querySelectorAll('.context-menu').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.msg-selected').forEach(el => el.classList.remove('msg-selected'));
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if(!user) return location.href = 'signin.html';
            currentUser = user;
            initBadges(); 
            
            try {
                const uSnap = await getDocs(collection(db, "users"));
                allUsersList = [];
                uSnap.forEach(d => { 
                    const data = d.data();
                    usersMap[d.id] = data; 
                    allUsersList.push({ id: d.id, ...data });
                });
            } catch(e) { console.error("Error loading users map", e); }
            
            loadConversations();
        });

        function initBadges() {
            onSnapshot(query(collection(db, "transactions"), where("status", "==", "pending")), s => {
                const b = document.getElementById('notif-badge'); 
                if(b) {
                    b.innerText = s.size; 
                    b.style.display = s.size > 0 ? 'flex' : 'none';
                }
            });
            onSnapshot(query(collection(db, "support_tickets"), where("status", "==", "open")), s => {
                const b = document.getElementById('msg-badge'); 
                if(b) {
                    b.innerText = s.size; 
                    b.style.display = s.size > 0 ? 'flex' : 'none';
                }
            });
        }

        function loadConversations() {
            const tQuery = query(collection(db, "support_tickets"), limit(50));
            const cQuery = query(collection(db, "chats"), limit(50));
            let tickets = [], chats = [];

            const updateUI = () => {
                allItems = [...tickets, ...chats].sort((a,b) => (b.updated || 0) - (a.updated || 0));
                renderList();
            };

            onSnapshot(tQuery, s => {
                tickets = s.docs.map(d => { 
                    const dt = d.data(); 
                    const u = usersMap[dt.userId] || {};
                    const email = dt.userEmail || u.email || "No Email";
                    const avatar = u.profileImage || u.logoUrl || null;

                    return { 
                        id: d.id, 
                        type: 'ticket', 
                        title: dt.userName||"Support User", 
                        sub: email, // We keep email here for reference, but UI won't show it in list
                        avatar: avatar,
                        msg: `Status: ${dt.status}`, 
                        updated: dt.lastUpdated?.seconds||0, 
                        unreadCount: !dt.isReadByAdmin?1:0, 
                        isPinned: dt.isPinned || false,
                        data: dt 
                    }; 
                });
                updateUI();
            });

            onSnapshot(cQuery, s => {
                chats = s.docs.map(d => { 
                    const dt = d.data(); 
                    const pid = (dt.participants||[]).find(p=>p!==currentUser.uid); 
                    const u = usersMap[pid]||{fullName:dt.seekerName||"User"}; 
                    const avatar = u.profileImage || u.logoUrl || null;

                    return { 
                        id: d.id, 
                        type: 'dm', 
                        title: u.fullName || u.companyName || "User", 
                        sub: u.email || "No Email", 
                        avatar: avatar,
                        msg: dt.lastMessage||"...", 
                        updated: dt.lastUpdated?.seconds||0, 
                        unreadCount: (!dt.isRead&&dt.lastSenderId!==currentUser.uid)?1:0, 
                        isPinned: dt.pinnedBy && dt.pinnedBy.includes(currentUser.uid),
                        partnerId: pid, 
                        data: dt 
                    }; 
                });
                updateUI();
            });
        }

        window.setFilter = (type, el) => { 
            currentFilter = type; 
            document.querySelectorAll('.filter-chip').forEach(e => e.classList.remove('active')); 
            el.classList.add('active'); 
            renderList(); 
        };

        window.renderList = () => {
            const list = document.getElementById('thread-list');
            const search = document.getElementById('search-input').value.toLowerCase();
            
            const sortedItems = [...allItems].sort((a, b) => {
                if (a.isPinned !== b.isPinned) return b.isPinned ? 1 : -1;
                return b.updated - a.updated;
            });

            const filtered = sortedItems.filter(i => (i.title.toLowerCase().includes(search) || (i.sub && i.sub.toLowerCase().includes(search))) && (currentFilter === 'all' || i.type === currentFilter));
            
            if(filtered.length === 0) {
                list.innerHTML = '<div style="padding:40px; text-align:center; opacity:0.5;">No conversations found.</div>';
                return;
            }

            // LIST RENDERER: REMOVED EMAIL FROM UI (only shows name and message snippet)
            list.innerHTML = filtered.map(i => {
                // Determine avatar HTML
                let avatarHtml = '';
                if (i.avatar) {
                    avatarHtml = `<img src="${i.avatar}" alt="${i.title.charAt(0)}">`;
                } else {
                    avatarHtml = i.title.charAt(0).toUpperCase();
                }
                
                // Format the time display for the list item
                let timeDisplay = '';
                if(i.updated > 0) {
                     const dateObj = new Date(i.updated * 1000);
                     const now = new Date();
                     const isToday = dateObj.toDateString() === now.toDateString();
                     
                     // If today, show time (e.g. 14:30), otherwise show Date (e.g. Oct 24)
                     if(isToday) {
                         timeDisplay = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
                     } else {
                         timeDisplay = dateObj.toLocaleDateString(undefined, { month:'short', day:'numeric' });
                     }
                }

                return `
                <div class="thread-item animate__animated animate__fadeInLeft ${activeId === i.id ? 'active' : ''} ${i.isPinned ? 'pinned' : ''}" 
                     onclick="openChat('${i.id}', '${i.type}')"
                     oncontextmenu="window.openThreadMenu(event, '${i.id}', '${i.type}', ${i.isPinned})">
                    
                    <div class="u-avatar">${avatarHtml}</div>
                    <div class="u-info">
                        <div class="u-head">
                            <span class="u-name">
                                ${i.type==='ticket'?'<span class="cat-tag cat-ticket">TICKET</span>':'<span class="cat-tag cat-dm">DM</span>'} 
                                ${i.title}
                            </span> 
                            <span style="display:flex;align-items:center;">
                                <span class="u-time">${timeDisplay}</span> 
                                ${i.unreadCount>0?`<div class="thread-badge">${i.unreadCount}</div>`:''}
                            </span>
                        </div>
                        
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="u-msg ${i.unreadCount>0?'bold':''}">${escapeHtml(i.msg)}</div>
                            ${i.isPinned ? '<i class="fas fa-thumbtack pin-icon"></i>' : ''}
                        </div>
                    </div>
                </div>
            `}).join('');
        };
        
        function formatDateShort(seconds) {
            if(!seconds) return '';
            const d = new Date(seconds * 1000);
            return d.toLocaleDateString(undefined, {month:'short', day:'numeric'});
        }

        // --- CONTEXT MENUS ---
        window.openThreadMenu = (e, id, type, isPinned) => {
            e.preventDefault();
            threadCtxId = id;
            document.getElementById('ctx-pin').innerHTML = isPinned 
                ? '<i class="fas fa-thumbtack" style="color:var(--text-muted)"></i> Unpin Chat' 
                : '<i class="fas fa-thumbtack"></i> Pin Chat';
            
            const resolveBtn = document.getElementById('ctx-resolve');
            if(type === 'ticket') {
                resolveBtn.innerHTML = '<i class="fas fa-check-circle"></i> Resolve Ticket';
                resolveBtn.style.display = 'flex';
            } else {
                 resolveBtn.style.display = 'none'; 
            }

            const menu = document.getElementById('thread-ctx-menu');
            menu.style.display = 'flex';
            
            let x = e.clientX, y = e.clientY;
            if (x + 180 > window.innerWidth) x = window.innerWidth - 190;
            if (y + 150 > window.innerHeight) y = window.innerHeight - 160;
            menu.style.top = `${y}px`; menu.style.left = `${x}px`;
        };

        window.toggleThreadPin = async () => {
            if(!threadCtxId) return;
            const item = allItems.find(i => i.id === threadCtxId);
            if(!item) return;

            try {
                if(item.type === 'ticket') {
                    await updateDoc(doc(db, "support_tickets", threadCtxId), { isPinned: !item.isPinned });
                } else {
                    let newPins = item.data.pinnedBy || [];
                    if(item.isPinned) newPins = newPins.filter(uid => uid !== currentUser.uid);
                    else newPins.push(currentUser.uid);
                    await updateDoc(doc(db, "chats", threadCtxId), { pinnedBy: newPins });
                }
                Toastify({text: item.isPinned ? "Unpinned" : "Pinned", style:{background:"var(--bg-card)"}}).showToast();
            } catch(e) { console.error(e); }
            document.getElementById('thread-ctx-menu').style.display = 'none';
        };

        window.resolveOrArchive = async () => {
            if(!threadCtxId) return;
            const item = allItems.find(i => i.id === threadCtxId);
            if(item.type === 'ticket' && confirm("Mark ticket as resolved?")) {
                await updateDoc(doc(db, "support_tickets", threadCtxId), { status: 'resolved' });
                Toastify({text: "Ticket Resolved", style:{background:"var(--success)"}}).showToast();
            }
            document.getElementById('thread-ctx-menu').style.display = 'none';
        };

        window.deleteThread = async () => {
            if(!threadCtxId || !confirm("Permanently delete this conversation?")) return;
            const item = allItems.find(i => i.id === threadCtxId);
            try {
                if(item.type === 'ticket') await deleteDoc(doc(db, "support_tickets", threadCtxId));
                else await deleteDoc(doc(db, "chats", threadCtxId));
                Toastify({text: "Deleted", style:{background:"var(--danger)"}}).showToast();
                if(activeId === threadCtxId) window.closeChat();
            } catch(e) { console.error(e); }
            document.getElementById('thread-ctx-menu').style.display = 'none';
        };

        // --- NEW CHAT / USER SEARCH MODAL ---
        window.openNewChatModal = () => {
            document.getElementById('new-chat-modal').style.display = 'flex';
            document.getElementById('nc-search').focus();
            renderUserList(allUsersList);
        };

        window.closeNewChatModal = (e) => {
            if (e && e.target !== e.currentTarget && e.target.closest('.nc-content')) return; 
            document.getElementById('new-chat-modal').style.display = 'none';
        };

        window.filterNewChatUsers = () => {
            const term = document.getElementById('nc-search').value.toLowerCase();
            const filtered = allUsersList.filter(u => 
                (u.fullName && u.fullName.toLowerCase().includes(term)) || 
                (u.email && u.email.toLowerCase().includes(term)) ||
                (u.companyName && u.companyName.toLowerCase().includes(term))
            );
            renderUserList(filtered);
        };

        function renderUserList(users) {
            const list = document.getElementById('nc-list');
            if(users.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-muted);">No users found.</div>`;
                return;
            }
            
            list.innerHTML = users.map(u => {
                const name = u.fullName || u.companyName || "Unknown User";
                const email = u.email || "No Email";
                const avatarUrl = u.profileImage || u.logoUrl;
                let avHtml = avatarUrl ? `<img src="${avatarUrl}">` : name.charAt(0).toUpperCase();

                return `
                <div class="nc-user-item" onclick="startDirectMessage('${u.id}', '${name.replace(/'/g, "\\'")}')">
                    <div class="nc-avatar">${avHtml}</div>
                    <div class="nc-info">
                        <h4>${name} <span style="font-size:0.7rem; color:var(--text-muted); border:1px solid var(--border-color); padding:1px 4px; border-radius:4px; margin-left:6px;">${u.role || 'User'}</span></h4>
                        <p>${email}</p>
                    </div>
                    <div class="nc-btn-chat"><i class="fas fa-paper-plane"></i></div>
                </div>
                `;
            }).join('');
        }

        window.startDirectMessage = async (targetUid, targetName) => {
            window.closeNewChatModal();
            const existing = allItems.find(i => i.type === 'dm' && i.partnerId === targetUid);
            if(existing) { openChat(existing.id, 'dm'); return; }

            try {
                const coll = collection(db, "chats");
                const newChat = {
                    participants: [currentUser.uid, targetUid],
                    lastMessage: "Conversation started",
                    lastSenderId: currentUser.uid,
                    lastUpdated: serverTimestamp(),
                    isRead: true,
                    unreadCount: 0,
                    startedByAdmin: true
                };

                const docRef = await addDoc(coll, newChat);
                // Pre-fill cache
                usersMap[targetUid] = { ...usersMap[targetUid], fullName: targetName }; 
                activeId = docRef.id; activeType = 'dm';
                
                // Temp UI update
                allItems.unshift({
                    id: docRef.id, type: 'dm', title: targetName,
                    sub: usersMap[targetUid]?.email || "No Email",
                    msg: "Conversation started", updated: Date.now()/1000,
                    unreadCount: 0, partnerId: targetUid, data: newChat
                });
                renderList();
                openChat(docRef.id, 'dm');
                Toastify({text: `Chat started with ${targetName}`, style:{background:"var(--success)"}}).showToast();
            } catch(e) { console.error(e); }
        };

        // --- OPEN CHAT LOGIC ---
        window.openChat = async (id, type) => {
            activeId = id; activeType = type;
            const item = allItems.find(i => i.id === id);
            activeUser = item;
            
            document.body.classList.add('chat-active');
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('chat-view').style.display = 'flex';
            
            // Header Info
            document.getElementById('active-name').innerText = item ? item.title : "User";
            document.getElementById('active-email').innerText = item ? item.sub : "";
            
            const avEl = document.getElementById('active-avatar');
            if (item && item.avatar) {
                avEl.innerHTML = `<img src="${item.avatar}">`;
            } else {
                avEl.innerHTML = item ? item.title.charAt(0) : "U";
            }
            
            // Mark Read
            if(item && item.unreadCount > 0) {
                try {
                    if(type === 'ticket') updateDoc(doc(db, "support_tickets", id), { isReadByAdmin: true });
                    else updateDoc(doc(db, "chats", id), { isRead: true, unreadCount: 0 });
                } catch(e){}
            }
            renderList();

            if(msgUnsub) msgUnsub();
            const feed = document.getElementById('feed');
            feed.innerHTML = '<div style="flex:1; display:flex; align-items:center; justify-content:center; color:var(--text-muted);"><i class="fas fa-circle-notch fa-spin" style="font-size:1.5rem;"></i></div>';
            
            let q;
            // Sorting Logic: Use 'asc' to put oldest at top, newest at bottom (Standard Chat Flow)
            if (type === 'ticket') {
                q = query(collection(db, "support_tickets", id, "messages"), orderBy("timestamp", "asc"));
            } else {
                q = query(collection(db, "messages"), where("chatId", "==", id), orderBy("timestamp", "asc"));
            }
            
            msgUnsub = onSnapshot(q, snap => {
                feed.innerHTML = "";
                let msgs = [];
                snap.forEach(d => { msgs.push({id: d.id, ...d.data()}); });

                if(msgs.length === 0) {
                    feed.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">No messages yet.</div>';
                    return;
                }
                
                // Ensure sorting logic matches query (Ascending = Oldest First)
                msgs.sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

                const userMsgs = msgs.filter(m => type==='ticket' ? (m.sender!=='admin' && m.sender!=='agent') : (m.senderId!==currentUser.uid));
                if(userMsgs.length > 0) lastUserMessageText = userMsgs[userMsgs.length-1].text;

                let lastDate = "";

                msgs.forEach(m => {
                    const isMe = type === 'ticket' ? (m.sender==='admin') : (m.senderId===currentUser.uid);
                    
                    let dateObj = (m.timestamp && m.timestamp.seconds) ? new Date(m.timestamp.seconds * 1000) : new Date();
                    const dateStr = dateObj.toLocaleDateString();
                    const displayDate = dateStr === new Date().toLocaleDateString() ? 'Today' : dateStr;

                    if (dateStr !== lastDate) {
                        const dateDiv = document.createElement('div');
                        dateDiv.className = "date-divider";
                        dateDiv.innerText = displayDate;
                        feed.appendChild(dateDiv);
                        lastDate = dateStr;
                    }

                    const safeText = escapeHtml(m.text || '').replace(/'/g, "\\'");
                    
                    const div = document.createElement('div');
                    div.className = `msg-row ${isMe ? 'sent' : 'received'} animate__animated animate__fadeInUp`;
                    
                    // --- TICK LOGIC ---
                    let tickHtml = '';
                    if(isMe) {
                        if(m.read) {
                            // Blue double ticks
                            tickHtml = '<i class="fas fa-check-double tick-icon tick-read"></i>';
                        } else {
                            // Single white tick (sent)
                            tickHtml = '<i class="fas fa-check tick-icon tick-sent"></i>';
                        }
                    }

                    // --- QUOTE RENDER ---
                    let quoteHtml = '';
                    if(m.quotedText) {
                        quoteHtml = `
                            <div style="background:rgba(0,0,0,0.2); border-left:2px solid var(--text-muted); padding:4px 8px; margin-bottom:5px; border-radius:4px; font-size:0.75rem; opacity:0.8;">
                                ${escapeHtml(m.quotedText)}
                            </div>
                        `;
                    }

                    div.innerHTML = `
                        <div class="msg-content">
                            <div class="msg-bubble ${m.read ? '' : ''}" 
                                 id="bubble-${m.id}"
                                 oncontextmenu="window.openMsgMenu(event, '${m.id}', '${safeText}', ${isMe})">
                                ${quoteHtml}
                                ${m.image ? `<img src="${m.image}" style="max-width:100%; border-radius:8px; margin-bottom:5px;">` : ''}
                                <div>${(m.text || '').replace(/\n/g, '<br>')}</div>
                            </div>
                            <div class="msg-meta">
                                ${dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                ${tickHtml}
                            </div>
                        </div>
                    `;
                    feed.appendChild(div);
                });
                // Auto-scroll to bottom to show latest message
                setTimeout(() => feed.scrollTop = feed.scrollHeight, 100);
            });
        };

        function escapeHtml(text) {
            if(!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        window.closeChat = () => { document.body.classList.remove('chat-active'); activeId = null; if(msgUnsub) msgUnsub(); };

        // --- MSG CONTEXT MENU ---
        window.openMsgMenu = (e, id, text, isMe) => {
            e.preventDefault();
            ctxMsgId = id; ctxMsgText = text;
            
            document.querySelectorAll('.msg-selected').forEach(el => el.classList.remove('msg-selected'));
            const bubble = document.getElementById(`bubble-${id}`);
            if(bubble) bubble.classList.add('msg-selected');

            const menu = document.getElementById('msg-ctx-menu');
            menu.style.display = 'flex';
            
            let x = e.clientX, y = e.clientY;
            if (x + 180 > window.innerWidth) x = window.innerWidth - 190;
            if (y + 100 > window.innerHeight) y = window.innerHeight - 110;
            menu.style.top = `${y}px`; menu.style.left = `${x}px`;
        };

        window.replyMsgAction = () => {
            if(ctxMsgText) {
                replyingTo = ctxMsgText;
                document.getElementById('quote-text').innerText = ctxMsgText;
                document.getElementById('reply-quote').style.display = 'block';
                document.getElementById('msg-input').focus();
            }
            document.getElementById('msg-ctx-menu').style.display = 'none';
        };

        window.cancelReply = () => {
            replyingTo = null;
            document.getElementById('reply-quote').style.display = 'none';
        };

        window.copyMsgAction = () => {
            if(ctxMsgText) {
                navigator.clipboard.writeText(ctxMsgText);
                Toastify({text: "Copied", style:{background:"var(--bg-card)"}}).showToast();
            }
            document.getElementById('msg-ctx-menu').style.display = 'none';
        };

        window.deleteMsgAction = async () => {
            if(ctxMsgId && confirm("Delete message?")) {
                const ref = activeType === 'ticket' ? doc(db, `support_tickets/${activeId}/messages`, ctxMsgId) : doc(db, "messages", ctxMsgId);
                try { await deleteDoc(ref); } catch(e){ console.error(e); }
            }
            document.getElementById('msg-ctx-menu').style.display = 'none';
        };

        // --- FEATURES ---
        window.toggleChatSearch = () => {
            const bar = document.getElementById('chat-search-bar');
            bar.style.display = bar.style.display === 'block' ? 'none' : 'block';
            if(bar.style.display === 'block') document.getElementById('chat-search-input').focus();
        };

        window.filterChatMessages = () => {
            const term = document.getElementById('chat-search-input').value.toLowerCase();
            const groups = document.querySelectorAll('.msg-bubble');
            groups.forEach(g => {
                const text = g.innerText.toLowerCase();
                if(term && text.includes(term)) {
                    g.style.border = '2px solid var(--gold-base)';
                    g.scrollIntoView({behavior: "smooth", block: "center"});
                } else {
                    g.style.border = 'none';
                    if(g.closest('.msg-row.received')) g.style.border = '1px solid var(--border-color)';
                }
            });
        };

        window.triggerAI = async () => {
            if(!activeId) return;
            const modal = document.getElementById('ai-modal');
            const steps = document.getElementById('ai-steps');
            const input = document.getElementById('msg-input');
            modal.style.display = 'block'; steps.innerHTML = ''; 

            const addStep = (icon, text, color) => {
                return new Promise(resolve => {
                    const div = document.createElement('div'); div.className = 'ai-step';
                    div.innerHTML = `<i class="${icon}" style="color:${color}; width:20px;"></i> ${text}`;
                    steps.appendChild(div); setTimeout(resolve, 800); 
                });
            };

            await addStep('fas fa-fingerprint', `Authenticating Admin...`, '#8b5cf6');
            await addStep('fas fa-microscope', `Analyzing context...`, '#3b82f6');
            
            let response = "";
            const msg = lastUserMessageText.toLowerCase();
            const name = activeUser ? activeUser.title.split(' ')[0] : "User";

            if(msg.includes("pay") || msg.includes("deposit")) {
                response = `Hello ${name}, I see you have a payment query. To trace this quickly, please provide the MPESA transaction code.`;
            } else {
                response = `Hello ${name}, thank you for reaching out. I'm reviewing your message now.`;
            }

            await addStep('fas fa-brain', `Generating Response...`, '#d97706');

            setTimeout(() => {
                modal.style.display = 'none';
                input.value = response;
                input.focus();
                input.style.height = input.scrollHeight + 'px';
            }, 600);
        };

        window.sendMessage = async () => {
            const inp = document.getElementById('msg-input');
            const txt = inp.value.trim();
            if(!txt || !activeId) return;
            inp.value = ''; 
            inp.style.height = '46px'; 

            const payload = { 
                text: txt, 
                timestamp: serverTimestamp(),
                read: false,
                quotedText: replyingTo || null
            };

            // Reset Reply
            cancelReply();

            try {
                if(activeType === 'ticket') {
                    payload.sender = 'admin';
                    await addDoc(collection(db, "support_tickets", activeId, "messages"), payload);
                    await updateDoc(doc(db, "support_tickets", activeId), { lastUpdated: serverTimestamp(), isReadByUser: false });
                } else {
                    payload.senderId = currentUser.uid;
                    payload.chatId = activeId;
                    await addDoc(collection(db, "messages"), payload);
                    await updateDoc(doc(db, "chats", activeId), {
                        lastMessage: txt, lastUpdated: serverTimestamp(), lastSenderId: currentUser.uid, isRead: false
                    });
                }
            } catch(e) { console.error("Send Error:", e); }
        };

        // --- PWA LOGIC ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); deferredPrompt = e;
            document.getElementById('pwa-install-popup').style.display = 'block';
        });
        window.installPWA = async () => {
            if (deferredPrompt) { deferredPrompt.prompt(); document.getElementById('pwa-install-popup').style.display = 'none'; deferredPrompt = null; }
        };
        window.dismissPWA = () => { document.getElementById('pwa-install-popup').style.display = 'none'; };
        if ("serviceWorker" in navigator) { navigator.serviceWorker.register("./service-worker.js").catch(()=>{}); }

        // Expose functions
        window.loadChat = openChat; window.openChat = openChat; window.closeChat = closeChat;
        window.sendMessage = sendMessage; window.triggerAI = triggerAI;
        window.toggleChatSearch = toggleChatSearch; window.filterChatMessages = filterChatMessages;
        window.openMsgMenu = openMsgMenu; window.copyMsgAction = copyMsgAction; window.deleteMsgAction = deleteMsgAction;
        window.replyMsgAction = replyMsgAction; window.cancelReply = cancelReply;
        window.openNewChatModal = openNewChatModal; window.closeNewChatModal = closeNewChatModal; window.filterNewChatUsers = filterNewChatUsers;
        window.startDirectMessage = startDirectMessage; window.openThreadMenu = openThreadMenu; window.toggleThreadPin = toggleThreadPin;
        window.resolveOrArchive = resolveOrArchive; window.deleteThread = deleteThread;

    </script>
</body>
</html>
