<!DOCTYPE html>
<html lang="en" style="background-color: #0F172A;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Verify Email | EastLink Recruiters</title>
    
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/svg+xml" href="./assets/images/favicon.svg">
    <meta name="theme-color" content="#0F172A">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons & Toast -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <style>
        /* =========================================
           THEME VARIABLES
           ========================================= */
        :root {
            --primary: #D97706;
            --gold-gradient: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            --success: #10B981;
            
            --bg-body: #0F172A; 
            --bg-glass: rgba(30, 41, 59, 0.7); 
            
            --text: #F8FAFC;
            --text-muted: #94A3B8;
            
            --border-color: rgba(255, 255, 255, 0.08);
            --radius: 24px;
            --transition: cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            background-image: url('./assets/images/background.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex; 
            align-items: center; 
            justify-content: center;
            padding: 20px;
        }

        /* Ambient Background */
        body::before {
            content: ''; position: fixed; inset: 0;
            background: radial-gradient(circle at center, rgba(217, 119, 6, 0.05) 0%, #0F172A 70%);
            z-index: -5; pointer-events: none;
        }

        h1, h2, h3, .brand-font { font-family: 'Cinzel', serif; }
        a { text-decoration: none; color: inherit; transition: var(--transition) 0.3s; }

        .verify-card {
            background: var(--bg-glass);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--border-color);
            border-top: 1px solid rgba(255,255,255,0.15);
            border-radius: var(--radius); 
            padding: 50px 40px; 
            width: 100%; max-width: 480px;
            text-align: center;
            box-shadow: 0 30px 60px -15px rgba(0,0,0,0.6);
            position: relative;
            animation: fadeInUp 0.8s ease-out;
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        /* Icon Pulse Animation */
        .icon-wrapper { position: relative; width: 100px; height: 100px; margin: 0 auto 35px; }
        
        .icon-circle {
            position: absolute; inset: 0; background: rgba(217, 119, 6, 0.1);
            border-radius: 50%; border: 1px solid rgba(217, 119, 6, 0.3);
            display: flex; align-items: center; justify-content: center; z-index: 2;
            box-shadow: 0 0 20px rgba(217, 119, 6, 0.2);
        }
        .icon-circle i { font-size: 2.5rem; color: var(--primary); }
        
        .pulse {
            position: absolute; inset: 0; border-radius: 50%; border: 1px solid var(--primary);
            opacity: 0; z-index: 1; animation: pulseWave 2.5s infinite;
        }
        .pulse:nth-child(2) { animation-delay: 0.8s; }
        @keyframes pulseWave { 
            0% { transform: scale(1); opacity: 0.6; } 
            100% { transform: scale(1.8); opacity: 0; } 
        }

        h1 { font-size: 1.8rem; margin-bottom: 10px; color: var(--text); font-weight: 700; }
        
        .email-display {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            padding: 8px 16px; border-radius: 50px;
            display: inline-block; margin: 10px 0 25px;
            color: var(--primary); font-weight: 600; font-size: 0.95rem;
        }

        .info-text { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 30px; line-height: 1.6; }
        
        .spam-warning {
            background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2);
            padding: 12px; border-radius: 12px; font-size: 0.85rem; color: #FCA5A5;
            margin-bottom: 30px; display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        /* Action Buttons */
        .btn-main {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            width: 100%; padding: 16px; border-radius: 50px; border: none;
            background: var(--gold-gradient); color: #000; font-weight: 700; font-size: 1rem;
            cursor: pointer; transition: 0.3s; box-shadow: 0 5px 20px rgba(217, 119, 6, 0.3);
            text-decoration: none; margin-bottom: 25px;
        }
        .btn-main:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(217, 119, 6, 0.5); }

        .resend-box { font-size: 0.9rem; color: var(--text-muted); }
        .btn-link { 
            color: var(--text); font-weight: 600; cursor: pointer; text-decoration: underline; 
            transition: 0.3s; background: none; border: none; padding: 0; font-size: 0.9rem; 
            font-family: 'Inter', sans-serif;
        }
        .btn-link:hover { color: var(--primary); }
        .btn-link:disabled { color: var(--text-muted); opacity: 0.5; cursor: not-allowed; text-decoration: none; }

        .logout-link {
            display: block; margin-top: 30px; color: var(--text-muted); 
            font-size: 0.85rem; opacity: 0.7; transition:0.3s;
        }
        .logout-link:hover { opacity: 1; color: var(--primary); }

        /* Loader Overlay */
        .loader-overlay {
            position: fixed; inset: 0; background: var(--bg-body); z-index: 2000;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            transition: opacity 0.5s;
        }
    </style>
</head>
<body>

    <!-- PRELOADER -->
    <div class="loader-overlay" id="pageLoader">
        <div style="width: 50px; height: 50px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
    </div>
    <style>@keyframes spin { to { transform: rotate(360deg); } }</style>

    <div class="verify-card">
        
        <div class="icon-wrapper">
            <div class="pulse"></div>
            <div class="pulse"></div>
            <div class="icon-circle">
                <i class="fas fa-paper-plane"></i>
            </div>
        </div>

        <h1 class="brand-font">Verify Your Email</h1>
        
        <div id="emailContainer">
            <span class="email-display" id="userEmail">loading...</span>
        </div>

        <p class="info-text">
            We have sent a verification link to your email address.<br>
            Click the link to activate your account. <br>
            <strong>This page will auto-refresh once verified.</strong>
        </p>

        <div class="spam-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Check your <strong>Spam</strong> or <strong>Junk</strong> folder.</span>
        </div>

        <a href="#" id="inboxBtn" class="btn-main" target="_blank">
            <i class="fas fa-envelope-open-text"></i> <span id="inboxText">Open Email App</span>
        </a>

        <div class="resend-box">
            Didn't receive the email? <br>
            <button id="resendBtn" class="btn-link" onclick="resendVerification()">Resend Link</button>
            <span id="timer" style="display:none; color:var(--primary); font-weight:700; margin-left:5px;">60s</span>
        </div>
        
        <a href="#" onclick="handleLogout()" class="logout-link">
            <i class="fas fa-sign-out-alt"></i> Sign Out / Use Different Email
        </a>

    </div>

    <!-- TOASTIFY & FIREBASE -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <script type="module">
        import { auth } from './config.js';
        import { 
            onAuthStateChanged, 
            sendEmailVerification, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

        let currentUser = null;
        let checkInterval = null;

        // --- AUTH STATE LISTENER ---
        onAuthStateChanged(auth, (user) => {
            // Remove Loader
            const loader = document.getElementById('pageLoader');
            if(loader) { loader.style.opacity = '0'; setTimeout(() => loader.style.display = 'none', 500); }

            if (user) {
                currentUser = user;
                document.getElementById('userEmail').innerText = user.email;
                
                // If already verified
                if (user.emailVerified) {
                    handleSuccessRedirect();
                } else {
                    // Configure Smart Button based on email domain
                    configureInboxButton(user.email);
                    // Start Polling for verification status changes
                    startPolling();
                }
            } else {
                // No user found, redirect to login
                window.location.href = 'signin.html';
            }
        });

        // --- POLLING LOGIC ---
        function startPolling() {
            // Check every 3 seconds if the user verified their email
            checkInterval = setInterval(async () => {
                if (auth.currentUser) {
                    // Force reload user metadata to get the latest emailVerified status
                    await auth.currentUser.reload();
                    
                    if (auth.currentUser.emailVerified) {
                        clearInterval(checkInterval);
                        handleSuccessRedirect();
                    }
                }
            }, 3000);
        }

        function handleSuccessRedirect() {
            showToast("Email Verified Successfully!", "success");
            
            // Visual feedback update
            const card = document.querySelector('.verify-card');
            card.innerHTML = `
                <div style="padding:40px 0;">
                    <i class="fas fa-check-circle animate__animated animate__zoomIn" style="font-size:4rem; color:var(--success); margin-bottom:20px;"></i>
                    <h2 class="brand-font" style="margin-bottom:10px;">Verified!</h2>
                    <p style="color:var(--text-muted);">Redirecting to Sign In...</p>
                </div>
            `;
            
            // Wait 2 seconds then redirect
            setTimeout(() => {
                window.location.href = 'signin.html'; 
            }, 2000);
        }

        // --- SMART INBOX BUTTON LOGIC ---
        function configureInboxButton(email) {
            const btn = document.getElementById('inboxBtn');
            const txt = document.getElementById('inboxText');
            if (!email) return;

            const domain = email.split('@')[1]?.toLowerCase();

            // Direct Links to Search Query in specific Inbox providers
            if (domain.includes('gmail.com')) {
                // Opens Gmail searching for "EastLink" or "firebase"
                btn.href = "https://mail.google.com/mail/u/0/#search/verification";
                txt.innerText = "Open Gmail Inbox";
            } 
            else if (domain.includes('outlook.com') || domain.includes('hotmail.com')) {
                btn.href = "https://outlook.live.com/mail/0/inbox";
                txt.innerText = "Open Outlook";
            } 
            else if (domain.includes('yahoo.com')) {
                btn.href = "https://mail.yahoo.com";
                txt.innerText = "Open Yahoo Mail";
            } 
            else if (domain.includes('icloud.com')) {
                btn.href = "https://www.icloud.com/mail";
                txt.innerText = "Open iCloud Mail";
            }
            else {
                // Fallback to generic mailto (opens default system app)
                btn.href = "mailto:";
                txt.innerText = "Open Email App";
            }
        }

        // --- RESEND LOGIC (WITH COUNTDOWN) ---
        window.resendVerification = async () => {
            const btn = document.getElementById('resendBtn');
            const timerSpan = document.getElementById('timer');

            if (btn.disabled) return;

            try {
                if(currentUser) {
                    await sendEmailVerification(currentUser);
                    showToast("Verification link sent! Check your email.", "success");
                    
                    // Disable button and start timer to prevent spam
                    btn.disabled = true;
                    btn.style.textDecoration = 'none';
                    btn.innerText = "Resend available in";
                    timerSpan.style.display = "inline";
                    
                    let timeLeft = 60;
                    const timerId = setInterval(() => {
                        timeLeft--;
                        timerSpan.innerText = `${timeLeft}s`;
                        
                        if (timeLeft <= 0) {
                            clearInterval(timerId);
                            btn.disabled = false;
                            btn.style.textDecoration = 'underline';
                            btn.innerText = "Resend Link";
                            timerSpan.style.display = "none";
                        }
                    }, 1000);
                }
            } catch (error) {
                console.error(error);
                let msg = "Could not send email.";
                if(error.code === 'auth/too-many-requests') msg = "Too many requests. Please wait a moment.";
                showToast(msg, "error");
            }
        };

        window.handleLogout = async () => {
            if(checkInterval) clearInterval(checkInterval);
            await signOut(auth);
            window.location.href = 'signin.html';
        };

        function showToast(msg, type) {
            let bg = type === 'error' ? "linear-gradient(to right, #EF4444, #B91C1C)" : "linear-gradient(to right, #10B981, #059669)";
            Toastify({ 
                text: msg, 
                duration: 4000, 
                gravity: "top", 
                position: "center", 
                style: { 
                    background: bg, 
                    borderRadius:'12px', 
                    fontWeight:'600',
                    color: '#ffffff',
                    boxShadow: '0 4px 15px rgba(0,0,0,0.3)'
                } 
            }).showToast();
        }
    </script>
</body>
</html>
